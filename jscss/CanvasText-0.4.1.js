function CanvasText(){this.canvasId=null;this.canvas=null;this.context=null;this.bufferCanvas=null;this.bufferContext=null;this.cacheCanvas=[];this.cacheContext=[];this.savedClasses=[];this.fontFamily="Verdana";this.fontWeight="normal";this.fontSize="12px";this.fontColor="#000";this.fontStyle="normal";this.textAlign="start";this.textBaseline="alphabetic";this.lineHeight="16";this.textShadow=null;this.initTime=null;this.endTime=null;this.config=function(config){var property;if(typeof(config)!=="object"){alert("¡Invalid configuration!");return false}for(property in config){if(this[property]!==undefined){this[property]=config[property]}}};this.drawText=function(textInfo){this.initTime=new Date().getTime();if(this.canvas==null){if(!this.getCanvas()){alert("Incorrect canvas ID!");return false}}if(this.bufferCanvas==null){this.getBufferCanvas()}if(textInfo.cacheId!==undefined){textInfo.cacheId="ct"+textInfo.cacheId;if(this.getCache(textInfo.cacheId)){if(!textInfo.returnImage){this.context.drawImage(this.cacheCanvas[textInfo.cacheId],0,0)}else{if(textInfo.returnImage){return this.cacheCanvas[textInfo.cacheId]}}this.endTime=new Date().getTime();return false}}if(typeof(textInfo)!="object"){alert("Invalid text format!");return false}if(!this.isNumber(textInfo.x)||!this.isNumber(textInfo.y)){alert('You should specify a correct "x" & "y" axis value.');return false}this.bufferCanvas.width=this.bufferCanvas.width;this.bufferContext.fillStyle=this.fontColor;this.bufferContext.font=this.fontWeight+" "+this.fontSize+" "+this.fontFamily;this.drawStyledText(textInfo);if(textInfo.cacheId!=undefined){this.setCache(textInfo.cacheId)}this.endTime=new Date().getTime();if(!textInfo.returnImage){this.context.drawImage(this.bufferCanvas,0,0)}else{if(textInfo.returnImage){return this.bufferCanvas}}};this.drawStyledText=function(textInfo){var text=textInfo.text,x=textInfo.x,y=textInfo.y;var splittedText,xAux,textLines=[],boxWidth=textInfo.boxWidth;var proFont=[],properties,property,propertyName,propertyValue,atribute;var classDefinition,proColor,proText,proShadow;var i,j,k,n;var match=text.match(/<\s*br\s*\/>|<\s*class=["|']([^"|']+)["|']\s*\>([^>]+)<\s*\/class\s*\>|<\s*style=["|']([^"|']+)["|']\s*\>([^>]+)<\s*\/style\s*\>|[^<]+/g);var innerMatch=null;for(i=0;i<match.length;i++){this.bufferContext.save();proColor=this.fontColor;proFont.style=this.fontStyle;proFont.weight=this.fontWeight;proFont.size=this.fontSize;proFont.family=this.fontFamily;proShadow=this.textShadow;if(/<\s*style=/i.test(match[i])){innerMatch=match[i].match(/<\s*style=["|']([^"|']+)["|']\s*\>([^>]+)<\s*\/style\s*\>/);properties=innerMatch[1].split(";");for(j=0;j<properties.length;j++){property=properties[j].split(":");if(this.isEmpty(property[0])||this.isEmpty(property[1])){continue}propertyName=property[0];propertyValue=property[1];switch(propertyName){case"font":proFont=propertyValue;break;case"font-family":proFont.family=propertyValue;break;case"font-weight":proFont.weight=propertyValue;break;case"font-size":proFont.size=propertyValue;break;case"font-style":proFont.style=propertyValue;break;case"text-shadow":proShadow=this.trim(propertyValue);proShadow=proShadow.split(" ");if(proShadow.length!=4){proShadow=null}break;case"color":if(this.isHex(propertyValue)){proColor=propertyValue}break}}proText=innerMatch[2]}else{if(/<\s*class=/i.test(match[i])){innerMatch=match[i].match(/<\s*class=["|']([^"|']+)["|']\s*\>([^>]+)<\s*\/class\s*\>/);classDefinition=this.getClass(innerMatch[1]);for(atribute in classDefinition){switch(atribute){case"font":proFont=classDefinition[atribute];break;case"fontFamily":proFont.family=classDefinition[atribute];break;case"fontWeight":proFont.weight=classDefinition[atribute];break;case"fontSize":proFont.size=classDefinition[atribute];break;case"fontStyle":proFont.style=classDefinition[atribute];break;case"fontColor":if(this.isHex(classDefinition[atribute])){proColor=classDefinition[atribute]}break;case"textShadow":proShadow=this.trim(classDefinition[atribute]);proShadow=proShadow.split(" ");if(proShadow.length!=4){proShadow=null}break}}proText=innerMatch[2]}else{if(/<\s*br\s*\/>/i.test(match[i])){y+=parseInt(this.lineHeight,10)*1.5;x=textInfo.x;continue}else{proText=match[i]}}}this.bufferContext.textBaseline=this.textBaseline;this.bufferContext.textAlign=this.textAlign;if(proFont instanceof Array){this.bufferContext.font=proFont.style+" "+proFont.weight+" "+proFont.size+" "+proFont.family}else{this.bufferContext.font=proFont}this.bufferContext.font=proFont;this.bufferContext.fillStyle=proColor;if(proShadow!=null){this.bufferContext.shadowOffsetX=proShadow[0].replace("px","");this.bufferContext.shadowOffsetY=proShadow[1].replace("px","");this.bufferContext.shadowBlur=proShadow[2].replace("px","");this.bufferContext.shadowColor=proShadow[3].replace("px","")}textLines=[];proText=proText.replace(/\s*\n\s*/g," ");if(boxWidth!==undefined){if(this.checkLineBreak(proText,(boxWidth+textInfo.x),x)){splittedText=this.trim(proText).split(" ");if(splittedText.length==1){textLines.push({text:this.trim(proText)+" ",linebreak:true})}else{xAux=x;var line=0;textLines[line]={text:undefined,linebreak:false};for(k=0;k<splittedText.length;k++){splittedText[k]+=" ";if(!this.checkLineBreak(splittedText[k],(boxWidth+textInfo.x),xAux)){if(textLines[line].text==undefined){textLines[line].text=splittedText[k]}else{textLines[line].text+=splittedText[k]}xAux+=this.bufferContext.measureText(splittedText[k]).width}else{xAux=textInfo.x;if(textLines[line].text!==undefined){line++}textLines[line]={text:splittedText[k],linebreak:true};xAux+=this.bufferContext.measureText(splittedText[k]).width}}}}}if(textLines.length==0){textLines.push({text:this.trim(proText)+" ",linebreak:false})}for(n=0;n<textLines.length;n++){if(textLines[n].linebreak){y+=parseInt(this.lineHeight,10);x=textInfo.x}this.bufferContext.fillText(textLines[n].text,x,y);x+=this.bufferContext.measureText(textLines[n].text).width}this.bufferContext.restore()}};this.defineClass=function(id,definition){if(typeof(definition)!="object"){alert("¡Invalid class!");return false}if(this.isEmpty(id)){alert("You must specify a Class Name.");return false}this.savedClasses[id]=definition;return true};this.getClass=function(id){if(this.savedClasses[id]!==undefined){return this.savedClasses[id]}};this.getCanvas=function(){if(this.canvasId==null){alert("You must specify the canvas ID!");return false}this.canvas=document.getElementById(this.canvasId);this.context=this.canvas.getContext("2d");this.getBufferCanvas();return true};this.getBufferCanvas=function(){this.bufferCanvas=document.createElement("canvas");this.bufferCanvas.width=this.canvas.width;this.bufferCanvas.height=this.canvas.height;this.bufferContext=this.bufferCanvas.getContext("2d")};this.getCache=function(id){if(this.cacheCanvas[id]===undefined){return false}else{return true}};this.setCache=function(id){this.cacheCanvas[id]=document.createElement("canvas");this.cacheCanvas[id].width=this.bufferCanvas.width;this.cacheCanvas[id].height=this.bufferCanvas.height;this.cacheContext[id]=this.cacheCanvas[id].getContext("2d");this.cacheContext[id].drawImage(this.bufferCanvas,0,0)};this.checkLineBreak=function(text,boxWidth,x){return(this.bufferContext.measureText(text).width+x>boxWidth)};this.isHex=function(hex){return(/^(#[a-fA-F0-9]{3,6})$/i.test(hex))};this.isNumber=function(n){return !isNaN(parseFloat(n))&&isFinite(n)};this.isEmpty=function(str){str=str.replace(/^\s+|\s+$/,"");return str.length==0};this.trim=function(str){var ws,i;str=str.replace(/^\s\s*/,"");ws=/\s/;i=str.length;while(ws.test(str.charAt(--i))){continue}return str.slice(0,i+1)}};