<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<script src="ChemDoodleWeb-unpacked_2.js"></script>

<style type="text/css">
.circle{
	width: 30px;
	height: 30px;
	border-radius: 50%;
	margin:auto;
	background-color: #1E90FF;
	/*border: solid 1px;*/

	text-align:center;
	line-height:30px;
	font-size:10px;
}
button,label{font-size:90%; font-weight:bold; border-radius:5px; padding:3 5 3 5; margin:2px}
.da{color:#fff;background-color:#d9534f}
</style>

<div style="height:100%;width:100%;display:flex;justify-content:space-between;">

<div style="flex:0 0 40%;overflow:hide">
<figure><script>var Mol1=new ChemDoodle.TransformCanvas3D('Mol-1',500,400);
Mol1.specs.shapes_color='#fff';
Mol1.specs.backgroundColor='black';
Mol1.specs.compass_display=true;
Mol1.specs.set3DRepresentation('Ball and Stick');
Mol1.specs.projectionPerspective_3D=false;

//Mol1.specs.atoms_resolution_3D=15;
//Mol1.specs.bonds_resolution_3D=15;
//Mol1.specs.crystals_unitCellLineWidth=1.5;

Mol1.specs.proteins_ribbonCartoonize = true;
Mol1.handle = null;
Mol1.timeout = 15;
Mol1.specs.crystals_unitCellLineWidth = 1.5;
Mol1.specs.nucleics_residueColor = 'rainbow';
Mol1.specs.proteins_residueColor= 'rainbow';
Mol1.startAnimation = ChemDoodle._AnimatorCanvas.prototype.startAnimation;
Mol1.stopAnimation = ChemDoodle._AnimatorCanvas.prototype.stopAnimation;
Mol1.isRunning = ChemDoodle._AnimatorCanvas.prototype.isRunning;
Mol1.dblclick = ChemDoodle.RotatorCanvas.prototype.dblclick;

Mol1.nextFrame=function(delta){var matrix=[];
ChemDoodle.lib.mat4.identity(matrix);
var change=delta*Math.PI/15000;
ChemDoodle.lib.mat4.rotate(matrix,change,[1,0,0]);
ChemDoodle.lib.mat4.rotate(matrix,change,[0,1,0]);
ChemDoodle.lib.mat4.rotate(matrix,change,[0,0,1]);
ChemDoodle.lib.mat4.multiply(this.rotationMatrix, matrix)};

var Fmol='12\nALA\nN -0.522 0.930 0.997 N\nH 0.127 1.519 1.627 H\nC 0.000 0.000 -0.000 CA\nH -0.328 -1.023 0.264 HA\nC -0.596 0.393 -1.363 CB\nH -1.702 0.351 -1.355 1HB\nH -0.314 1.422 -1.660 2HB\nH -0.259 -0.283 -2.170 2HB\nC 1.510 0.000 0.000 C\nO 2.167 -1.048 0.001 O\nN 2.136 1.129 0.000 N+\nH 1.587 2.059 -0.001 H+\n'

Mol1.loadMolecule(ChemDoodle.readXYZ(Fmol));
Mol1.startAnimation();
Mol1.stopAnimation();
var resType = 'amino';
function setDisp1(obj){Mol1.specs["proteins_display"+obj.value]=obj.checked;Mol1.repaint()}
function setProj1(yesPers){Mol1.specs.projectionPerspective_3D=yesPers;Mol1.setupScene();Mol1.repaint()}
function setColor1(obj){Mol1.specs.proteins_residueColor=resType=obj.value;Mol1.repaint()}
function resColor1(obj){this.checked ? Mol1.specs.proteins_residueColor=resType : Mol1.specs.proteins_residueColor='none';Mol1.repaint()}
function setModel1(model){Mol1.specs.set3DRepresentation(model);Mol1.setupScene();Mol1.repaint()}
function setSpeed1(){Mol1.timeout=500-document.getElementById('spd1').value;Mol1.loadMolecule(ChemDoodle.readXYZ(Fmol));Mol1.startAnimation()}
</script><br><span class='meta'>
视图: <input type='radio' name='group2' onclick='setProj1(true)'>投影 <input type='radio' name='group2' onclick='setProj1(false)' checked=''>正交&nbsp;&nbsp;&nbsp;&nbsp;
速度: <input type='range' id='spd1' min='1' max='500' onchange='setSpeed1()'/><br>
模型: <input type='radio' name='model' onclick='setModel1(&#39;Ball and Stick&#39;)' checked=''>球棍 <input type='radio' name='model' onclick='setModel1(&#39;van der Waals Spheres&#39;)'>范德华球 <input type='radio' name='model' onclick='setModel1(&#39;Stick&#39;)'>棍状 <input type='radio' name='model' onclick='setModel1(&#39;Wireframe&#39;)'>线框 <input type='radio' name='model' onclick='setModel1(&#39;Line&#39;)'>线型&nbsp;&nbsp; <input type='checkbox' onclick='Mol1.specs.atoms_displayLabels_3D=this.checked;Mol1.repaint()'>名称<br>
左键: 转动&nbsp;&nbsp; 滚轮: 缩放&nbsp;&nbsp; 双击: 自动旋转开关&nbsp;&nbsp; Alt+左键: 移动<br>
着色: <input type="checkbox" onclick="Mol1.specs.macro_colorByChain=this.checked;Mol1.repaint()">按链 <input type="checkbox" onclick="resColor1(this)" checked="">按残基<br>
模式: <input type="checkbox" value="Ribbon" checked="" onclick="setDisp1(this)">飘带 <input type="checkbox" value="Backbone"  onclick="setDisp1(this)">骨架 <input type="checkbox" value="PipePlank" onclick="setDisp1(this)">管板 <input type="checkbox" checked="" onclick="Mol1.specs.proteins_ribbonCartoonize=this.checked;Mol1.repaint()">卡通<br>
颜色: <input type="radio" value="amino" name="radio2" onclick="setColor1(this)">氨基酸 <input type="radio" value="shapely" name="radio2" onclick="setColor1(this)">形状 <input type="radio" value="polarity" name="radio2" onclick="setColor1(this)">极性 <input type="radio" value="acidity" name="radio2" onclick="setColor1(this)">酸性 <input type="radio" value="rainbow" name="radio2" checked='' onclick="setColor1(this)">彩虹</span></figure>
	<div style='width:100%; height:90%; text-align:center'>
		<img id='img' style='max-width:40%; max-height:40%' src="./img/Alanine.png"><br>
		<span id='title'></span>
	</div>
</div>

<div style="height:100%;flex:0 0 15%;">
	Helix(φ, ψ)<br>
	<input type="radio" name="ssType" checked='true'>α(-57.8, -47)<br>
	<input type="radio" name="ssType">3<sub>10</sub>(-74, -4) <br>
	<input type="radio" name="ssType">π(-57.1, -69.7)<br>
	<input type="radio" name="ssType">PPI(-75, 160)<br>
	<input type="radio" name="ssType">PPII(-75, 150)<br>
	Sheet(φ, ψ)<br>
	<input type="radio" name="ssType">β(-139, 135)<br>
	<input type="radio" name="ssType">parallel(-119, 113)<br><br>
	<input type="radio" name="ssType">set(φ, ψ)<br>
	<input type="box" id="phipsi" value=' -49 -26'><br><br>

	<label class='da' for="molfile">Load PDB</label>
	<form><input type="file" class='mo' id="molfile" accept=".pdb" style="position:absolute;clip:rect(0 0 0 0);"></form>

	<textarea id='seq' style="height:50%"></textarea>
	<button class='da' onclick='genPDB()'>Generate Pepetide</button><br>
	<button class='da' onclick='savePDB()'>Download PDB File</button>
</div>

<div id='right' style="height:100%;flex:1;overflow:scroll">
	<table id="AA" border="1" style='text-align:center'>
	<thead><tr>
		<th onclick="sortTable(this.cellIndex)">单字符</th>
		<th onclick="sortTable(this.cellIndex)">三字符</th>
		<th onclick="sortTable(this.cellIndex)">英文名</th>
		<th onclick="sortTable(this.cellIndex)">中文名</th>
		<th onclick="sortTable(this.cellIndex)">pI </th>
		<th onclick="sortTable(this.cellIndex)">pK1</th>
		<th onclick="sortTable(this.cellIndex)">pK2</th>
		<th onclick="sortTable(this.cellIndex)">pKa</th>
	</tr></thead>
	<tbody id='tabBody'> </tbody>
	</table>
</div>

</div>

<script>
var d2r=Math.atan2(1,1)/45, r2d=1/d2r

var $=function(id){return document.getElementById(id)}
function trim(s){return s.replace(/^(\s|\u00A0)+/,'').replace(/(\s|\u00A0)+$/,'')}
function norm(s){return s.replace(/^(\s|\u00A0)*\n*/,'').replace(/(\s|\u00A0)*\n*$/,'').replace(/(\s|\u00A0)+[\n|$]/g,'\n')}
function normtrim(s){return norm(trim(s))}

function printf(){
	var map = {
		s: function(str, fmt) { fmt*=1;
			var m=Array(Math.max(Math.abs(fmt)-str.length+1,0)).join(' ');
			return fmt>0 ? m+str : str+m},
		f: function(str, fmt) { fmt=fmt.split('.'); str=parseFloat(str).toFixed(fmt[1]);
			var m=Array(Math.max(Math.abs(fmt[0])-str.length+1, 0)).join(' ')
			return fmt[0]>0 ? m+str : str+m
		}
	}
	var args = Array.prototype.slice.call(arguments).slice(), fmt, type
	return args.shift().toString().replace(/%(-*\d*\.*\d*)([sf])/g, function(_, fmt, type){
		if(!args.length) throw new Error('Too few elements')
		return map[type](args.shift(), fmt);
	});
}

function objAA() {
	this.en    = ''
	this.cn    = ''
	this.let1  = ''
	this.mass  = 0
	this.pI    = 0
	this.pK1   = 0
	this.pK2   = 0
	this.pKa   = 0
	this.pH    = 0
	this.vol   = 0
	this.chain = ''
	this.polar = 0
	this.aromatic    =''
	this.hydrophobic =''
	this.small       =''
	this.tiny        =''

	this.xyz=''
	this.s=[]
	this.t=[]
	this.x=[]
	this.y=[]
	this.z=[]
	this.N=0; this.CA=0
	this.H=0; this.NX=0
	this.C=0; this.HX=0
	this.O=0;
}

var i, j, txt, str, arr, id, AA=[], Nclick=0, pdbHeader, pdbConect,
	RotMat=[[0,0,0,0], [0,1,0,0], [0,0,1,0], [0,0,0,1]]

   //Abbrev   Short                          mass(Da)  pI  pK1(α-COOH) pK2(α-+NH3) Side chain    Hydrophobic pKa   Polar  pH      Small   Tiny    Aromatic/Aliphatic  van der Waalsvolume (Å3)
txt= 'ALA A 丙氨酸   Alanine                 89.09404  6.01 2.35 9.87  -CH3                  Yes    -        No     -                Yes    Yes    Aliphatic    67     '
	+'ARG R 精氨酸   Arginine               174.20274 10.76 1.82 8.99  -(CH2)3NH-C(NH)NH2    No     12.3     Yes    stronglybasic    No     No     -            148    '
	+'ASN N 天冬酰胺 Asparagine             132.11904  5.41 2.14 8.72  -CH2CONH2             No     -        Yes    -                Yes    No     -            96    '
	+'ASP D 天冬氨酸_负电 Aspartate_AsparticAcid 133.10384  2.85 1.99 9.90  -CH2COOH              No      3.67    Yes    acidic           Yes    No     -            91    '
	+'ASH D 天冬氨酸_中性 Aspartate_AsparticAcid 133.10384  2.85 1.99 9.90  -CH2COOH              No      3.67    Yes    acidic           Yes    No     -            91    '
	+'CYS C 半胱氨酸_中性 Cysteine               121.15404  5.05 1.92 0.70  -CH2SH                Yes     8.55    No     acidic           Yes    Yes    -            86    '
	+'CYM C 半胱氨酸_负电 Cysteine               121.15404  5.05 1.92 0.70  -CH2SH                Yes     8.55    No     acidic           Yes    Yes    -            86    '
	+'CYX C 半胱氨酸_二硫键 Cysteine               121.15404  5.05 1.92 0.70  -CH2SH                Yes     8.55    No     acidic           Yes    Yes    -            86    '
	+'GLU E 谷氨酸_负电   Glutamate_GlutamicAcid 147.13074  3.15 2.10 9.47  -CH2CH2COOH           No      4.25    Yes    acidic           No     No     -            109    '
	+'GLH E 谷氨酸_中性   Glutamate_GlutamicAcid 147.13074  3.15 2.10 9.47  -CH2CH2COOH           No      4.25    Yes    acidic           No     No     -            109    '
	+'GLN Q 谷氨酰胺 Glutamine              146.14594  5.65 2.17 9.13  -CH2CH2CONH2          No     -        Yes    -                No     No     -            114    '
	+'GLY G 甘氨酸   Glycine                 75.06714  6.06 2.35 9.78  -H                    Yes    -        No     -                Yes    Yes    -            48    '
	+'HID H 组氨酸_Nδ质子化   Histidine              155.15634  7.60 1.80 9.33  -CH2-C3H3N2           No      6.54    Yes    weakbasic        No     No     Aromatic     118    '
	+'HIE H 组氨酸_Nε质子化   Histidine              155.15634  7.60 1.80 9.33  -CH2-C3H3N2           No      6.54    Yes    weakbasic        No     No     Aromatic     118    '
	+'HIP H 组氨酸_正电   Histidine              155.15634  7.60 1.80 9.33  -CH2-C3H3N2           No      6.54    Yes    weakbasic        No     No     Aromatic     118    '
	+'ILE I 异亮氨酸 Isoleucine             131.17464  6.05 2.32 9.76  -CH(CH3)CH2CH3        Yes    -        No     -                No     No     Aliphatic    124    '
	+'LEU L 亮氨酸   Leucine                131.17464  6.01 2.33 9.74  -CH2CH(CH3)2          Yes    -        No     -                No     No     Aliphatic    124    '
	+'LYS K 赖氨酸_正电   Lysine                 146.18934  9.60 2.16 9.06  -(CH2)4NH2            No     10.40    Yes    basic            No     No     -            135    '
	+'LYN K 赖氨酸_中性   Lysine                 146.18934  9.60 2.16 9.06  -(CH2)4NH2            No     10.40    Yes    basic            No     No     -            135    '
	+'MET M 蛋氨酸   Methionine             149.20784  5.74 2.13 9.28  -CH2CH2SCH3           Yes    -        No     -                No     No     Aliphatic    124    '
	+'PHE F 苯丙氨酸 Phenylalanine          165.19184  5.49 2.20 9.31  -CH2C6H5              Yes    -        No     -                No     No     Aromatic     135    '
	+'PRO P 脯氨酸   Proline                115.13194  6.30 1.95 0.64  -CH2CH2CH2-           Yes    -        No     -                Yes    No     -            90    '
	+'SER S 丝氨酸   Serine                 105.09344  5.68 2.19 9.21  -CH2OH                No     -        Yes    -                Yes    Yes    -            73    '
	+'THR T 苏氨酸   Threonine              119.12034  5.60 2.09 9.10  -CH(OH)CH3            No     -        Yes    -                Yes    No     -            93    '
	+'TRP W 色氨酸   Tryptophan             204.22844  5.89 2.46 9.41  -CH2C8H6N             Yes    -        No     -                No     No     Aromatic     163    '
	+'TYR Y 酪氨酸   Tyrosine               181.19124  5.64 2.20 9.21  -CH2-C6H4OH           No      9.84    Yes    weakacidic       No     No     Aromatic     141    '
	+'VAL V 缬氨酸   Valine                 117.14784  6.00 2.39 9.74  -CH(CH3)2             Yes    -        No     -                Yes    No     Aliphatic    105'

txt=txt.split(/\s+/)
for(i=0; i<txt.length; i+=17) {
	id=txt[i]
	AA[id]=new objAA()
	AA[id].let1       =txt[i+ 1]
	AA[id].cn         =txt[i+ 2]
	AA[id].en         =txt[i+ 3]
	AA[id].mass       =txt[i+ 4]
	AA[id].pI         =txt[i+ 5]
	AA[id].pK1        =txt[i+ 6]
	AA[id].pK2        =txt[i+ 7]
	AA[id].chain      =txt[i+ 8]
	AA[id].hydrophobic=txt[i+ 9]
	AA[id].pKa        =txt[i+10]
	AA[id].polar      =txt[i+11]
	AA[id].pH         =txt[i+12]
	AA[id].small      =txt[i+13]
	AA[id].tiny       =txt[i+14]
	AA[id].aromatic   =txt[i+15]
	AA[id].vol        =txt[i+16]
	AA[id].atom=0
	AA[id].s=[]
	AA[id].t=[]
	AA[id].x=[]
	AA[id].y=[]
	AA[id].z=[]
	AA[id].N=0; AA[id].CA=0
	AA[id].H=0; AA[id].NX=0
	AA[id].C=0; AA[id].HX=0
	AA[id].O=0;
}

AA['ALA'].xyz='12\nALA\nN -0.522 0.930 0.997 N\nH 0.127 1.519 1.627 H\nC 0.000 0.000 -0.000 CA\nH -0.328 -1.023 0.264 HA\nC -0.596 0.393 -1.363 CB\nH -1.702 0.351 -1.355 1HB\nH -0.314 1.422 -1.660 2HB\nH -0.259 -0.283 -2.170 3HB\nC 1.510 0.000 0.000 C\nO 2.167 -1.048 0.001 O\nN 2.136 1.129 0.000 N+\nH 1.587 2.059 -0.001 H+\n'
AA['ARG'].xyz='26\nARG\nN -0.522 0.930 0.998 N\nH 0.096 1.488 1.597 H\nC 0.000 0.000 0.000 CA\nH -0.335 -1.019 0.274 HA\nC -0.567 0.391 -1.394 CB\nH -0.142 1.373 -1.689 1HB\nH -1.656 0.580 -1.304 2HB\nC -0.337 -0.650 -2.526 CG\nH -0.802 -1.614 -2.233 1HG\nH 0.746 -0.862 -2.633 2HG\nC -0.896 -0.170 -3.875 CD\nH -0.403 0.786 -4.158 1HD\nH -1.979 0.054 -3.769 2HD\nN -0.666 -1.216 -4.915 NE\nH -0.205 -2.101 -4.680 HE\nC -1.019 -1.120 -6.193 CZ\nN -1.616 -0.079 -6.701 NH1\nH -1.791 0.671 -6.028 1HH1\nH -1.856 -0.083 -7.694 2HH1\nN -0.759 -2.117 -6.980 NH2\nH -0.291 -2.924 -6.564 1HH2\nH -1.040 -2.025 -7.957 2HH2\nC 1.510 -0.000 0.000 C\nO 2.162 -1.042 0.000 O\nN 2.136 1.128 0.000 N+\nH 1.615 2.012 0.001 H+\n'
AA['ASP'].xyz='14\nASP\nN -0.524 0.929 0.997 N\nH 0.126 1.518 1.628 H\nC 0.000 0.000 -0.000 CA\nH -0.328 -1.021 0.273 HA\nC -0.556 0.342 -1.411 CB\nH -0.248 1.363 -1.701 1HB\nH -1.658 0.353 -1.404 2HB\nC -0.132 -0.612 -2.537 CG\nO -0.032 -1.833 -2.295 OD1\nO 0.145 -0.131 -3.655 OD2\nC 1.510 0.000 0.000 C\nO 2.167 -1.053 -0.000 O\nN 2.135 1.128 -0.000 N+\nH 1.587 2.058 0.000 H+\n'
AA['ASH'].xyz='15\nASH\nN -0.524 0.929 0.997 N\nH 0.126 1.518 1.628 H\nC 0.000 0.000 -0.000 CA\nH -0.328 -1.021 0.273 HA\nC -0.556 0.342 -1.411 CB\nH -0.248 1.363 -1.701 1HB\nH -1.658 0.353 -1.404 2HB\nC -0.132 -0.612 -2.537 CG\nO -0.032 -1.833 -2.295 OD1\nO 0.145 -0.131 -3.655 OD2\nH 1.097 -0.107 -3.766 HD2\nC 1.510 0.000 0.000 C\nO 2.167 -1.053 -0.000 O\nN 2.135 1.128 -0.000 N+\nH 1.587 2.058 0.000 H+\n'
AA['ASN'].xyz='16\nASN\nN -0.522 0.930 0.997 N\nH 0.128 1.518 1.628 H\nC 0.000 0.000 -0.000 CA\nH -0.327 -1.022 0.268 HA\nC -0.551 0.382 -1.404 CB\nH -0.145 -0.299 -2.176 1HB\nH -0.168 1.380 -1.693 2HB\nC -2.074 0.432 -1.562 CG\nO -2.696 1.483 -1.546 OD1\nN -2.731 -0.689 -1.695 ND2\nH -3.744 -0.557 -1.639 1HD2\nH -2.194 -1.552 -1.615 2HD2\nC 1.511 0.000 -0.000 C\nO 2.163 -1.043 -0.000 O\nN 2.136 1.128 0.000 N+\nH 1.588 2.059 -0.000 H+\n'
AA['CYS'].xyz='13\nCYS\nN -0.523 0.930 0.997 N\nH 0.128 1.518 1.627 H\nC 0.000 0.000 -0.000 CA\nH -0.328 -1.020 0.271 HA\nC -0.589 0.373 -1.374 CB\nH -0.252 1.378 -1.702 1HB\nH -1.692 0.418 -1.338 2HB\nS -0.124 -0.849 -2.622 SG\nH 0.790 -0.105 -3.241 HG\nC 1.510 -0.000 0.000 C\nO 2.168 -1.051 -0.001 O\nN 2.136 1.128 -0.000 N+\nH 1.588 2.059 0.000 H+\n'
AA['CYM'].xyz='12\nCYM\nN -0.523 0.930 0.997 N\nH 0.128 1.518 1.627 H\nC 0.000 0.000 -0.000 CA\nH -0.328 -1.020 0.271 HA\nC -0.589 0.373 -1.374 CB\nH -0.252 1.378 -1.702 1HB\nH -1.692 0.418 -1.338 2HB\nS -0.124 -0.849 -2.622 SG\nC 1.510 -0.000 0.000 C\nO 2.168 -1.051 -0.001 O\nN 2.136 1.128 -0.000 N+\nH 1.588 2.059 0.000 H+\n'
AA['CYX'].xyz='12\nCYX\nN -0.523 0.930 0.997 N\nH 0.128 1.518 1.627 H\nC 0.000 0.000 -0.000 CA\nH -0.328 -1.020 0.271 HA\nC -0.589 0.373 -1.374 CB\nH -0.252 1.378 -1.702 1HB\nH -1.692 0.418 -1.338 2HB\nS -0.124 -0.849 -2.622 SG\nC 1.510 -0.000 0.000 C\nO 2.168 -1.051 -0.001 O\nN 2.136 1.128 -0.000 N+\nH 1.588 2.059 0.000 H+\n'
AA['GLU'].xyz='17\nGLU\nN -0.523 0.930 0.997 N\nH 0.127 1.518 1.627 H\nC 0.000 0.000 -0.000 CA\nH -0.340 -1.020 0.255 HA\nC -0.544 0.379 -1.407 CB\nH -0.241 1.416 -1.659 1HB\nH -1.650 0.415 -1.388 2HB\nC -0.108 -0.561 -2.578 CG\nH -0.433 -1.599 -2.398 1HG\nH 0.990 -0.606 -2.668 2HG\nC -0.553 -0.214 -3.986 CD\nO -1.268 0.784 -4.204 OE1\nO -0.154 -0.967 -4.899 OE2\nC 1.510 0.000 -0.000 C\nO 2.167 -1.051 0.001 O\nN 2.135 1.128 0.000 N+\nH 1.587 2.059 0.000 H+\n'
AA['GLH'].xyz='18\nGLH\nN -0.523 0.930 0.997 N\nH 0.127 1.518 1.627 H\nC 0.000 0.000 -0.000 CA\nH -0.340 -1.020 0.255 HA\nC -0.544 0.379 -1.407 CB\nH -0.241 1.416 -1.659 1HB\nH -1.650 0.415 -1.388 2HB\nC -0.108 -0.561 -2.578 CG\nH -0.433 -1.599 -2.398 1HG\nH 0.990 -0.606 -2.668 2HG\nC -0.553 -0.214 -3.986 CD\nO -1.268 0.784 -4.204 OE1\nO -0.154 -0.967 -4.899 OE2\nH 0.801 -0.977 -4.909 HE2\nC 1.510 0.000 -0.000 C\nO 2.167 -1.051 0.001 O\nN 2.135 1.128 0.000 N+\nH 1.587 2.059 0.000 H+\n'
AA['GLN'].xyz='19\nGLN\nN -0.524 0.929 0.996 N\nH 0.054 1.452 1.557 H\nC 0.000 0.000 -0.000 CA\nH -0.335 -1.022 0.257 HA\nC -0.553 0.397 -1.387 CB\nH -0.243 1.440 -1.605 1HB\nH -1.659 0.427 -1.336 2HB\nC -0.135 -0.518 -2.585 CG\nH -0.449 -1.561 -2.394 1HG\nH 0.966 -0.573 -2.660 2HG\nC -0.596 -0.151 -4.001 CD\nO -0.258 -0.818 -4.967 OE1\nN -1.343 0.906 -4.193 NE2\nH -1.552 1.115 -5.170 1HE2\nH -1.533 1.458 -3.354 2HE2\nC 1.510 0.000 -0.000 C\nO 2.161 -1.043 -0.001 O\nN 2.136 1.128 0.000 N+\nH 1.649 1.957 0.000 H+\n'
AA['GLY'].xyz='9\nGLY\nN -0.523 0.930 0.997 N\nH 0.127 1.519 1.627 H\nC 0.000 0.000 -0.000 CA\nH -0.347 0.299 -0.944 1HA\nH -0.340 -1.023 0.250 2HA\nC 1.510 0.000 0.000 C\nO 2.164 -1.046 0.001 O\nN 2.135 1.129 0.000 N+\nH 1.586 2.059 -0.000 H+\n'
AA['HIE'].xyz='19\nHIE\nN -0.524 0.929 0.997 N\nH 0.126 1.518 1.627 H\nC 0.000 0.000 -0.000 CA\nH -0.316 -1.016 0.292 HA\nC -0.536 0.477 -1.360 CB\nH 0.292 0.734 -2.049 1HB\nH -1.141 1.404 -1.269 2HB\nC -1.390 -0.558 -2.031 CG\nN -0.939 -1.553 -2.896 ND1\nC -2.105 -2.165 -3.173 CE1\nH -2.079 -3.013 -3.844 1HE\nN -3.237 -1.679 -2.595 NE2\nH -4.208 -2.011 -2.687 2HE\nC -2.765 -0.630 -1.850 CD2\nH -3.338 0.044 -1.219 2HD\nC 1.510 -0.000 0.000 C\nO 2.167 -1.052 -0.001 O\nN 2.135 1.128 -0.000 N+\nH 1.586 2.059 0.001 H+\n'
AA['HID'].xyz='19\nHID\nN -0.524 0.929 0.997 N\nH 0.126 1.518 1.627 H\nC 0.000 0.000 -0.000 CA\nH -0.316 -1.016 0.292 HA\nC -0.536 0.477 -1.360 CB\nH 0.292 0.734 -2.049 1HB\nH -1.141 1.404 -1.269 2HB\nC -1.390 -0.558 -2.031 CG\nN -0.939 -1.553 -2.896 ND1\nH 0.014 -1.759 -3.228 1HD\nC -2.105 -2.165 -3.173 CE1\nH -2.079 -3.013 -3.844 1HE\nN -3.237 -1.679 -2.595 NE2\nC -2.765 -0.630 -1.850 CD2\nH -3.338 0.044 -1.219 2HD\nC 1.510 -0.000 0.000 C\nO 2.167 -1.052 -0.001 O\nN 2.135 1.128 -0.000 N+\nH 1.586 2.059 0.001 H+\n'
AA['HIP'].xyz='20\nHIP\nN -0.524 0.929 0.997 N\nH 0.126 1.518 1.627 H\nC 0.000 0.000 -0.000 CA\nH -0.316 -1.016 0.292 HA\nC -0.536 0.477 -1.360 CB\nH 0.292 0.734 -2.049 1HB\nH -1.141 1.404 -1.269 2HB\nC -1.390 -0.558 -2.031 CG\nN -0.939 -1.553 -2.896 ND1\nH 0.014 -1.759 -3.228 1HD\nC -2.105 -2.165 -3.173 CE1\nH -2.079 -3.013 -3.844 1HE\nN -3.237 -1.679 -2.595 NE2\nH -4.208 -2.011 -2.687 2HE\nC -2.765 -0.630 -1.850 CD2\nH -3.338 0.044 -1.219 2HD\nC 1.510 -0.000 0.000 C\nO 2.167 -1.052 -0.001 O\nN 2.135 1.128 -0.000 N+\nH 1.586 2.059 0.001 H+\n'
AA['ILE'].xyz='21\nILE\nN -0.523 0.930 0.996 N\nH 0.126 1.519 1.627 H\nC 0.000 0.000 0.000 CA\nH -0.314 -1.018 0.296 HA\nC -0.589 0.304 -1.437 CB\nH -0.200 1.300 -1.736 HB\nC -0.121 -0.725 -2.513 CG2\nH 0.976 -0.769 -2.625 1HG2\nH -0.470 -1.751 -2.287 2HG2\nH -0.490 -0.475 -3.524 3HG2\nC -2.147 0.394 -1.497 CG1\nH -2.514 1.032 -0.671 1HG1\nH -2.597 -0.599 -1.301 2HG1\nC -2.737 0.999 -2.789 CD\nH -2.337 2.011 -2.988 HD1\nH -2.531 0.379 -3.680 HD2\nH -3.837 1.094 -2.719 HD3\nC 1.509 -0.000 0.000 C\nO 2.166 -1.052 0.000 O\nN 2.135 1.129 0.000 N+\nH 1.587 2.059 -0.001 H+\n'
AA['LEU'].xyz='21\nLEU\nN -0.522 0.930 0.997 N\nH 0.095 1.488 1.596 H\nC 0.000 0.000 -0.000 CA\nH -0.310 -1.023 0.280 HA\nC -0.555 0.344 -1.411 CB\nH -0.119 -0.365 -2.142 1HB\nH -0.161 1.334 -1.716 2HB\nC -2.096 0.358 -1.607 CG\nH -2.511 1.201 -1.015 HG\nC -2.439 0.607 -3.083 CD1\nH -2.006 1.557 -3.451 1HD1\nH -2.063 -0.199 -3.741 2HD1\nH -3.530 0.675 -3.241 3HD1\nC -2.767 -0.941 -1.131 CD2\nH -2.347 -1.835 -1.625 1HD2\nH -2.644 -1.079 -0.040 2HD2\nH -3.857 -0.935 -1.317 3HD2\nC 1.510 0.000 0.000 C\nO 2.168 -1.051 0.000 O\nN 2.135 1.128 0.000 N+\nH 1.614 2.012 0.000 H+\n'
AA['LYS'].xyz='24\nLYS\nN -0.523 0.930 0.997 N\nH 0.128 1.518 1.627 H\nC 0.000 0.000 -0.000 CA\nH -0.332 -1.021 0.266 HA\nC -0.555 0.377 -1.400 CB\nH -0.245 1.411 -1.659 1HB\nH -1.663 0.414 -1.365 2HB\nC -0.118 -0.599 -2.520 CG\nH -0.454 -1.625 -2.271 1HG\nH 0.986 -0.655 -2.569 2HG\nC -0.593 -0.222 -3.926 CD\nH -0.251 0.803 -4.176 1HD\nH -1.700 -0.197 -3.953 2HD\nC -0.030 -1.229 -4.938 CE\nH -0.248 -2.272 -4.628 1HE\nH 1.077 -1.152 -4.986 2HE\nN -0.621 -0.975 -6.263 NZ\nH -0.742 0.034 -6.418 1HZ\nH -0.008 -1.307 -7.015 2HZ\nH -1.506 -1.461 -6.278 3HZ\nC 1.510 -0.000 -0.000 C\nO 2.167 -1.050 -0.000 O\nN 2.135 1.128 -0.000 N+\nH 1.587 2.059 -0.000 H+\n'
AA['LYN'].xyz='23\nLYN\nN -0.523 0.930 0.997 N\nH 0.128 1.518 1.627 H\nC 0.000 0.000 -0.000 CA\nH -0.332 -1.021 0.266 HA\nC -0.555 0.377 -1.400 CB\nH -0.245 1.411 -1.659 1HB\nH -1.663 0.414 -1.365 2HB\nC -0.118 -0.599 -2.520 CG\nH -0.454 -1.625 -2.271 1HG\nH 0.986 -0.655 -2.569 2HG\nC -0.593 -0.222 -3.926 CD\nH -0.251 0.803 -4.176 1HD\nH -1.700 -0.197 -3.953 2HD\nC -0.030 -1.229 -4.938 CE\nH -0.248 -2.272 -4.628 1HE\nH 1.077 -1.152 -4.986 2HE\nN -0.621 -0.975 -6.263 NZ\nH -0.742 0.034 -6.418 1HZ\nH -0.008 -1.307 -7.015 2HZ\nC 1.510 -0.000 -0.000 C\nO 2.167 -1.050 -0.000 O\nN 2.135 1.128 -0.000 N+\nH 1.587 2.059 -0.000 H+\n'
AA['MET'].xyz='19\nMET\nN -0.524 0.930 0.996 N\nH 0.126 1.518 1.627 H\nC 0.000 0.000 0.000 CA\nH -0.325 -1.023 0.267 HA\nC -0.555 0.365 -1.405 CB\nH -0.090 -0.293 -2.164 1HB\nH -0.233 1.389 -1.682 2HB\nC -2.086 0.265 -1.572 CG\nH -2.584 1.063 -0.990 1HG\nH -2.475 -0.697 -1.189 2HG\nS -2.523 0.433 -3.310 SD\nC -4.294 0.670 -3.118 CE\nH -4.747 -0.167 -2.556 1HE\nH -4.500 1.608 -2.572 2HE\nH -4.785 0.731 -4.104 3HE\nC 1.510 0.000 0.000 C\nO 2.167 -1.053 0.001 O\nN 2.136 1.128 0.000 N+\nH 1.588 2.059 -0.001 H+\n'
AA['PHE'].xyz='22\nPHE\nN -0.524 0.929 0.997 N\nH 0.125 1.517 1.627 H\nC 0.000 0.000 0.000 CA\nH -0.343 -1.023 0.248 HA\nC -0.503 0.400 -1.420 CB\nH -0.080 -0.298 -2.170 1HB\nH -0.069 1.380 -1.707 2HB\nC -2.026 0.456 -1.617 CG\nC -2.715 1.643 -1.342 CD1\nH -2.175 2.521 -1.011 1HD\nC -4.102 1.687 -1.437 CE1\nH -4.626 2.600 -1.193 1HE\nC -4.808 0.551 -1.823 CZ\nH -5.885 0.586 -1.891 HZ\nC -4.128 -0.632 -2.110 CE2\nH -4.677 -1.515 -2.404 2HE\nC -2.740 -0.680 -2.005 CD2\nH -2.221 -1.606 -2.208 2HD\nC 1.510 0.000 0.000 C\nO 2.178 -1.072 -0.000 O\nN 2.136 1.128 0.000 N+\nH 1.589 2.058 0.000 H+\n'
AA['PRO'].xyz='16\nPRO\nN -0.536 0.923 0.989 N\nC -1.169 2.103 0.442 CD\nH -2.254 2.015 0.543 1HD\nH -0.815 3.008 0.942 2HD\nC -0.748 2.053 -1.029 CG\nH -1.482 2.529 -1.684 1HG\nH 0.220 2.544 -1.147 2HG\nC -0.601 0.549 -1.303 CB\nH -1.590 0.111 -1.450 1HB\nH 0.017 0.336 -2.179 2HB\nC 0.000 0.000 0.000 CA\nH -0.351 -1.016 0.194 HA\nC 1.538 -0.000 0.000 C\nO 2.162 -1.061 0.000 O\nN 2.178 1.119 0.000 N+\nH 1.644 2.058 0.000 H+\n'
AA['SER'].xyz='13\nSER\nN -0.522 0.930 0.997 N\nH 0.127 1.518 1.628 H\nC 0.000 0.000 -0.000 CA\nH -0.320 -1.020 0.284 HA\nC -0.570 0.320 -1.405 CB\nH -1.676 0.348 -1.391 1HB\nH -0.314 -0.498 -2.106 2HB\nO -0.067 1.548 -1.942 OG\nH -0.360 2.256 -1.364 HG\nC 1.511 0.000 0.000 C\nO 2.163 -1.045 -0.000 O\nN 2.136 1.128 0.000 N+\nH 1.590 2.058 0.001 H+\n'
AA['THR'].xyz='16\nTHR\nN -0.524 0.929 0.996 N\nH 0.126 1.519 1.627 H\nC 0.000 0.000 -0.000 CA\nH -0.330 -1.020 0.268 HA\nC -0.554 0.349 -1.423 CB\nH -0.277 1.400 -1.657 HB\nC -0.074 -0.549 -2.583 CG2\nH -0.524 -0.256 -3.550 1HG2\nH 1.020 -0.497 -2.734 2HG2\nH -0.329 -1.612 -2.412 3HG2\nO -1.971 0.238 -1.448 OG1\nH -2.246 0.532 -2.321 1HG\nC 1.510 0.000 -0.000 C\nO 2.153 -1.031 0.001 O\nN 2.135 1.128 0.000 N+\nH 1.588 2.060 -0.000 H+\n'
AA['TRP'].xyz='26\nTRP\nN -0.523 0.929 0.997 N\nH 0.079 1.474 1.580 H\nC 0.000 0.000 -0.000 CA\nH -0.334 -1.025 0.249 HA\nC -0.525 0.411 -1.404 CB\nH -0.033 -0.194 -2.189 1HB\nH -0.226 1.453 -1.633 2HB\nC -2.039 0.265 -1.590 CG\nC -2.988 1.298 -1.449 CD1\nH -2.734 2.321 -1.202 1HD\nN -4.303 0.820 -1.604 NE1\nH -5.184 1.339 -1.514 1HE\nC -4.137 -0.537 -1.840 CE2\nC -5.116 -1.533 -2.052 CZ2\nH -6.164 -1.274 -2.058 2HZ\nC -4.701 -2.852 -2.255 CH2\nH -5.440 -3.619 -2.428 2HH\nC -3.342 -3.194 -2.239 CZ3\nH -3.049 -4.222 -2.395 3HZ\nC -2.357 -2.229 -2.025 CE3\nH -1.312 -2.504 -2.006 3HE\nC -2.763 -0.884 -1.832 CD2\nC 1.511 -0.000 0.000 C\nO 2.162 -1.043 -0.000 O\nN 2.136 1.128 0.000 N+\nH 1.628 1.990 0.001 H+\n'
AA['TYR'].xyz='23\nTYR\nN -0.523 0.930 0.997 N\nH 0.127 1.519 1.627 H\nC 0.000 0.000 -0.000 CA\nH -0.340 -1.023 0.250 HA\nC -0.480 0.389 -1.429 CB\nH -0.012 -0.283 -2.175 1HB\nH -0.075 1.389 -1.692 2HB\nC -1.993 0.369 -1.676 CG\nC -2.664 -0.840 -1.887 CD1\nH -2.122 -1.775 -1.882 1HD\nC -4.041 -0.846 -2.096 CE1\nH -4.562 -1.779 -2.253 1HE\nC -4.752 0.351 -2.097 CZ\nO -6.103 0.339 -2.300 OH\nH -6.423 1.243 -2.266 HH\nC -4.088 1.558 -1.890 CE2\nH -4.633 2.490 -1.885 2HE\nC -2.713 1.567 -1.681 CD2\nH -2.206 2.507 -1.510 2HD\nC 1.510 0.000 -0.000 C\nO 2.164 -1.046 0.001 O\nN 2.135 1.129 -0.000 N+\nH 1.586 2.059 -0.000 H+\n'
AA['VAL'].xyz='18\nVAL\nN -0.523 0.930 0.997 N\nH 0.128 1.519 1.628 H\nC 0.000 0.000 0.000 CA\nH -0.323 -1.023 0.264 HA\nC -0.562 0.374 -1.429 CB\nH -0.334 1.447 -1.600 HB\nC 0.041 -0.403 -2.632 CG1\nH -0.113 -1.495 -2.551 1HG1\nH -0.391 -0.081 -3.599 2HG1\nH 1.130 -0.236 -2.739 3HG1\nC -2.095 0.206 -1.563 CG2\nH -2.640 0.778 -0.789 1HG2\nH -2.466 0.581 -2.536 2HG2\nH -2.412 -0.850 -1.474 3HG2\nC 1.510 0.000 -0.000 C\nO 2.167 -1.049 0.000 O\nN 2.135 1.128 0.000 N+\nH 1.586 2.059 -0.001 H+\n'

txt='ALA ARG ASN ASP ASH CYS CYM CYX GLN GLU GLH GLY HID HIE HIP ILE LEU LYN LYS MET PHE PRO SER THR TRP TYR VAL'
txt=txt.split(/\s+/)
for(i=0; i<txt.length; i++) {
	id=txt[i]
	$('tabBody').innerHTML += "<tr>"+"<td>"+AA[id].let1+"</td><td><div class='circle' id='"
		+id+"' onclick='loadAA(this.id)'>"+id+"</div></td><td>"
		+AA[id].en.replace("_","<br>")+"</td><td>" +AA[id].cn.replace("_","<br>")+"</td><td>"
		+AA[id].pI+"</td><td>" +AA[id].pK1+"</td><td>"
		+AA[id].pK2+"</td><td>"+AA[id].pKa+"</td></tr>"

	str=AA[id].xyz.split(/\n/)
	AA[id].atom=str[0]
	str=str.slice(2)
	for(j=0; j<str.length; j++) {
		arr=str[j].split(/\s+/)
		AA[id].s[j]=arr[0]
		AA[id].t[j]=arr[4]
		AA[id].x[j]=parseFloat(arr[1])
		AA[id].y[j]=parseFloat(arr[2])
		AA[id].z[j]=parseFloat(arr[3])
		if(arr[4]=="N" ) AA[id].N=j; if(arr[4]=="CA") AA[id].CA=j
		if(arr[4]=="H" ) AA[id].H=j; if(arr[4]=="N+") AA[id].NX=j
		if(arr[4]=="C" ) AA[id].C=j; if(arr[4]=="H+") AA[id].HX=j
		if(arr[4]=="O" ) AA[id].O=j;
	}
}

var tabAA=$('AA'), tabBody=tabAA.tBodies[0], isAsc = true

var Fmol, molfile=$('molfile')
if(molfile) {
	if(window.File && window.FileReader && window.FileList && window.Blob)
		molfile.addEventListener('change', molReader, false);
	else alert('The File APIs are not fully supported by your browser.');
}

function loadAA(id) {
	let phipsi, ssType=document.getElementsByName('ssType')

	if(ssType[0].checked) phipsi='  -57.8 -47'
	if(ssType[1].checked) phipsi='  -74    -4'
	if(ssType[2].checked) phipsi='  -57.1 -69.7'
	if(ssType[3].checked) phipsi='  -75   160'
	if(ssType[4].checked) phipsi='  -75   150'
	if(ssType[5].checked) phipsi=' -139   135'
	if(ssType[6].checked) phipsi=' -119   113'
	if(ssType[7].checked) phipsi=$('phipsi').value

	Nclick++
	$('seq').innerHTML += printf('%3f %3s %s\n', Nclick, id, trim(phipsi))

	Fmol=normtrim(AA[id].xyz)
	Mol1.loadMolecule(ChemDoodle.readXYZ(Fmol))
	Mol1.startAnimation();Mol1.stopAnimation();
	$('img').src='./img/'+AA[id].en+'.png'
	$('title').innerHTML=id
}

function sortTable(idx) {
	let i, arr=[];     // 存放每一个tr

	//把每一个tr存放到一个数组，而不是排序的依据
	for(i=0; i<tabBody.rows.length; i++) arr[i] = tabBody.rows[i];

	//数组根据cells[0].innerHTML来排序
	arr.sort(function (td1, td2) {
		if(idx<4) {
			if(isAsc) return td1.cells[idx].innerHTML.localeCompare(td2.cells[idx].innerHTML);
			else      return td2.cells[idx].innerHTML.localeCompare(td1.cells[idx].innerHTML);
		} else {
			if(isAsc) return parseFloat(td1.cells[idx].innerHTML)-parseFloat(td2.cells[idx].innerHTML)
			else      return parseFloat(td2.cells[idx].innerHTML)-parseFloat(td1.cells[idx].innerHTML)
		}
	})

	//把排序后的tr 重新插入tbody
	for(i=0; i<arr.length; i++) tabBody.appendChild(arr[i]);

	//判断升序，降序
	isAsc = !isAsc;
}

function genPDB() {
	let seq=normtrim($('seq').value).split(/\n/)
	let i, j, n=seq.length, arr=[], res=[], PHI=[], PSI=[]
	for(i=0; i<n; i++) {
		arr=trim(seq[i]).split(/\s+/)
		res[i]=arr[1]
		PHI[i]=parseFloat(arr[2])
		PSI[i]=parseFloat(arr[3])
	}

	let Ntot=0, Natm, id, id_1,
		In, Ica, Ica_1,
		Ih, Inx, Inx_1,
		Ic, Ihx, Ihx_1,
		Io,      Ic_1,
		tht, omg, phi, psi,
		x0, y0, z0,
		x=[], y=[], z=[],
		V=[], nang=[]

	Fmol=''
	for(i=0; i<n; i++) {
		id=res[i]
		x[i]=[]; y[i]=[]; z[i]=[]
		Natm=AA[id].atom
		for(j=0; j<Natm; j++) {
			x[i][j] = AA[id].x[j]
			y[i][j] = AA[id].y[j]
			z[i][j] = AA[id].z[j]
		}

		In=AA[id].N; Ica=AA[id].CA
		Ih=AA[id].H; Inx=AA[id].NX
		Ic=AA[id].C; Ihx=AA[id].HX
		Io=AA[id].O;

		x0=0; y0=0; z0=0
		if(i>0) { // 非首端平移
			id_1=res[i-1]
			Ica_1=AA[id_1].CA
			Ic_1 =AA[id_1].C
			Inx_1=AA[id_1].NX
			Ihx_1=AA[id_1].HX

			x0 = x[i][In]-x[i-1][Inx_1]
			y0 = y[i][In]-y[i-1][Inx_1]
			z0 = z[i][In]-z[i-1][Inx_1]
			for(j=0; j<Natm; j++) {
				x[i][j] -= x0
				y[i][j] -= y0
				z[i][j] -= z0
			}
		}

		// psi: N-CA-C-N
		psi=dih(x[i][In],y[i][In],z[i][In], x[i][Ica],y[i][Ica],z[i][Ica],
				x[i][Ic],y[i][Ic],z[i][Ic], x[i][Inx],y[i][Inx],z[i][Inx] )
		AxiRotMat(PSI[i]-psi, x[i][Ic]-x[i][Ica], y[i][Ic]-y[i][Ica], z[i][Ic]-z[i][Ica])
		for(j=0; j<Natm; j++) {
			if(j==Io || j==Inx || j==Ihx) {
				V[1]=x[i][j]; V[2]=y[i][j]; V[3]=z[i][j]
				RotVect(RotMat, V, x[i][Ica], y[i][Ica], z[i][Ica])
				x[i][j] = V[1]; y[i][j] = V[2]; z[i][j] = V[3]
			}
		}

		if(i>0) {
			tht=ang(x[i-1][Ic_1],y[i-1][Ic_1],z[i-1][Ic_1], x[i][In],y[i][In],z[i][In],
					x[i  ][Ica ],y[i  ][Ica ],z[i  ][Ica ], nang)
			AxiRotMat(120-tht, nang[1], nang[2], nang[3])
			for(j=0; j<Natm; j++) {
				V[1]=x[i][j]; V[2]=y[i][j]; V[3]=z[i][j]
				RotVect(RotMat, V, x[i][In],y[i][In],z[i][In])
				x[i][j] = V[1]; y[i][j] = V[2]; z[i][j] = V[3]
			}

			// 二面角omg: CA-C-N-CA
			omg=dih(x[i-1][Ica_1],y[i-1][Ica_1],z[i-1][Ica_1], x[i-1][Ic_1],y[i-1][Ic_1],z[i-1][Ic_1],
					x[i  ][In   ],y[i  ][In   ],z[i  ][In   ], x[i  ][Ica ],y[i  ][Ica ],z[i  ][Ica] )
			AxiRotMat(180-omg, x[i][In]-x[i-1][Ic_1], y[i][In]-y[i-1][Ic_1], z[i][In]-z[i-1][Ic_1])
			for(j=0; j<Natm; j++) {
				V[1]=x[i][j]; V[2]=y[i][j]; V[3]=z[i][j]
				RotVect(RotMat, V, x[i-1][Ic_1], y[i-1][Ic_1], z[i-1][Ic_1])
				x[i][j] = V[1]; y[i][j] = V[2]; z[i][j] = V[3]
			}

			// 二面角phi: C-N-CA-C
			phi=dih(x[i-1][Ic_1],y[i-1][Ic_1],z[i-1][Ic_1], x[i][In],y[i][In],z[i][In],
					x[i  ][Ica ],y[i  ][Ica ],z[i  ][Ica ], x[i][Ic],y[i][Ic],z[i][Ic] )
			AxiRotMat(PHI[i]-phi, x[i][Ica]-x[i][In], y[i][Ica]-y[i][In], z[i][Ica]-z[i][In])
			for(j=0; j<Natm; j++) {
				if(j!=In) {
					V[1]=x[i][j]; V[2]=y[i][j]; V[3]=z[i][j]
					RotVect(RotMat, V, x[i][In], y[i][In], z[i][In])
					x[i][j] = V[1]; y[i][j] = V[2]; z[i][j] = V[3]
				}
			}

			if(id!="PRO") {
				x[i][Ih] = x[i-1][Ihx_1]
				y[i][Ih] = y[i-1][Ihx_1]
				z[i][Ih] = z[i-1][Ihx_1]
			}
		}

		for(j=0; j<Natm; j++) {
			if(j!=Inx && j!=Ihx) {
				Ntot++
				t=AA[id].t[j];
				if(t.length==1) t=" "+t+"  "
				if(t.length==2) t=" "+t+" "
				if(t.length==3 && t.search(/^[A-Z]/)!=-1) t=" "+t
				if(t.length==3 && t.search(/^[1-9]/)!=-1) t=t+" "
				Fmol+=printf('ATOM  %5f %4s %3s %1s%4f    %8.3f%8.3f%8.3f%6.2f%6.2f%10s%2s\n',
					Ntot, t, id, " ", i+1, x[i][j], y[i][j], z[i][j], 0, 0, " ", AA[id].s[j])
			}
		}
	}

	Fmol=pdbHeader+normtrim(Fmol)+'\n'+pdbConect
	Mol1.loadMolecule(ChemDoodle.readPDB(Fmol));
	Mol1.startAnimation();Mol1.stopAnimation();
	$('title').innerHTML=''
}

function dot(A, B)  { return A[1]*B[1]+A[2]*B[2]+A[3]*B[3] }
function cross(A, B, AxB) {
	AxB[1] = A[2]*B[3]-A[3]*B[2]
	AxB[2] = A[3]*B[1]-A[1]*B[3]
	AxB[3] = A[1]*B[2]-A[2]*B[1]
}

function ang(xi,yi,zi, xj,yj,zj, xk,yk,zk, nijk) {
	let Vi=[], Vk=[]
	Vi[1] = xi-xj; Vk[1] = xk-xj
	Vi[2] = yi-yj; Vk[2] = yk-yj
	Vi[3] = zi-zj; Vk[3] = zk-zj
	cross(Vi, Vk, nijk)
	return Math.acos(dot(Vi, Vk)/Math.sqrt(dot(Vi, Vi)*dot(Vk, Vk)))*r2d
}

function dih(xi,yi,zi, xj,yj,zj, xk,yk,zk, xl,yl,zl) {
	let Vj=[], Vk=[], Vl=[], Vijk=[], Vjkl=[]
	Vj[1] = xj-xi; Vk[1] = xk-xj; Vl[1] = xl-xk
	Vj[2] = yj-yi; Vk[2] = yk-yj; Vl[2] = yl-yk
	Vj[3] = zj-zi; Vk[3] = zk-zj; Vl[3] = zl-zk
	cross(Vj, Vk, Vijk)
	cross(Vk, Vl, Vjkl)
	return Math.atan2(Math.sqrt(dot(Vk,Vk))*dot(Vj, Vjkl), dot(Vijk, Vjkl))*r2d
}

function RotVect(RotMat, V, x0, y0, z0) {
	Vx = V[1]-x0; Vy = V[2]-y0; Vz = V[3]-z0
	V[1]= RotMat[1][1]*Vx + RotMat[1][2]*Vy + RotMat[1][3]*Vz + x0
	V[2]= RotMat[2][1]*Vx + RotMat[2][2]*Vy + RotMat[2][3]*Vz + y0
	V[3]= RotMat[3][1]*Vx + RotMat[3][2]*Vy + RotMat[3][3]*Vz + z0
}

function AxiRotMat(tht, x, y, z, r) {
	tht=tht*d2r
	r=x*x+y*y+z*z; if(r>0 && r!=1) { r=1/Math.sqrt(r); x*=r; y*=r; z*=r }

	r=Math.sin(tht/2); w=Math.cos(tht/2); x*=r; y*=r; z*=r
	RotMat[1][1]= 1-2*(y*y+z*z); RotMat[1][2]=   2*(x*y-w*z); RotMat[1][3]=   2*(x*z+w*y);
	RotMat[2][1]=   2*(x*y+w*z); RotMat[2][2]= 1-2*(x*x+z*z); RotMat[2][3]=   2*(y*z-w*x);
	RotMat[3][1]=   2*(x*z-w*y); RotMat[3][2]=   2*(y*z+w*x); RotMat[3][3]= 1-2*(x*x+y*y);
}

function savePDB(ext) {
	var value=Fmol, type='text', name='conf.pdb'
	var blob;
	if (typeof window.Blob == "function") {
		blob = new Blob([value], {type: type});
	} else {
		var BlobBuilder =  window.BlobBuilder
						|| window.MozBlobBuilder
						|| window.WebKitBlobBuilder
						|| window.MSBlobBuilder;
		var bb = new BlobBuilder();
		bb.append(value);
		blob = bb.getBlob(type);
	}
	var URL = window.URL || window.webkitURL;
	var bloburl = URL.createObjectURL(blob);
	var anchor = document.createElement("a");
	if ('download' in anchor) {
		anchor.style.visibility = "hidden";
		anchor.href = bloburl;
		anchor.download = name;
		document.body.appendChild(anchor);
		var evt = document.createEvent("MouseEvents");
		evt.initEvent("click", true, true);
		anchor.dispatchEvent(evt);
		document.body.removeChild(anchor);
	} else if (navigator.msSaveBlob) {
		navigator.msSaveBlob(blob, name);
	} else {
		location.href = bloburl;
	}
}

function readXYZ(lines) { // Read xyz file - Format compatible with openbabel
///   lines:    Array holding content of .xyz file as lines
Fmol=''
for(let i=0; i<lines.length; i++) Fmol += norm(trim(lines[i]))+'\n'

Fmol=norm(trim(Fmol))
  Mol1.loadMolecule(ChemDoodle.readXYZ(Fmol));Mol1.startAnimation();Mol1.stopAnimation();
}

function readPDB(lines) {
	let i, arr=[], Nres=0, x, y, z, phi, psi, isHeader,
		Nx=[], Ny=[], Nz=[], CAx=[], CAy=[], CAz=[],
		Cx=[], Cy=[], Cz=[], res=[], idx=[]
	Fmol=''; pdbHeader=''; pdbConect=''; isHeader=1
	for(i=0; i<lines.length; i++) {
		Fmol += trim(lines[i])+'\n'
		arr=lines[i].split(/\s+/)
		if(arr[0]=='ATOM') {
			isHeader=0
			x = parseFloat(lines[i].substr(31,8));
			y = parseFloat(lines[i].substr(39,8));
			z = parseFloat(lines[i].substr(47,8));
			if(arr[2]=='N') {Nres++; Nx[Nres]=x; Ny[Nres]=y; Nz[Nres] =z; res[Nres]=arr[3]; idx[Nres]=arr[4] }
			if(arr[2]=='CA'){ CAx[Nres]=x; CAy[Nres]=y; CAz[Nres]=z }
			if(arr[2]=='C') { Cx[Nres] =x; Cy[Nres] =y; Cz[Nres] =z }
		}
		if(isHeader) pdbHeader += lines[i]+'\n'
		if(arr[0]=='CONECT') pdbConect += lines[i]+'\n'
	}
	Mol1.loadMolecule(ChemDoodle.readPDB(Fmol));
	Mol1.startAnimation();Mol1.stopAnimation();

	// psi: N-CA-C-N
	// 二面角phi: C-N-CA-C
	x=''
	for(i=1; i<=Nres; i++) {
		phi=-139; psi=135
		if(i>1)    phi=dih(Cx[i-1],Cy[i-1],Cz[i-1], Nx[i],Ny[i],Nz[i],
						   CAx[i], CAy[i], CAz[i],  Cx[i],Cy[i],Cz[i] )
		if(i<Nres) psi=dih(Nx[i],Ny[i],Nz[i], CAx[i], CAy[i], CAz[i],
						   Cx[i],Cy[i],Cz[i], Nx[i+1],Ny[i+1],Nz[i+1] )
		x += printf('%3f %3s %6.1f %6.1f\n', i, res[i], phi, psi)
	}
	$('seq').innerHTML = x
}

function molReader(evt) {
	var validExtension;
	var localfile = evt.target.files[0];

	// Call routine to read and process data
	if(localfile) {
		var fr = new FileReader();
		fr.onload = function(fh) {
			validExtension = 0;
			var ext = localfile.name.substring(localfile.name.lastIndexOf('.')+1).toLowerCase();
			var contents = fh.target.result;
			var lines = contents.split('\n');
			if(ext == "pdb" ) {
				validExtension = 1;
				readPDB(lines);
			}
			if(ext == "xyz" ) {
				validExtension = 1;
				readXYZ(lines);
			}

			if ( validExtension == 0 ) {
				alert("*** ERROR: Invalid file type for "+localfile.name+". ***",1);
				return;
			}
		}
		fr.readAsText(localfile);
	} else {
		alert("Failed to load file");
	}
}
</script>
