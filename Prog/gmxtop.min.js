function trim(a){return a.replace(/^(\s|\u00A0)+/,"").replace(/(\s|\u00A0)+$/,"")}function norm(a){return a.replace(/^\s*\n*/,"").replace(/\s*\n*$/,"").replace(/\s+[\n|$]/g,"\n")}function noShow(a){$(a).style.display="none"}function printf(){var a={s:function(a,b){var c=a.length;return c>b?a:a+Array(b-c+1).join(" ")},f:function(a,b){b=b.split("."),a=parseFloat(a).toFixed(b[1]);var c=b[0],d=a.length;return d>c?a:Array(c-d+1).join(" ")+a}},b=Array.prototype.slice.call(arguments).slice();return b.shift().toString().replace(/%(-*\d*\.*\d*)([sf])/g,function(c,d,e){if(!b.length)throw new Error("Too few elements");return a[e](b.shift().toString(),d)})}function initCanvas(){window.addEventListener("resize",resizeCanvas,!1),resizeCanvas()}function resizeCanvas(){var a=$("molcanvas");a.width=.78*(document.body.clientWidth||window.innerWidth),a.height=.65*(document.body.clientHeight||window.innerHeight),drawMolecule(),resetView()}function genTop(){var a,b,c,d,e,f,g,h=[],i=0,j=Mol(),k=j[0].numatoms,l=BondMatrix();for(e=norm($("atp2").value).split("\n"),a=e.length;a--;)e[a]=e[a].replace(/^.*opls_/,"opls_");for(f='#include "oplsaa.ff/forcefield.itp"\n#include "oplsaa.ff/tip3p.itp"\n\n[ moleculetype ]\n  MOL    3\n	[ atoms ]\n',a=1;k>=a;a++)g=e[a-1],h[a]=atpLab[g],i+=parseFloat(atpChg[g]),f+=printf("    %4f %12s  1  MOL  %6s %4f  %9.4f %12.6f   %s  [%s] %8.4f\n",a,g,h[a],a,atpChg[g],atpMas[g],atpTip[g],h[a],i);for(f+="	[ bonds ]\n",a=1;k>=a;a++)for(b=a+1;k>=b;b++)if(l[a][b]){f+=printf("    %4f%4f",a,b);for(e in bonPar)para=e.split("|"),(para[1]==h[a]&&para[2]==h[b]||para[1]==h[b]&&para[2]==h[a])&&(f+=printf("    %s  %s",bonPar[e],e));f+="\n"}for(f+="	[ angles ]\n",b=1;k>=b;b++)for(a=1;k>=a;a++)if(l[a][b]&&a!=b)for(c=a+1;k>=c;c++)if(l[b][c]&&c!=a&&c!=b){f+=printf("    %4f%4f%4f",a,b,c);for(e in angPar)para=e.split("|"),para[2]==h[b]&&(para[1]==h[a]&&para[3]==h[c]||para[1]==h[c]&&para[3]==h[a])&&(f+=printf("    %s  %s",angPar[e],e));f+="\n"}for(f+="	[ dihedrals ]\n",b=1;k>=b;b++)for(c=b+1;k>=c;c++)if(l[b][c])for(a=1;k>=a;a++)if(l[a][b]&&a!=b&&a!=c)for(d=1;k>=d;d++)if(l[d][c]&&d!=a&&d!=b&&d!=c){f+=printf("    %4f%4f%4f%4f",a,b,c,d);for(e in dihPar)para=e.split("|"),(para[1]==h[a]&&para[2]==h[b]&&para[3]==h[c]&&para[4]==h[d]||para[1]==h[d]&&para[2]==h[c]&&para[3]==h[b]&&para[4]==h[a]||"X"==para[1]&&para[2]==h[b]&&para[3]==h[c]&&para[4]==h[d]||para[1]==h[d]&&para[2]==h[c]&&para[3]==h[b]&&"X"==para[4]||para[1]==h[a]&&para[2]==h[b]&&para[3]==h[c]&&"X"==para[4]||"X"==para[1]&&para[2]==h[c]&&para[3]==h[b]&&para[4]==h[a]||"X"==para[1]&&para[2]==h[b]&&para[3]==h[c]&&"X"==para[4]||"X"==para[1]&&para[2]==h[c]&&para[3]==h[b]&&"X"==para[4])&&(f+=printf("    %s  %s",dihPar[e],e));f+="\n"}f+="\n[ system ]\n  MOL OPLS\n",f+="	[ molecules ]\n      MOL    1\n",$("top").value=f}function saveTop(){var a,b,c,d,e,f,g,h=$("top").value,i="text",j="topol.top";"function"==typeof window.Blob?a=new Blob([h],{type:i}):(b=window.BlobBuilder||window.MozBlobBuilder||window.WebKitBlobBuilder||window.MSBlobBuilder,c=new b,c.append(h),a=c.getBlob(i)),d=window.URL||window.webkitURL,e=d.createObjectURL(a),f=document.createElement("a"),"download"in f?(f.style.visibility="hidden",f.href=e,f.download=j,document.body.appendChild(f),g=document.createEvent("MouseEvents"),g.initEvent("click",!0,!0),f.dispatchEvent(g),document.body.removeChild(f)):navigator.msSaveBlob?navigator.msSaveBlob(a,j):location.href=e}function loadFF(){var a,b,c,d,e,f,g;for(f=norm($("atomtypes.atp").value).replace(/\t+/g," "),f=f.split("\n"),a=f.length,g=0;a--;)e=trim(f[a]),";"!=e.substring(0,1)&&(g++,c=e.substring(0,e.indexOf(" ")),b=e.indexOf(";"),atpTip[c]=";",-1!=b&&(atpTip[c]=e.substring(b)));for(f=norm($("ffnonbonded.itp").value).replace(/\t+/g," "),f=f.split("\n"),a=f.length,g=0;a--;)e=trim(f[a]),";"!=e.substring(0,1)&&"#"!=e.substring(0,1)&&"["!=e.substring(0,1)&&(g++,e=e.split(/\s+/),c=e[0],atpLab[c]=e[1],atpNum[c]=e[2],atpMas[c]=e[3],atpChg[c]=e[4],atpAtm[c]=e[5],atpSgm[c]=e[6],atpEps[c]=e[7]);for(keyOPLS=Object.keys(atpNum).sort(),f=norm($("ffbonded.itp").value).replace(/\t+/g," "),f=f.split("\n"),a=f.length;a--;)e=trim(f[a]),";"!=e.substring(0,1)&&"["!=e.substring(0,1)&&"#"!=e.substring(0,1)&&(b=e.search(/\s+\d+\s+/),c=trim(e.substring(0,b)),d=trim(e.substring(b)),c=c.replace(/\s+/g,"|"),b=c.split("|").length,c="|"+c+"|",3==b?angPar[c]=d:4==b?dihPar[c]=d:2==b&&(2==trim(d.replace(/;.*/,"")).split(/\s+/).length?cstPar[c]=d:bonPar[c]=d))}function setATP(){var a,b,c=Mol();for($("atp").innerHTML="",$("atp2").value="",a=1;a<=c[0].numatoms;a++)b=element(c[a].atomicnumber,"symbol")+a+" "+c[a].type,$("atp").innerHTML+="<option>"+b+"</option>",$("atp2").value+=b+"\n"}function showType(a){var b,c=Mol(),d=c[0].numatoms,e=a;if("SEL"==a){for(;d--;)c[d].highlite=0;for(b=$("atp"),a="",d=b.length;d--;)b.options[d].selected&&(e=d+1,a+=b.options[d].text.replace(/opls_.*/g,"").replace(/[^\d]/g,"")+" ",c[d+1].highlite=1);drawMolecule()}for(e=c[e].atomicnumber,$("divType").innerHTML="",j=0;j<keyOPLS.length;j++)d=keyOPLS[j],k=parseInt(d.replace(/[^\d]/g,"")),135>k||k>300||atpNum[d]==e&&($("divType").innerHTML+="<input type='radio' name='opls' id='"+d+"'><label for='"+d+"'>"+d+"<img src='./OPLS/"+d+".png' class='opls' ondblclick='getType(this.src)'></label><br>");$("divType").innerHTML+="<span id='atmIndex' lang=''></span><span id='atmType' lang=''></span><input type='button' onclick='getType(\"\")' value='OK' style='top: 0px'>&nbsp; &nbsp; &nbsp; &nbsp;<input type='button' onclick='noShow(\"divType\")' value='Cancel'>",$("atmIndex").lang=a,$("divType").style.display="block"}function getType(a){var b,c,d,e;if(a)a=a.replace(/.*(opls_.+).png/,"$1");else for(b=document.getElementsByName("opls"),c=b.length;c--;)b[c].checked&&(a=b[c].id);if($("atmType").lang=a,d=Mol(),d[0].numatoms,e=trim($("atmIndex").lang),e.length)for(e=e.split(/\s+/),c=e.length;c--;)d[e[c]].type=a;setATP(),$("divType").style.display="none"}function element(a,b){if("undefined"==typeof element.elem&&(element.elem=[],element.elem[0]=addElement(0,"X","s",0,0,0,0,0,0,0),element.elem[1]=addElement(1,"H","s",1,1.0079,31,255,255,255,2.2),element.elem[2]=addElement(2,"He","s",2,4.0026,28,217,255,255,0),element.elem[3]=addElement(3,"Li","s",1,6.941,128,204,128,255,.98),element.elem[4]=addElement(4,"Be","s",2,9.0122,96,194,255,0,1.57),element.elem[5]=addElement(5,"B","p",3,10.811,84,255,181,181,2.04),element.elem[6]=addElement(6,"C","p",4,12.0107,76,144,144,144,2.55),element.elem[7]=addElement(7,"N","p",5,14.0067,71,48,80,248,3.04),element.elem[8]=addElement(8,"O","p",6,15.9994,66,255,13,13,3.44),element.elem[9]=addElement(9,"F","p",7,18.9984,57,144,224,80,3.98),element.elem[10]=addElement(10,"Ne","p",8,20.1797,58,179,227,245,0),element.elem[11]=addElement(11,"Na","s",1,22.9897,166,171,92,242,.93),element.elem[12]=addElement(12,"Mg","s",2,24.305,141,138,255,0,1.31),element.elem[13]=addElement(13,"Al","p",3,26.9815,121,191,166,166,1.61),element.elem[14]=addElement(14,"Si","p",4,28.0855,111,240,200,160,1.9),element.elem[15]=addElement(15,"P","p",5,30.9738,107,255,128,0,2.19),element.elem[16]=addElement(16,"S","p",6,32.065,105,255,255,48,2.58),element.elem[17]=addElement(17,"Cl","p",7,35.453,102,31,240,31,3.16),element.elem[18]=addElement(18,"Ar","p",8,39.948,106,128,209,227,0),element.elem[19]=addElement(19,"K","s",1,39.0983,203,143,64,212,.82),element.elem[20]=addElement(20,"Ca","s",2,40.078,176,61,255,0,1),element.elem[21]=addElement(21,"Sc","d",3,44.9559,170,230,230,230,1.36),element.elem[22]=addElement(22,"Ti","d",4,47.867,160,191,194,199,1.54),element.elem[23]=addElement(23,"V","d",5,50.9415,153,166,166,171,1.63),element.elem[24]=addElement(24,"Cr","d",6,51.9961,139,138,153,199,1.66),element.elem[25]=addElement(25,"Mn","d",7,54.938,139,156,122,199,1.55),element.elem[26]=addElement(26,"Fe","d",8,55.845,132,224,102,51,1.83),element.elem[27]=addElement(27,"Co","d",9,58.9332,126,240,144,160,1.88),element.elem[28]=addElement(28,"Ni","d",10,58.6934,124,80,208,80,1.91),element.elem[29]=addElement(29,"Cu","d",11,63.546,132,200,128,51,1.9),element.elem[30]=addElement(30,"Zn","d",2,65.39,122,125,128,176,1.65),element.elem[31]=addElement(31,"Ga","p",3,69.723,122,194,143,143,1.81),element.elem[32]=addElement(32,"Ge","p",4,72.64,120,102,143,143,2.01),element.elem[33]=addElement(33,"As","p",5,74.9216,119,189,128,227,2.18),element.elem[34]=addElement(34,"Se","p",6,78.96,120,255,161,0,2.55),element.elem[35]=addElement(35,"Br","p",7,79.904,120,166,41,41,2.96),element.elem[36]=addElement(36,"Kr","p",8,83.8,116,92,184,209,3),element.elem[37]=addElement(37,"Rb","s",1,85.4678,220,112,46,176,.82),element.elem[38]=addElement(38,"Sr","s",2,87.62,195,0,255,0,.95),element.elem[39]=addElement(39,"Y","d",3,88.9059,190,148,255,255,1.22),element.elem[40]=addElement(40,"Zr","d",4,91.224,175,148,224,224,1.33),element.elem[41]=addElement(41,"Nb","d",5,92.9064,164,115,194,201,1.6),element.elem[42]=addElement(42,"Mo","d",6,95.94,154,84,181,181,2.16),element.elem[43]=addElement(43,"Tc","d",7,98,147,59,158,158,1.9),element.elem[44]=addElement(44,"Ru","d",8,101.07,146,36,143,143,2.2),element.elem[45]=addElement(45,"Rh","d",9,102.9055,142,10,125,140,2.28),element.elem[46]=addElement(46,"Pd","d",10,106.42,139,0,105,133,2.2),element.elem[47]=addElement(47,"Ag","d",11,107.8682,145,192,192,192,1.93),element.elem[48]=addElement(48,"Cd","d",2,112.411,144,255,217,143,1.69),element.elem[49]=addElement(49,"In","p",3,114.818,142,166,117,115,1.78),element.elem[50]=addElement(50,"Sn","p",4,118.71,139,102,128,128,1.96),element.elem[51]=addElement(51,"Sb","p",5,121.76,139,158,99,181,2.05),element.elem[52]=addElement(52,"Te","p",6,127.6,138,212,122,0,2.1),element.elem[53]=addElement(53,"I","p",7,126.9045,139,148,0,148,2.66),element.elem[54]=addElement(54,"Xe","p",8,131.293,140,66,158,176,2.6),element.elem[55]=addElement(55,"Cs","s",1,132.9055,244,87,23,143,.79),element.elem[56]=addElement(56,"Ba","s",2,137.327,215,0,201,0,.89),element.elem[57]=addElement(57,"La","d",3,138.9055,207,112,212,255,1.1),element.elem[58]=addElement(58,"Ce","f",4,140.116,204,255,255,199,1.12),element.elem[59]=addElement(59,"Pr","f",5,140.9077,203,217,255,199,1.13),element.elem[60]=addElement(60,"Nd","f",6,144.24,201,199,255,199,1.14),element.elem[61]=addElement(61,"Pm","f",7,145,199,163,255,199,0),element.elem[62]=addElement(62,"Sm","f",8,150.36,198,143,255,199,1.17),element.elem[63]=addElement(63,"Eu","f",9,151.964,198,97,255,199,0),element.elem[64]=addElement(64,"Gd","f",10,157.25,196,69,255,199,1.2),element.elem[65]=addElement(65,"Tb","f",11,158.9253,194,48,255,199,0),element.elem[66]=addElement(66,"Dy","f",12,162.5,192,31,255,199,1.22),element.elem[67]=addElement(67,"Ho","f",13,164.9303,192,0,255,156,1.23),element.elem[68]=addElement(68,"Er","f",14,167.259,189,0,230,117,1.24),element.elem[69]=addElement(69,"Tm","f",15,168.9342,190,0,212,82,1.25),element.elem[70]=addElement(70,"Yb","f",16,173.04,187,0,191,56,0),element.elem[71]=addElement(71,"Lu","f",17,174.967,187,0,171,36,1.27),element.elem[72]=addElement(72,"Hf","d",4,178.49,175,77,194,255,1.3),element.elem[73]=addElement(73,"Ta","d",5,180.9479,170,77,166,255,1.5),element.elem[74]=addElement(74,"W","d",6,183.84,162,33,148,214,2.36),element.elem[75]=addElement(75,"Re","d",7,186.207,151,38,125,171,1.9),element.elem[76]=addElement(76,"Os","d",8,190.23,144,38,102,150,2.2),element.elem[77]=addElement(77,"Ir","d",9,192.217,141,23,84,135,2.2),element.elem[78]=addElement(78,"Pt","d",10,195.078,136,208,208,224,2.28),element.elem[79]=addElement(79,"Au","d",11,196.9665,136,255,209,35,2.54),element.elem[80]=addElement(80,"Hg","d",2,200.59,132,184,184,208,2),element.elem[81]=addElement(81,"Tl","p",3,204.3833,145,166,84,77,1.62),element.elem[82]=addElement(82,"Pb","p",4,207.2,146,87,89,97,2.33),element.elem[83]=addElement(83,"Bi","p",5,208.9804,148,158,79,181,2.02),element.elem[84]=addElement(84,"Po","p",6,209,140,171,92,0,2),element.elem[85]=addElement(85,"At","p",7,210,150,117,79,69,2.2),element.elem[86]=addElement(86,"Rn","p",8,222,150,66,130,150,0),element.elem[87]=addElement(87,"Fr","s",1,223,260,66,0,102,.7),element.elem[88]=addElement(88,"Ra","s",2,226,221,0,125,0,.9),element.elem[89]=addElement(89,"Ac","d",3,227,215,112,171,250,1.1),element.elem[90]=addElement(90,"Th","f",4,232.0381,206,0,186,255,1.3),element.elem[91]=addElement(91,"Pa","f",5,231.0359,200,0,161,255,1.5),element.elem[92]=addElement(92,"U","f",6,238.0289,196,0,143,255,1.38),element.elem[93]=addElement(93,"Np","f",7,237,190,0,128,255,1.36),element.elem[94]=addElement(94,"Pu","f",8,244,187,0,107,255,1.28),element.elem[95]=addElement(95,"Am","f",9,243,180,84,92,242,1.3),element.elem[96]=addElement(96,"Cm","f",10,247,169,120,92,227,1.3),element.elem[97]=addElement(97,"Bk","f",11,247,168,138,79,227,1.3),element.elem[98]=addElement(98,"Cf","f",12,251,168,161,54,212,1.3),element.elem[99]=addElement(99,"Es","f",13,252,165,179,31,212,1.3),element.elem[100]=addElement(100,"Fm","f",14,257,167,179,31,186,1.3),element.elem[101]=addElement(101,"Md","f",15,258,173,179,13,166,1.3),element.elem[102]=addElement(102,"No","f",16,259,176,189,13,135,1.3),element.elem[103]=addElement(103,"Lr","f",17,262,161,199,0,102,0),element.elem[104]=addElement(104,"Rf","d",4,267,157,204,0,89,0),element.elem[105]=addElement(105,"Db","d",5,268,149,209,0,79,0),element.elem[106]=addElement(106,"Sg","d",6,269,143,217,0,69,0),element.elem[107]=addElement(107,"Bh","d",7,270,141,224,0,56,0),element.elem[108]=addElement(108,"Hs","d",8,269,134,230,0,46,0),element.elem[109]=addElement(109,"Mt","d",9,278,129,235,0,38,0),element.elem[110]=addElement(110,"Ds","d",10,281,0,0,0,28,0),element.elem[111]=addElement(111,"Rg","d",11,281,0,0,0,28,0),element.elem[112]=addElement(112,"Cn","d",12,285,0,0,0,28,0),element.elem[113]=addElement(113,"Uut","p",3,286,0,0,0,28,0),element.elem[114]=addElement(114,"Fl","p",4,289,0,0,0,28,0),element.elem[115]=addElement(115,"Uup","p",5,288,0,0,0,28,0),element.elem[116]=addElement(116,"Lv","p",6,293,0,0,0,28,0),element.elem[117]=addElement(117,"Uus","p",7,294,0,0,0,28,0),element.elem[118]=addElement(118,"Uuo","p",8,294,0,0,0,28,0)),0>a||a>element.elem.length)return alert("Element "+a+" is not defined."),0;switch(b){case"symbol":return element.elem[a].symbol;case"block":return element.elem[a].block;case"valence":return element.elem[a].valence;case"mass":return element.elem[a].mass;case"radius":return element.elem[a].radius;case"EN":return element.elem[a].EN;case"color":return element.elem[a].color;case"gradient":return element.elem[a].gradient;case"label":return element.elem[a].label;case"max":return element.elem.length;default:return alert("Param "+b+" is not defined."),0}}function elementObject(){this.symbol="?",this.block="?",this.valence=0,this.mass=0,this.radius=0,this.EN=0,this.color="rgb(88,88,88)",this.gradient="rgb(88,88,88)",this.label="rgb(255,255,255)"}function addElement(a,b,c,d,e,f,g,h,i,j){var k,l,m=new elementObject;return m.symbol=b,m.block=c,m.valence=d,m.mass=e,k=0>=f?.1:f/100,m.radius=k,m.color="rgb("+g+","+h+","+i+")",m.gradient="rgb("+Math.floor(g/2)+","+Math.floor(h/2)+","+Math.floor(i/2)+")",l=g+h+i,m.label=l>384?"rgb(0,0,0)":"rgb(255,255,255)",m.EN=j,m}function drawPeriodic(){var a,b="ptable",c="<table><tr>";c+='<td class="main" id="mH"  onclick="pickElem(\'H\');">H</td>',c+='<td class="Row"  id="Row1" colspan="12">&nbsp;</td>',c+='<td class="plabel" id="plabel" colspan="4" onclick="pickElem(\'PView\');">',c+='<div id="pchooser">Metals</div></td>',c+='<td class="metl" id="pHe" onclick="pickElem(\'He\');">He</td>',c+="</tr>\n",c+="<tr>",c+='<td class="metl" id="pLi" onclick="pickElem(\'Li\');">Li</td>',c+='<td class="metl" id="pBe" onclick="pickElem(\'Be\');">Be</td>',c+='<td class="Row"  id="Row2" colspan="10">&nbsp;</td>',c+='<td class="main" id="mB"  onclick="pickElem(\'B\');">B</td>',c+='<td class="main" id="mC"  onclick="pickElem(\'C\');">C</td>',c+='<td class="main" id="mN"  onclick="pickElem(\'N\');">N</td>',c+='<td class="main" id="mO"  onclick="pickElem(\'O\');">O</td>',c+='<td class="main" id="mF"  onclick="pickElem(\'F\');">F</td>',c+='<td class="metl" id="pNe" onclick="pickElem(\'Ne\');">Ne</td>',c+="</tr>\n",c+="<tr>",c+='<td class="metl" id="pNa" onclick="pickElem(\'Na\');">Na</td>',c+='<td class="metl" id="pMg" onclick="pickElem(\'Mg\');">Mg</td>',c+='<td class="Row"  id="Row3" colspan="10">&nbsp;</td>',c+='<td class="main" id="mAl" onclick="pickElem(\'Al\')">Al</td>',c+='<td class="main" id="mSi" onclick="pickElem(\'Si\')">Si</td>',c+='<td class="main" id="mP"  onclick="pickElem(\'P\')">P</td>',c+='<td class="main" id="mS"  onclick="pickElem(\'S\')">S</td>',c+='<td class="main" id="mCl" onclick="pickElem(\'Cl\')">Cl</td>',c+='<td class="metl" id="pAr" onclick="pickElem(\'Ar\')">Ar</td>',c+="</tr>\n",c+="<tr>",c+='<td class="metl" id="pK"  onclick="pickElem(\'K\')">K</td>',c+='<td class="metl" id="pCa" onclick="pickElem(\'Ca\')">Ca</td>',c+='<td class="metl" id="pSc" onclick="pickElem(\'Sc\')">Sc</td>',c+='<td class="metl" id="pTi" onclick="pickElem(\'Ti\')">Ti</td>',c+='<td class="metl" id="pV"  onclick="pickElem(\'V\')">V</td>',c+='<td class="metl" id="pCr" onclick="pickElem(\'Cr\')">Cr</td>',c+='<td class="metl" id="pMn" onclick="pickElem(\'Mn\')">Mn</td>',c+='<td class="metl" id="pFe" onclick="pickElem(\'Fe\')">Fe</td>',c+='<td class="metl" id="pCo" onclick="pickElem(\'Co\')">Co</td>',c+='<td class="metl" id="pNi" onclick="pickElem(\'Ni\')">Ni</td>',c+='<td class="metl" id="pCu" onclick="pickElem(\'Cu\')">Cu</td>',c+='<td class="metl" id="pZn" onclick="pickElem(\'Zn\')">Zn</td>',c+='<td class="main" id="mGa" onclick="pickElem(\'Ga\')">Ga</td>',c+='<td class="main" id="mGe" onclick="pickElem(\'Ge\')">Ge</td>',c+='<td class="main" id="mAs" onclick="pickElem(\'As\')">As</td>',c+='<td class="main" id="mSe" onclick="pickElem(\'Se\')">Se</td>',c+='<td class="main" id="mBr" onclick="pickElem(\'Br\')">Br</td>',c+='<td class="metl" id="pKr" onclick="pickElem(\'Kr\')">Kr</td>',c+="</tr>\n",c+="<tr>",c+='<td class="metl" id="pRb" onclick="pickElem(\'Rb\')">Rb</td>',c+='<td class="metl" id="pSr" onclick="pickElem(\'Sr\')">Sr</td>',c+='<td class="metl" id="pY"  onclick="pickElem(\'Y\')">Y</td>',c+='<td class="metl" id="pZr" onclick="pickElem(\'Zr\')">Zr</td>',c+='<td class="metl" id="pNb" onclick="pickElem(\'Nb\')">Nb</td>',c+='<td class="metl" id="pMo" onclick="pickElem(\'Mo\')">Mo</td>',c+='<td class="metl" id="pTc" onclick="pickElem(\'Tc\')">Tc</td>',c+='<td class="metl" id="pRu" onclick="pickElem(\'Ru\')">Ru</td>',c+='<td class="metl" id="pRh" onclick="pickElem(\'Rh\')">Rh</td>',c+='<td class="metl" id="pPd" onclick="pickElem(\'Pd\')">Pd</td>',c+='<td class="metl" id="pAg" onclick="pickElem(\'Ag\')">Ag</td>',c+='<td class="metl" id="pCd" onclick="pickElem(\'Cd\')">Cd</td>',c+='<td class="main" id="mIn" onclick="pickElem(\'In\')">In</td>',c+='<td class="main" id="mSn" onclick="pickElem(\'Sn\')">Sn</td>',c+='<td class="main" id="mSb" onclick="pickElem(\'Sb\')">Sb</td>',c+='<td class="main" id="mTe" onclick="pickElem(\'Te\')">Te</td>',c+='<td class="main" id="mI"  onclick="pickElem(\'I\')">I</td>',c+='<td class="metl" id="pXe" onclick="pickElem(\'Xe\')">Xe</td>',c+="</tr>\n",c+="<tr>",c+='<td class="metl" id="pCs" onclick="pickElem(\'Cs\')">Cs</td>',c+='<td class="metl" id="pBa" onclick="pickElem(\'Ba\')">Ba</td>',c+='<td class="metl" id="pLa" onclick="pickElem(\'La\')">La</td>',c+='<td class="metl" id="pHf" onclick="pickElem(\'Hf\')">Hf</td>',c+='<td class="metl" id="pTa" onclick="pickElem(\'Ta\')">Ta</td>',c+='<td class="metl" id="pW"  onclick="pickElem(\'W\')">W</td>',c+='<td class="metl" id="pRe" onclick="pickElem(\'Re\')">Re</td>',c+='<td class="metl" id="pOs" onclick="pickElem(\'Os\')">Os</td>',c+='<td class="metl" id="pIr" onclick="pickElem(\'Ir\')">Ir</td>',c+='<td class="metl" id="pPt" onclick="pickElem(\'Pt\')">Pt</td>',c+='<td class="metl" id="pAu" onclick="pickElem(\'Au\')">Au</td>',c+='<td class="metl" id="pHg" onclick="pickElem(\'Hg\')">Hg</td>',c+='<td class="main" id="mTl" onclick="pickElem(\'Tl\')">Tl</td>',c+='<td class="main" id="mPb" onclick="pickElem(\'Pb\')">Pb</td>',c+='<td class="main" id="mBi" onclick="pickElem(\'Bi\')">Bi</td>',c+='<td class="main" id="mPo" onclick="pickElem(\'Po\')">Po</td>',c+='<td class="main" id="mAt" onclick="pickElem(\'At\')">At</td>',c+='<td class="metl" id="pRn" onclick="pickElem(\'Rn\')">Rn</td>',c+="</tr>\n",c+="<tr>",c+='<td class="metl" id="pFr"  onclick="pickElem(\'Fr\')">Fr</td>',c+='<td class="metl" id="pRa"  onclick="pickElem(\'Ra\')">Ra</td>',c+='<td class="metl" id="pAc"  onclick="pickElem(\'Ac\')">Ac</td>',c+='<td class="metl" id="pRf"  onclick="pickElem(\'Rf\')">Rf</td>',c+='<td class="metl" id="pDb"  onclick="pickElem(\'Db\')">Db</td>',c+='<td class="metl" id="pSg"  onclick="pickElem(\'Sg\')">Sg</td>',c+='<td class="metl" id="pBh"  onclick="pickElem(\'Bh\')">Bh</td>',c+='<td class="metl" id="pHs"  onclick="pickElem(\'Hs\')">Hs</td>',c+='<td class="metl" id="pMt"  onclick="pickElem(\'Mt\')">Mt</td>',c+='<td class="metl" id="pDs"  onclick="pickElem(\'Ds\')">Ds</td>',c+='<td class="metl" id="pRg"  onclick="pickElem(\'Rg\')">Rg</td>',c+='<td class="metl" id="pCn"  onclick="pickElem(\'Cn\')">Cn</td>',c+='<td class="metl" id="pUut" onclick="pickElem(\'Uut\')">Uut</td>',c+='<td class="metl" id="pFl"  onclick="pickElem(\'Fl\')">Fl</td>',c+='<td class="metl" id="pUup" onclick="pickElem(\'Uup\')">Uup</td>',c+='<td class="metl" id="pLv"  onclick="pickElem(\'Lv\')">Lv</td>',c+='<td class="metl" id="pUus" onclick="pickElem(\'Uus\')">Uus</td>',c+='<td class="metl" id="pUuo" onclick="pickElem(\'Uuo\')">Uuo</td>',c+="</tr>\n",c+="<tr>",c+='<td class="Row"  id="RowLa" colspan="2">&nbsp;</td>',c+='<td class="metl" id="pCe" onclick="pickElem(\'Ce\')">Ce</td>',c+='<td class="metl" id="pPr" onclick="pickElem(\'Pr\')">Pr</td>',c+='<td class="metl" id="pNd" onclick="pickElem(\'Nd\')">Nd</td>',c+='<td class="metl" id="pPm" onclick="pickElem(\'Pm\')">Pm</td>',c+='<td class="metl" id="pSm" onclick="pickElem(\'Sm\')">Sm</td>',c+='<td class="metl" id="pEu" onclick="pickElem(\'Eu\')">Eu</td>',c+='<td class="metl" id="pGd" onclick="pickElem(\'Gd\')">Gd</td>',c+='<td class="metl" id="pTb" onclick="pickElem(\'Tb\')">Tb</td>',c+='<td class="metl" id="pDy" onclick="pickElem(\'Dy\')">Dy</td>',c+='<td class="metl" id="pHo" onclick="pickElem(\'Ho\')">Ho</td>',c+='<td class="metl" id="pEr" onclick="pickElem(\'Er\')">Er</td>',c+='<td class="metl" id="pTm" onclick="pickElem(\'Tm\')">Tm</td>',c+='<td class="metl" id="pYb" onclick="pickElem(\'Yb\')">Yb</td>',c+='<td class="metl" id="pLu" onclick="pickElem(\'Lu\')">Lu</td>',c+='<td class="Row"  id="RowLa2" colspan="2">&nbsp;</td>',c+="</tr>\n",c+="<tr>",c+='<td class="Row"  id="RowAc" colspan="2">&nbsp;</td>',c+='<td class="metl" id="pTh" onclick="pickElem(\'Th\')">Th</td>',c+='<td class="metl" id="pPa" onclick="pickElem(\'Pa\')">Pa</td>',c+='<td class="metl" id="pU"  onclick="pickElem(\'U\')" >U</td>',c+='<td class="metl" id="pNp" onclick="pickElem(\'Np\')">Np</td>',c+='<td class="metl" id="pPu" onclick="pickElem(\'Pu\')">Pu</td>',c+='<td class="metl" id="pAm" onclick="pickElem(\'Am\')">Am</td>',c+='<td class="metl" id="pCm" onclick="pickElem(\'Cm\')">Cm</td>',c+='<td class="metl" id="pBk" onclick="pickElem(\'Bk\')">Bk</td>',c+='<td class="metl" id="pCf" onclick="pickElem(\'Cf\')">Cf</td>',c+='<td class="metl" id="pEs" onclick="pickElem(\'Es\')">Es</td>',c+='<td class="metl" id="pFm" onclick="pickElem(\'Fm\')">Fm</td>',c+='<td class="metl" id="pMd" onclick="pickElem(\'Md\')">Md</td>',c+='<td class="metl" id="pNo" onclick="pickElem(\'No\')">No</td>',c+='<td class="metl" id="pLr" onclick="pickElem(\'Lr\')">Lr</td>',c+='<td class="Row"  id="RowAc2" colspan="2">&nbsp;</td>',c+="</tr></table>\n",a=$(b),a&&(a.innerHTML=c)}function Mol(a){var b,c=a||0;return"undefined"==typeof Mol.molecule&&(Mol.molecule=1),c>0&&(Mol.molecule=c,BondMatrix(c)),b=Mol.molecule,"undefined"==typeof Mol.moly&&(Mol.moly=[]),"undefined"==typeof Mol.moly[b]&&(Mol.moly[b]=[],Mol.moly[b][0]=new molObject,Mol.moly[b][0].molIndex=b,Mol.moly[b][0].numatoms=0,Mol.moly[b][0].AtomScale=1,Mol.moly[b][0].showlabels=0,Mol.moly[b][0].showcharges=0,Mol.moly[b][0].gradients=1,Mol.moly[b][0].highlite=0,Mol.moly[b][0].formula="",Mol.moly[b][0].weight=0,Mol.moly[b][0].charge=999),Mol.moly[b]}function BondMatrix(a){var b,c=a||0;return"undefined"==typeof BondMatrix.id&&(BondMatrix.id=1),c>0&&(BondMatrix.id=c),b=BondMatrix.id,"undefined"==typeof BondMatrix.bonds&&(BondMatrix.bonds=[]),"undefined"==typeof BondMatrix.bonds[b]&&(BondMatrix.bonds[b]=[]),BondMatrix.bonds[b]}function activeWin(a){var b,c,d,e,f=a||" ";if("undefined"==typeof activeWin.mol&&(activeWin.mol=[],activeWin.mol[0]="Dummy"),"undefined"==typeof activeWin.win){if(d=document.getElementsByTagName("canvas"),!d[0])return;activeWin.win=d[0].id,activeWin.mol[1]=activeWin.win}for(f.length>1&&(activeWin.win=f),c=-1,b=0;b<activeWin.mol.length;b++)activeWin.mol[b]==activeWin.win&&(c=b);return 0>c&&(c=activeWin.mol.length,activeWin.mol[c]=activeWin.win),Mol(c),e=$(activeWin.win),e&&(e.onmousedown=MouseDown,document.onmouseup=MouseUp,e.onmousemove=MouseMove,e.addEventListener("mousewheel",MouseWheel,!1),e.addEventListener("DOMMouseScroll",MouseWheel,!1),e.addEventListener("touchstart",MouseDown),e.addEventListener("touchend",MouseUp),e.addEventListener("touchmove",MouseMove)),activeWin.win}function atomObject(){this.atomicnumber=0,this.x=0,this.y=0,this.z=0,this.charge=0,this.highlite=0,this.type=""}function molObject(){this.molIndex=1,this.numatoms=0,this.AtomScale=1,this.showlabels=1,this.showcharges=0,this.gradients=1,this.highlite=0,this.hide=0,this.formula="",this.weight=0,this.charge=999}function readXYZfile(a){var b,c,d,e,f,g,h,i,j,k,l,m,n=new Array,o=new Array,p=Mol();if(delMolecule(),InfoWin("",1),d=parseInt(a[0].replace(/\s+/,"")),isNaN(d))return InfoWin("*** ERROR Reading XYZ file. ***\n"),void 0;for(o=a[1],o=o.replace(/\s+$/,""),InfoWin(o+"\n"),InfoWin("Looking for "+d+" atoms.\n"),b=2;d+2>b;b++){if(n=a[b].replace(/\s+/g," ").replace(/^\s+/,"").split(" "),e=lookupSymbol(n[0]),1>e||e>118)return InfoWin("*** ERROR Reading XYZ file. ***\n"),void 0;f=parseFloat(n[1]),g=parseFloat(n[2]),h=parseFloat(n[3]),addAtom(e,f,g,h),InfoWin(" "+n[0]+"("+e+")  "+f+", "+g+", "+h+"\n")}for(b=1;d>b;b++)for(c=b+1;d>=c;c++)m=1.2*(element(p[b].atomicnumber,"radius")+element(p[c].atomicnumber,"radius")),i=p[b].x-p[c].x,j=p[b].y-p[c].y,k=p[b].z-p[c].z,l=Math.sqrt(i*i+j*j+k*k),m>=l&&addBond(b,c);formula(),InfoWin("Finished reading XYZ input file.\n")}function readMOLfile(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o=new Array;for(Mol(),l=escape(a.name),InfoWin("File Name = "+l,1),InfoWin("\nFile Type = "+a.type),InfoWin("\nFile Size = "+a.size),delMolecule(),o=b[0],o=o.replace(/\s+$/,""),m=parseFloat(b[3].substr(0,3)),n=parseFloat(b[3].substr(3,3)),InfoWin("\n\n"+o),InfoWin("\n"+m+" atoms and "+n+" bonds."),d=m+4,c=4;d>c;c++)e=parseFloat(b[c].substr(0,10)),f=parseFloat(b[c].substr(10,10)),g=parseFloat(b[c].substr(20,10)),k=b[c].substr(31,3),k=k.replace(/\s+/,""),j=lookupSymbol(k),InfoWin("\n   "+k+"("+j+")  "+e+", "+f+", "+g),addAtom(j,e,f,g);for(d=4+m+n,c=4+m;d>c;c++)h=parseFloat(b[c].substr(0,3)),i=parseFloat(b[c].substr(3,3)),InfoWin("\n   Bond from "+h+" to "+i),addBond(h,i);formula(),setATP()}function readINPfile(a){var b,c,d,e,f,g,h=new Array,i=Mol();for(InfoWin("--- Reading Gamess input file ---\n",1),delMolecule(),b=0,a[b].toLowerCase();a[b].toLowerCase().indexOf("$data")<0;)b++;for(b++,h=a[b],h=h.replace(/\s+$/,""),InfoWin("\n\nTitle: ["+h+"]\n"),b++,a[b].toLowerCase().indexOf("c1")<0&&b++,b++;a[b].toLowerCase().indexOf("$end")<0;)InfoWin("   Line = ["+a[b]+"]\n"),current=a[b].replace(/\s+/g," ").replace(/^\s+/,"").split(" "),g=parseInt(current[1]),d=parseFloat(current[2]),e=parseFloat(current[3]),f=parseFloat(current[4]),addAtom(g,d,e,f),b++;for(b=1;b<i[0].numatoms;b++)for(ra=element(i[b].atomicnumber,"radius"),c=b+1;c<=i[0].numatoms;c++)rb=element(i[b].atomicnumber,"radius"),r=.9*distance(i,b,c),ra+rb>=r&&addBond(b,c);InfoWin("Finished reading input file.\n"),formula()}function lookupSymbol(a){var b;for(b=1;b<element(1,"max");b++)if(element(b,"symbol")==a)return b;return 0}function delMolecule(){var a=Mol();a[0]=new molObject,a[0].molIndex=1,a[0].numatoms=0,a[0].AtomScale=1,a[0].showlabels=0,a[0].showcharges=0,buttonColor("ChargeButton",0)}function Undo(a){var b,c,d=10,e=Mol(),f=BondMatrix();if("undefined"==typeof Undo.num)for(Undo.num=0,Undo.mol=[],Undo.bonds=[],b=0;d>b;b++)Undo.mol[b]=[],Undo.mol[b][0]=0,Undo.bonds[b]=[];if("save"==a){for(c=Undo.num,Undo.mol[c]=null,Undo.mol[c]=[],Undo.mol[c][0]=e[0].numatoms,b=1;b<=e[0].numatoms;b++)Undo.mol[c][b]=new atomObject,Undo.mol[c][b].atomicnumber=e[b].atomicnumber,Undo.mol[c][b].x=e[b].x,Undo.mol[c][b].y=e[b].y,Undo.mol[c][b].z=e[b].z,Undo.mol[c][b].bonds=[],Undo.mol[c][b].charge=e[b].charge,Undo.mol[c][b].highlite=e[b].highlite;for(Undo.bonds[c]=null,Undo.bonds[c]=[],b=1;b<=e[0].numatoms;b++)for(Undo.bonds[c][b]=[],j=0;j<=e[0].numatoms;j++)Undo.bonds[c][b][j]=f[b][j];return Undo.num=(Undo.num+1)%d,void 0}if("pop"==a&&(Undo("save"),c=(Undo.num+d-2)%d,Undo.num=c,Undo.mol[c][0]<1))return alert("ERROR: No saved coordinates to restore."),void 0;if("redo"==a&&(c=(Undo.num+1)%d,Undo.num=c,Undo.mol[c][0]<1))return alert("ERROR: No saved coordinates to restore."),void 0;if("redo"==a||"pop"==a){for(e[0].numatoms=Undo.mol[c][0],b=1;b<=Undo.mol[c][0];b++)e[b].atomicnumber=Undo.mol[c][b].atomicnumber,e[b].x=Undo.mol[c][b].x,e[b].y=Undo.mol[c][b].y,e[b].z=Undo.mol[c][b].z,e[b].charge=Undo.mol[c][b].charge,e[b].highlite=Undo.mol[c][b].highlite;for(b=1;b<=e[0].numatoms;b++)for(j=0;j<=e[0].numatoms;j++)f[b][j]=Undo.bonds[c][b][j];return centerMolecule(),drawMolecule(),void 0}}function addAtom(a,b,c,d){var e,f,g=Mol(),h=BondMatrix();for(g[0].numatoms++,f=g[0].numatoms,g[0].showcharges=0,buttonColor("ChargeButton",0),g[f]=new atomObject,g[f].atomicnumber=a,g[f].x=b,g[f].y=c,g[f].z=d,g[f].charge=0,g[f].highlite=0,"undefined"==typeof h[f]&&(h[f]=[]),h[f][0]=0,e=1;f>=e;e++)h[e][f]=0,h[f][e]=0}function addBond(a,b){var c,d=Mol();d[0].numatoms,c=BondMatrix(),c[a][0]++,c[a][b]=1,c[b][0]++,c[b][a]=1}function delAtom(a){var b,c,d,e,f=0,g=new Array,h=Mol(),i=BondMatrix();for(h[0].showcharges=0,buttonColor("ChargeButton",0),e=a,b=1;a>b;b++)i[a][b]>0&&1==h[b].atomicnumber&&(g[f++]=b,e--);for(b=a+1;b<=h[0].numatoms;b++)i[a][b]>0&&1==h[b].atomicnumber&&(g[f++]=b);for(g.sort(function(a,b){return b-a}),b=0;f>b;b++)delAtom(g[b]);for(a=e,b=a;b<h[0].numatoms;b++)c=b+1,h[b].atomicnumber=h[c].atomicnumber,h[b].x=h[c].x,h[b].y=h[c].y,h[b].z=h[c].z,h[b].charge=h[c].charge,h[b].highlite=h[c].highlite;for(h[0].numatoms--,d=h[0].numatoms,b=1;a>b;b++){for(i[b][a]>0&&i[b][0]--,c=a;d>=c;c++)i[b][c]=i[b][c+1];i[b][d+1]=0}for(b=a;d>=b;b++){for(i[b+1][a]>0&&i[b+1][0]--,c=0;a>c;c++)i[b][c]=i[b+1][c];for(c=a;d>=c;c++)i[b][c]=i[b+1][c+1];i[b][d+1]=0}for(b=0;d+1>=b;b++)i[d+1][b]=0;drawMolecule()}function delBond(a,b){var c=BondMatrix();c[a][b]>0&&(c[a][b]=0,c[a][0]--),c[b][a]>0&&(c[b][a]=0,c[b][0]--)}function hideH(){var a,b=Mol();for(a=1;a<=b[0].numatoms;a++)1==b[a].atomicnumber&&(b[a].hide=1);drawMolecule()}function showAll(){var a,b=Mol();for(a=1;a<b[0].numatoms;a++)b[a].hide=0}function centerMolecule(){var a,b,c,d=0,e=activeWin(""),f=Mol(),g=$(e),h=g.height,i=0,j=0,k=0,l=f[0].numatoms;for(a=1;l>=a;a++)i+=f[a].x,j+=f[a].y,k+=f[a].z;for(i/=l,j/=l,k/=l,d=0,a=1;l>=a;a++)b=f[a].atomicnumber,f[a].x-=i,f[a].y-=j,f[a].z-=k,c=Math.abs(f[a].x),c=Math.max(c,Math.abs(f[a].y)),c=Math.max(c,Math.abs(f[a].z)),c+=element(b,"radius"),d=Math.max(d,c);f[0].AtomScale=.5*h/d}function showGlobal(){var a,b=Mol();for(InfoWin("numatoms = "+b[0].numatoms,1),InfoWin("\nAtomScale = "+b[0].AtomScale.toFixed(6)),InfoWin("\n"),a=1;a<=b[0].numatoms;a++)A=b[a].atomicnumber,InfoWin(a+"  "+element(A,"symbol")),InfoWin(" ("+b[a].x.toFixed(4)),InfoWin(", "+b[a].y.toFixed(4)),InfoWin(", "+b[a].z.toFixed(4)),InfoWin(")\n")}function showCoord(a){var b,c,d=Mol();
if(BondMatrix(),!(d[0].weight<=0)){for(a=0,a&&(InfoWin("Molecular Coordinates and Bond Information\n",1),InfoWin("   "+d[0].formula+"  ("+d[0].weight.toFixed(2)+" g/mol)"),999!=d[0].charge&&0!=d[0].charge&&InfoWin("   Charge = "+d[0].charge),InfoWin("\n")),c="",b=1;b<=d[0].numatoms;b++)c+="<tr><td>"+element(d[b].atomicnumber,"symbol")+"</td><td>"+XYZpretty(d[b].x)+"</td><td>"+XYZpretty(d[b].y)+"</td><td>"+XYZpretty(d[b].z)+"</td><td>"+d[b].type+"</td></tr>";InfoWin(c,1)}}function XYZpretty(a){var b="    ",c=new Array;return c=a>=100?b+" "+a.toFixed(4):a>=10?b+"  "+a.toFixed(4):a>=0?b+"   "+a.toFixed(4):a>=-10?b+"  "+a.toFixed(4):a>=-100?b+" "+a.toFixed(4):b+a.toFixed(4)}function formula(){var a,b,c,d,e,f,g=new Array,h="Formula: ",i=Mol();if(!(i[0].numatoms<1)){for(e=0,a=1;a<=i[0].numatoms;a++)6==i[a].atomicnumber&&(g[e]=[],g[e][0]=6,g[e][1]=0,e++,a=i[0].numatoms+1);for(a=1;a<=i[0].numatoms;a++)1==i[a].atomicnumber&&(g[e]=[],g[e][0]=1,g[e][1]=0,e++,a=i[0].numatoms+1);for(a=1;a<=i[0].numatoms;a++){for(c=i[a].atomicnumber,d=0,b=0;e>b;b++)g[b][0]==c&&(g[b][1]++,d=1,b=e);0==d&&(g[e]=new Array(2),g[e][0]=i[a].atomicnumber,g[e][1]=1,e++)}for(f=0,i[0].formula="",a=0;e>a;a++)c=g[a][0],f+=element(c,"mass")*g[a][1],h+=element(c,"symbol"),i[0].formula+=element(c,"symbol"),g[a][1]>1&&(h+="<sub>"+g[a][1]+"</sub>",i[0].formula+=g[a][1]+" ");h+="  Weight: "+f,i[0].weight=f,$("formula")&&($("formula").innerHTML=h),f>0&&InfoWin(i[0].formula+" has a molecular weight of "+f.toFixed(2)+"\n")}}function RotateMolecule(a){var b=20;if(a=a[0].toLowerCase(),"x"==a||"y"==a||"z"==a||"s"==a)switch("undefined"==typeof RotateMolecule.RX&&(RotateMolecule.RX=0,RotateMolecule.RY=0,RotateMolecule.RZ=0),a){case"x":0==RotateMolecule.RX?(RotateMolecule.RX=1,RotateX_ID=setInterval("rotateX()",b),buttonColor("rotateX",1)):(RotateMolecule.RX=0,clearInterval(RotateX_ID),buttonColor("rotateX",0));break;case"y":0==RotateMolecule.RY?(RotateMolecule.RY=1,RotateY_ID=setInterval("rotateY()",b),buttonColor("rotateY",1)):(RotateMolecule.RY=0,clearInterval(RotateY_ID),buttonColor("rotateY",0));break;case"z":0==RotateMolecule.RZ?(RotateMolecule.RZ=1,RotateZ_ID=setInterval("rotateZ()",b),buttonColor("rotateZ",1)):(RotateMolecule.RZ=0,clearInterval(RotateZ_ID),buttonColor("rotateZ",0));break;case"s":0!=RotateMolecule.RX&&(RotateMolecule.RX=0,clearInterval(RotateX_ID)),0!=RotateMolecule.RY&&(RotateMolecule.RY=0,clearInterval(RotateY_ID)),0!=RotateMolecule.RZ&&(RotateMolecule.RZ=0,clearInterval(RotateZ_ID)),buttonColor("rotateX",0),buttonColor("rotateY",0),buttonColor("rotateZ",0)}}function rotateX(){var a,b,c,d=1,e=Math.cos(-d*Math.PI/180),f=Math.sin(-d*Math.PI/180),g=Mol();for(a=1;a<=g[0].numatoms;a++)b=g[a].y,c=g[a].z,g[a].y=e*b+f*c,g[a].z=-f*b+e*c;drawMolecule()}function rotateY(){var a,b,c,d=1,e=Math.cos(-d*Math.PI/180),f=Math.sin(-d*Math.PI/180),g=Mol();for(a=1;a<=g[0].numatoms;a++)b=g[a].x,c=g[a].z,g[a].x=e*b+f*c,g[a].z=-f*b+e*c;drawMolecule()}function rotateZ(){var a,b,c,d=1,e=Math.cos(-d*Math.PI/180),f=Math.sin(-d*Math.PI/180),g=Mol();for(a=1;a<=g[0].numatoms;a++)b=g[a].x,c=g[a].y,g[a].x=e*b+f*c,g[a].y=-f*b+e*c;drawMolecule()}function drawMolecule(){var a,b,c,d,e,f,g,h,i=BondMatrix(),j=Mol(),k=j[0].numatoms,l=.5,m=2,n=activeWin(""),o=$(n);if(o){if(d=o.getContext("2d"),e=o.width,f=o.height,g=o.width/2,h=o.height/2,clear(d,e,f),d.strokeStyle="rgb(0, 0, 255)",d.lineWidth=3,"undefined"==typeof drawMolecule.deep&&(drawMolecule.deep=[]),drawMolecule.deep.length!=k)for(b=0,drawMolecule.deep=[],a=drawMolecule.deep.length;k>a;a++)b++,drawMolecule.deep[a]=[],drawMolecule.deep[a]["id"]=b,drawMolecule.deep[a]["sz"]=j[b].z;for(a=0;k>a;a++)b=drawMolecule.deep[a].id,drawMolecule.deep[a].z=j[b].z;for(drawMolecule.deep.sort(function(a,b){return b.z-a.z}),k>m&&(j[0].gradients=0),a=0;k>a;a++)if(atom=drawMolecule.deep[a].id,!j[atom].hide)for(j[0].gradients?drawAtom(d,atom,l,g,h):drawAtomPlain(d,atom,l,g,h),0!=j[0].showcharges&&DrawChargeCloud(d,atom,1.5*l,g,h),0!=j[atom].highlite&&DrawAtomHilite(d,atom,1.5*l,g,h),b=1;k>=b;b++)if(i[atom][b]>0&&b!=atom&&!j[b].hide)for(c=a+1;k>c;c++)drawMolecule.deep[c].id==b&&drawBond(d,atom,b,l,g,h,j[0].gradients)}}function showLabels(){var a=Mol();return 0==a[0].showlabels?(buttonColor("LabelButton",1),a[0].showlabels=1,drawMolecule(),void 0):(buttonColor("LabelButton",0),a[0].showlabels=0,drawMolecule(),void 0)}function drawAtom(a,b,c,d,e){var f,g,h,i,j,k,l,m=Mol();activeWin(""),f=m[b].atomicnumber,g=m[0].AtomScale*m[b].x+d,h=m[0].AtomScale*m[b].y+e,i=m[0].AtomScale*c*element(f,"radius"),j=g-.2*i,k=h-.2*i,l=.3*i,g=Math.floor(g+.5),h=Math.floor(h+.5),i=Math.floor(i+.5),j=Math.floor(j+.5),k=Math.floor(k+.5),AtomColor=a.createRadialGradient(j,k,l,g,h,i),AtomColor.addColorStop(0,element(f,"color")),AtomColor.addColorStop(1,element(f,"gradient")),a.beginPath(),a.arc(g,h,i,0,2*Math.PI,!1),a.fillStyle=AtomColor,a.fill(),a.lineWidth=.01,a.strokeStyle="black",a.stroke(),a.closePath(),0!=m[0].showlabels&&atomLabel(a,f,b,g,h)}function drawAtomPlain(a,b,c,d,e){var f,g,h,i,j,k,l,m=Mol();activeWin(""),f=m[b].atomicnumber,g=m[0].AtomScale*m[b].x+d,h=m[0].AtomScale*m[b].y+e,i=m[0].AtomScale*c*element(f,"radius"),j=g-.2*i,k=h-.2*i,l=.3*i,g=Math.floor(g+.5),h=Math.floor(h+.5),i=Math.floor(i+.5),j=Math.floor(j+.5),k=Math.floor(k+.5),a.beginPath(),a.arc(g,h,i,0,2*Math.PI,!1),a.fillStyle=element(f,"color"),a.fill(),a.lineWidth=1,a.strokeStyle="black",a.stroke(),a.closePath(),0!=m[0].showlabels&&atomLabel(a,f,b,g,h)}function DrawChargeCloud(a,b,c,d,e){var f,g,h,i,j,k,l,m,n,o=Mol();activeWin(""),f=o[b].atomicnumber,g=o[0].AtomScale*o[b].x+d,h=o[0].AtomScale*o[b].y+e,i=o[0].AtomScale*c*element(f,"radius"),n=o[b].charge,n>=0&&(m=n>1?1:n,j=0,l=0,k=255),0>n&&(m=-1>n?1:-n,j=255,l=0,k=0),AtomColor="rgba("+j+","+l+","+k+","+m+")",a.beginPath(),a.arc(g,h,i,0,2*Math.PI,!1),a.fillStyle=AtomColor,a.fill(),a.lineWidth=.01,a.strokeStyle="black",a.stroke(),a.closePath()}function DrawAtomHilite(a,b,c,d,e){var f,g,h,i,j=Mol();activeWin(""),f=j[b].atomicnumber,g=j[0].AtomScale*j[b].x+d,h=j[0].AtomScale*j[b].y+e,i=j[0].AtomScale*c*element(f,"radius"),AtomColor="rgba(255,255,0,0.5)",a.beginPath(),a.arc(g,h,i,0,2*Math.PI,!1),a.fillStyle=AtomColor,a.fill(),a.lineWidth=.01,a.strokeStyle="black",a.stroke(),a.closePath()}function atomLabel(a,b,c,d,e){var f,g=element(b,"symbol")+c,h=14,i=parseFloat(d),j=parseFloat(e)+h/2,k=Mol();a.lineWidth=1,a.textAlign="center",a.font="normal "+h+"px sans-serif",a.fillStyle=element(b,"label"),a.beginPath(),a.fillText(g,i,j),f=10/k[0].AtomScale,a.fillRect(i,j,1.5*f,f),a.closePath()}function drawBond(a,b,c,d,e,f,g){var h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x=Mol();activeWin(""),u=x[0].AtomScale,v=Math.floor(.1*u+.5),w="rgb(200,128,51)",t=u*d*element(x[b].atomicnumber,"radius")-2,h=u*x[b].x+e,i=u*x[b].y+f,j=u*x[b].z,k=u*x[c].x+e,l=u*x[c].y+f,m=u*x[c].z,g||(a.beginPath(),a.moveTo(q,r),a.lineTo(k,l),a.lineWidth=v,a.strokeStyle=w,a.stroke(),a.closePath()),n=k-h,o=l-i,p=m-j,s=Math.sqrt(n*n+o*o+p*p),q=h+t*n/s,r=i+t*o/s,a.beginPath(),a.moveTo(q,r),a.lineTo(k,l),a.lineWidth=v+2,a.strokeStyle="rgb(0,0,0)",a.stroke(),a.moveTo(q,r),a.lineTo(k,l),a.lineWidth=v,a.strokeStyle=w,a.stroke(),a.closePath()}function clear(a,b,c){a.fillStyle="rgb(255,255,255)",a.fillRect(0,0,b,c),a.beginPath(),a.rect(1,1,b-1,c-1),a.lineWidth=2,a.strokeStyle="rgb(95,95,127)",a.stroke(),a.closePath()}function drawHighlight(a,b,c,d,e){var f,g,h,i,j=Mol(),k=BondMatrix(),l=$(a),m=l.getContext("2d"),n=l.width,o=l.height;if(clear(m,n,o),m.strokeStyle="rgb(0, 0, 255)",m.lineWidth=3,"undefined"==typeof drawHighlight.deep&&(drawHighlight.deep=[]),drawHighlight.deep.length!=j[0].numatoms)for(g=0,drawHighlight.deep=[],f=drawHighlight.deep.length;f<j[0].numatoms;f++)g++,drawHighlight.deep[f]=[],drawHighlight.deep[f]["id"]=g,drawHighlight.deep[f]["sz"]=j[g].z;for(f=0;f<j[0].numatoms;f++)g=drawHighlight.deep[f].id,drawHighlight.deep[f].z=j[g].z;for(drawHighlight.deep.sort(function(a,b){return b.z-a.z}),f=0;f<j[0].numatoms;f++){for(atom=drawHighlight.deep[f].id,hilite=0,ih=1;ih<=3*b[0];ih++)atom==b[ih]&&(hilite=1);for(HighlightAtom(m,atom,hilite,c,d,e),i=1;i<=j[0].numatoms;i++)if(k[atom][i]>0){if(highbond=0,hilite>0)for(ih=1;ih<3*b[0];ih++)i==b[ih]&&(highbond=1);for(h=f+1;h<j[0].numatoms;h++)drawHighlight.deep[h].id==i&&HighlightBond(m,atom,i,highbond,c,d,e)}}}function HighlightAtom(a,b,c,d,e,f){var g,h,i,j,k,l,m,n,o,p,q=new Array,r="rgb(255,  0,  0)",s="rgb(127,  0,  0)",t=Mol();activeWin(""),g=t[b].atomicnumber,h=t[0].AtomScale*t[b].x+e,i=t[0].AtomScale*t[b].y+f,j=t[0].AtomScale*d*element(g,"radius"),k=h-.2*j,l=i-.2*j,m=.3*j,h=Math.floor(h+.5),i=Math.floor(i+.5),j=Math.floor(j+.5),k=Math.floor(k+.5),l=Math.floor(l+.5),AtomColor=a.createRadialGradient(k,l,m,h,i,j),alpha=.33,c>0&&(alpha=1),n=element(g,"color").indexOf("(")+1,o=element(g,"color").indexOf(")")-n,p=element(g,"color").substr(n,o),q=p.replace(/,/g," ").split(" "),r="rgba("+q[0]+","+q[1]+","+q[2]+","+alpha+")",n=element(g,"gradient").indexOf("(")+1,o=element(g,"gradient").indexOf(")")-n,p=element(g,"gradient").substr(n,o),q=p.replace(/,/g," ").split(" "),s="rgba("+q[0]+","+q[1]+","+q[2]+","+alpha+")",AtomColor.addColorStop(0,r),AtomColor.addColorStop(1,s),a.beginPath(),a.arc(h,i,j,0,2*Math.PI,!1),a.fillStyle=AtomColor,a.fill(),a.lineWidth=.01,a.strokeStyle="black",a.stroke(),a.closePath(),c>0&&atomLabel(a,g,b,h,i)}function HighlightBond(a,b,c,d,e,f,g){var h,i,j,k,l,m,n,o,p,q,r,s,t,u=y[0].AtomScale,v=Math.floor(.1*u+.5),w="rgba(200,128,51,1.0)",x="rgba(191,191,191,0.33)",y=Mol();activeWin(""),t=u*e*element(y[b].atomicnumber,"radius"),h=u*y[b].x+f,i=u*y[b].y+g,j=u*y[b].z,k=u*y[c].x+f,l=u*y[c].y+g,m=u*y[c].z,n=k-h,o=l-i,p=m-j,s=Math.sqrt(n*n+o*o+p*p),q=h+t*n/s,r=i+t*o/s,a.beginPath(),a.moveTo(q,r),a.lineTo(k,l),a.lineWidth=v+2,a.strokeStyle="rgba(0,0,0,0.33)",d>0&&(a.strokeStyle="rgba(0,0,0,1.0)"),a.stroke(),a.moveTo(q,r),a.lineTo(k,l),a.lineWidth=v,a.strokeStyle=d>0?w:x,a.stroke(),a.closePath()}function mouseState(a,b){return"undefined"==typeof mouseState.DownAtom&&(mouseState.DownAtom=-1),"Show"==a?mouseState.DownAtom:("Set"==a&&(mouseState.DownAtom=b),void 0)}function parameters(){return"undefined"==typeof parameters.values&&(parameters.values=new paramObject),"undefined"==typeof parameters.values.mode&&(parameters.values.mode="View"),"undefined"==typeof parameters.values.elem&&(parameters.values.elem="C"),"undefined"==typeof parameters.values.clouds&&(parameters.values.clouds=4),"undefined"==typeof parameters.values.add&&(parameters.values.add="Add"),"undefined"==typeof parameters.values.bond&&(parameters.values.bond="Add"),parameters.values}function paramObject(){this.mode="View",this.element="C",this.clouds=4,this.bondmode="Add",this.atommode="Add"}function MouseDown(a){var b=a.target.id,c=activeWin(b),d=$(c),e=d.width,f=d.height,g=a.pageX,h=a.pageY;a.targetTouches&&1==a.targetTouches.length&&(g=a.targetTouches[0].pageX,h=a.targetTouches[0].pageY),mouseState("Set",onAtom(g,h,d,e,f))}function MouseUp(a){var b,c=activeWin(""),d=Mol(),e=$(c),f=e.width,g=e.height,h=parameters(),i=a.pageX,j=a.pageY;return a.targetTouches&&(i=a.targetTouches[0].pageX,j=a.targetTouches[0].pageY),b=mouseState("Show"),mouseState("Set",-1),Upatom=onAtom(i,j,e,f,g),0==Upatom?(viewGeom(0),void 0):(Upatom==b&&("View"==h.mode&&(a.shiftKey>0?(d[Upatom].highlite=(d[Upatom].highlite+1)%2,drawMolecule()):viewGeom(b)),"Draw"==h.mode&&(Undo("save"),d[0].charge=999,"Delete"==h.atommode?delAtom(Upatom):newAtom(Upatom))),Upatom!=b&&"Draw"==h.mode&&(Undo("save"),"Add"==h.bondmode&&(d[0].charge=999,addBond(b,Upatom)),"Delete"==h.bondmode&&(d[0].charge=999,delBond(b,Upatom)),"Rotate"==h.bondmode&&BondRotation("Set",b,Upatom),drawMolecule()),void 0)}function onAtom(a,b,c,d,e){var f,g,h,i,j,k,l=.5,m=Mol();for(a=a-c.offsetLeft-d/2,b=b-c.offsetTop-e/2,f=1;f<=m[0].numatoms;f++)if(g=m[f].atomicnumber,j=m[0].AtomScale*l*element(g,"radius"),j*=j,h=m[0].AtomScale*m[f].x-a,i=m[0].AtomScale*m[f].y-b,k=h*h+i*i,j>=k)return f;return 0}function MouseWheel(a){var b,c,d=Mol();return a.preventDefault&&a.preventDefault(),b=a.detail?-1*a.detail:a.wheelDelta,c=b>0?1.1:.9,d[0].AtomScale=d[0].AtomScale*c,drawMolecule(),!1}function MouseMove(a){var b,c,d,e,f,g,h,j,k,l,m,n,o,p,q,r,s=2,t=Mol(),u=parameters();if("undefined"==typeof MouseMove.cx&&(MouseMove.cx=250),"undefined"==typeof MouseMove.cy&&(MouseMove.cy=250),0==mouseState("Show")){if(b=a.pageX,c=a.pageY,a.targetTouches&&1==a.targetTouches.length&&(b=a.targetTouches[0].pageX,c=a.targetTouches[0].pageY),d=MouseMove.cx-b,e=MouseMove.cy-c,MouseMove.cx=b,MouseMove.cy=c,Math.abs(d)+Math.abs(e)>10)return;if("Rotate"==u.bondmode)return h=d+e,BondRotation("Rotate",h),drawMolecule(),void 0;if(a.shiftKey>0){for(o=Math.cos(d*s*Math.PI/180),r=Math.sin(d*s*Math.PI/180),i=1;i<=t[0].numatoms;i++)j=t[i].x,k=t[i].y,t[i].x=o*j+r*k,t[i].y=-r*j+o*k;return drawMolecule(),void 0}if(a.ctrlKey>0){for(f=.01*d,g=.01*e,i=1;i<=t[0].numatoms;i++)j=t[i].x,k=t[i].y,t[i].x=j-f,t[i].y=k-g;return drawMolecule(),void 0}for(m=Math.cos(e*s*Math.PI/180),p=Math.sin(e*s*Math.PI/180),n=Math.cos(d*s*Math.PI/180),q=Math.sin(d*s*Math.PI/180),i=1;i<=t[0].numatoms;i++)j=t[i].x,k=t[i].y,l=t[i].z,t[i].x=n*j+q*l,t[i].y=-p*q*j+m*k+p*n*l,t[i].z=-m*q*j-p*k+m*n*l;drawMolecule()}}function viewGeom(a){var b,c,d,e,f,g,h,i,j,k,l,m=activeWin(""),n=$(m),o=n.getContext("2d"),p=n.width;if(n.height,l=Mol(),"undefined"==typeof viewGeom.geom&&(viewGeom.geom=[0,0,0,0,0]),0==a){for(b=0;5>b;b++)viewGeom.geom[b]=0;return drawMolecule(),void 0}if(a)for(b=1;5>b;b++)viewGeom.geom[b]==a&&viewGeom(0);switch(viewGeom.geom[0]=viewGeom.geom[0]+1,sw=viewGeom.geom[0],viewGeom.geom[sw]=a,InfoWin("Mouse on atom #"+a+"   Switch = "+sw,1),sw){case 1:for(b=l[0].numatoms;b--;)l[b].highlite=0;l[viewGeom.geom[1]].highlite=1,drawMolecule(),showType(viewGeom.geom[1]);break;case 20:g=l[viewGeom.geom[1]].x-l[viewGeom.geom[2]].x,h=l[viewGeom.geom[1]].y-l[viewGeom.geom[2]].y,i=l[viewGeom.geom[1]].z-l[viewGeom.geom[2]].z,j=Math.sqrt(g*g+h*h+i*i),j=j.toFixed(3),j=j.toString(),c=l[viewGeom.geom[1]].atomicnumber,d=l[viewGeom.geom[2]].atomicnumber,k=element(c,"symbol")+viewGeom.geom[1].toString()+"--",k+=element(d,"symbol")+viewGeom.geom[2].toString(),k+=" = "+j,drawMolecule(),geomLabel(o,k,p);break;case 30:c=l[viewGeom.geom[1]].atomicnumber,d=l[viewGeom.geom[2]].atomicnumber,e=l[viewGeom.geom[3]].atomicnumber,k=element(c,"symbol")+viewGeom.geom[1].toString()+"--",k+=element(d,"symbol")+viewGeom.geom[2].toString()+"--",k+=element(e,"symbol")+viewGeom.geom[3].toString(),ang=angle(l,viewGeom.geom[1],viewGeom.geom[2],viewGeom.geom[3]),ang=ang.toFixed(1),ang=ang.toString(),k+=" = "+ang+"ᵒ",drawMolecule(),geomLabel(o,k,p);break;case 40:for(c=l[viewGeom.geom[1]].atomicnumber,d=l[viewGeom.geom[2]].atomicnumber,e=l[viewGeom.geom[3]].atomicnumber,f=l[viewGeom.geom[4]].atomicnumber,k=element(c,"symbol")+viewGeom.geom[1].toString()+"--",k+=element(d,"symbol")+viewGeom.geom[2].toString()+"--",k+=element(e,"symbol")+viewGeom.geom[3].toString()+"--",k+=element(f,"symbol")+viewGeom.geom[4].toString(),ang=dihedral(l,viewGeom.geom[1],viewGeom.geom[2],viewGeom.geom[3],viewGeom.geom[4]),ang=ang.toFixed(1),ang=ang.toString(),k+=" = "+ang,drawMolecule(),geomLabel(o,k,p),b=0;5>b;b++)viewGeom.geom[b]=0}}function geomLabel(a,b,c){a.lineWidth=1,a.textAlign="right",a.textBaseline="top",a.font="normal 18px sans-serif",a.fillStyle="#000000",a.beginPath(),a.fillText(b,c-5,5),a.closePath()}function pickElem(a){var b,c,d,e=element(1,"max"),f=parameters(),g="silver",h="lightskyblue";for("undefined"==typeof pickElem.metals&&(pickElem.metals="none",pickElem.myfont="14px",$("pchooser")&&($("pchooser").innerHTML="Metals")),"PView"==a&&$("pchooser")&&("Metals"==$("pchooser").innerHTML?(pickElem.metals="table-cell",pickElem.myfont="10px",$("pchooser").innerHTML="Organic"):(pickElem.metals="none",pickElem.myfont="14px",$("pchooser").innerHTML="Metals")),$("Row1")&&($("Row1").style.display=pickElem.metals),$("Row2")&&($("Row2").style.display=pickElem.metals),$("Row3")&&($("Row3").style.display=pickElem.metals),$("RowLa")&&($("RowLa").style.display=pickElem.metals),$("RowAc")&&($("RowAc").style.display=pickElem.metals),$("RowLa2")&&($("RowLa2").style.display=pickElem.metals),$("RowAc2")&&($("RowAc2").style.display=pickElem.metals),b=1;e>b;b++)delete d,c="m"+element(b,"symbol"),$(c)&&(d=$(c).style),c="p"+element(b,"symbol"),$(c)&&(d=$(c).style,d.display=pickElem.metals),d&&(d.backgroundColor=g,d.fontSize=pickElem.myfont,element(b,"symbol")==a&&(d.backgroundColor=h));return buttonColor("delbtn",0),buttonColor("delbond",0),buttonColor("rotbond",0),"Delete"==a?(buttonColor("delbtn",1),f.atommode="Delete",void 0):"DelBond"==a?(buttonColor("delbond",1),f.bondmode="Delete",void 0):"RotateBond"==a?("Rotate"!=f.bondmode?(buttonColor("rotbond",1),f.bondmode="Rotate"):(f.bondmode="",BondRotation("Clear")),void 0):(f.element=a,f.atommode="Add",f.bondmode="Add",void 0)}function pickClouds(a){var b,c,d=parseInt(a),e=parameters();for(b=1;5>b;b++)c="cld"+b,buttonColor(c,0),b==d&&buttonColor(c,1);e.clouds=d}function drawmode(){var a=parameters();$("drawDiv")&&($("drawDiv").style.display="inline"),$("viewDiv")&&($("viewDiv").style.display="none"),buttonColor("modeDraw",1),buttonColor("modeView",0),a.mode="Draw",a.element="C",a.atommode="Add",a.bondmode="Add"}function viewmode(){var a=parameters();$("drawDiv")&&($("drawDiv").style.display="none"),$("viewDiv")&&($("viewDiv").style.display="inline"),buttonColor("modeDraw",0),buttonColor("modeView",1),a.mode="View",pickElem("ClearBond"),formula(),showCoord(1)}function BondRotation(a,b,c){var d,e,f,g,h,i,k,l,m=1,n=Mol();if("undefined"==typeof BondRotation.RotateAtom1&&(BondRotation.RotateAtom1=0),"undefined"==typeof BondRotation.RotateAtom2&&(BondRotation.RotateAtom2=0),"undefined"==typeof BondRotation.RotateList&&(BondRotation.RotateList=new Array,BondRotation.RotateList[0]=0),"Clear"==a)return BondRotation.RotateAtom1=0,BondRotation.RotateAtom2=0,BondRotation.RotateList[0]=0,void 0;if("Set"==a)return BondRotation.RotateAtom1=b,BondRotation.RotateAtom2=c,bondAlign(b,c),void 0;if("Rotate"==a){for(atom1=BondRotation.RotateAtom1,atom2=BondRotation.RotateAtom2,k=Math.cos(b*m*Math.PI/360),l=Math.sin(b*m*Math.PI/360),0==BondRotation.RotateList[0]&&(BondRotation.RotateList[0]=1,BondRotation.RotateList[1]=BondRotation.RotateAtom2,BondRotation.RotateList=rotlist(BondRotation.RotateList,atom1,atom2)),InfoWin("\n--- Bond rotation ---\n"),d=1;d<=BondRotation.RotateList[0];d++)j=BondRotation.RotateList[d],InfoWin(element(n[j].atomicnumber,"symbol")+j+"\n");for(h=n[atom1].x,i=n[atom1].y,e=1;e<=BondRotation.RotateList[0];e++)d=BondRotation.RotateList[e],f=n[d].x-h,g=n[d].y-i,n[d].x=k*f+l*g+h,n[d].y=-l*f+k*g+i}}function bondAlign(a,b){var c,d,e,f,g,h,i,j,k=Mol(),l=k[b].x-k[a].x,m=k[b].y-k[a].y,n=k[b].z-k[a].z;for(0==m&&0==n?(g=1,i=0):(g=Math.sqrt(n*n/(m*m+n*n)),i=Math.sqrt(1-g*g)),vsign=m*n,0>vsign&&(i=-i),f=i*m+g*n,0==l&&0==f?(h=1,j=0):(h=Math.sqrt(f*f/(l*l+f*f)),j=Math.sqrt(1-h*h)),vsign=l*f,0>vsign&&(j=-j),c=1;c<=k[0].numatoms;c++)d=k[c].x,e=k[c].y,f=k[c].z,k[c].x=d*h-e*i*j-f*g*j,k[c].y=e*g-f*i,k[c].z=d*j+e*i*h+f*g*h;if(k[a].z<k[b].z)for(c=1;c<=k[0].numatoms;c++)k[c].x=-k[c].x,k[c].z=-k[c].z}function rotlist(a,b,c){var d,e,f,g=Mol(),h=BondMatrix();for(e=1;e<=g[0].numatoms;e++)if(h[c][e]>0){for(f=0,e==b&&(f=1),d=1;d<=a[0];d++)e==a[d]&&(f=1,d=a[0]+1);0==f&&(a[0]++,a[a[0]]=e,rotlist(a,c,e))}return a}function setCharge(){var a=Mol(),b=$("SelectCharge");b&&(a[0].charge=1*b.value)}function simpleQ(){var a,b,c=[],d=$("bondMatrix"),e=Mol(),f=e[0].numatoms;if(1>f)return InfoWin("Cannot set charges. No atoms found.\n",1),void 0;if(0!=e[0].showcharges)return buttonColor("ChargeButton",0),e[0].showcharges=0,$("SelectCharge")&&($("SelectCharge").value=0),drawMolecule(),void 0;for(buttonColor("ChargeButton",1),e[0].showcharges=1,InfoWin("",1),d&&(d.innerHTML=""),a=0;f>=a;a++)for(c[a]=[],b=0;f>=b;b++)c[a][b]=0;for(a=1;f>=a;a++)e[a].charge=0;sigmaBonds(c),999==e[0].charge&&formalcharge(),checkcharge(c),checkOctet(c),limitShare(c),formPi(c),checkOctet(c),formDative(c),atomicCharge(c),d&&showBondMatrix(c,d),drawMolecule()}function formalcharge(){var a,b,c,d=Mol(),e=d[0].numatoms,f=BondMatrix(),g=0,h=0;for(a=1;e>=a;a++)b=0,"s"==element(d[a].atomicnumber,"block")&&(b=2),"p"==element(d[a].atomicnumber,"block")&&(b=8),b>0&&(c=f[a][0]+element(d[a].atomicnumber,"valence")-b,0>c&&(h+=c),c>0&&(g+=c));for(;-2>=h;)h+=2;d[0].charge=g+h}function checkcharge(a){var b,c,d,e,f,g,h,i,j,k,l=Mol(),m=l[0].numatoms;for(BondMatrix(),k=1e-5,e=0,b=1;m>=b;b++)for(e+=element(l[b].atomicnumber,"valence"),c=b;m>=c;c++)e-=a[b][c];if(f=e-l[0].charge,!(Math.abs(f)<k)){if(-k>f){for(i=0,b=1;b<=l[0].numatoms;b++)h=element(l[b].atomicnumber,"block"),("d"==h||"f"==h)&&i++;if(i>0)for(g=-f/i,b=1;b<=l[0].numatoms;b++)h=element(l[b].atomicnumber,"block"),("d"==h||"f"==h)&&(a[b][b]-=g);else{for(d=0,b=1;b<=l[0].numatoms;b++)a[b][b]>0&&d++;if(j=-f,d>0)for(j=0,g=-f/d,b=1;b<=l[0].numatoms;b++)a[b][b]>0&&(a[b][b]-=g,a[b][b]<0&&(j-=a[b][b],a[b][b]=0));if(j>0){for(d=0,b=1;b<=l[0].numatoms;b++)a[b][b]>0&&d++;if(d>0)for(g=j/d,b=1;b<=l[0].numatoms;b++)a[b][b]>0&&(a[b][b]-=g)}}}if(f>k){for(checkOctet(a),d=0,b=1;b<=l[0].numatoms;b++)a[b][0]>0&&d++;if(j=f,d>0){for(j=0,g=f/d,b=1;b<=l[0].numatoms;b++)a[b][0]>0&&(g<=a[b][0]?a[b][b]+=g:(a[b][b]+=a[b][0],j+=g-a[b][0],a[b][0]=0));if(j>0){for(d=0,b=1;b<=l[0].numatoms;b++)a[b][0]>0&&d++;if(d>0)for(g=j/d,j=0,b=1;b<=l[0].numatoms;b++)a[b][0]>0&&(g<=a[b][0]?a[b][b]+=g:(a[b][b]+=a[b][0],j+=g-a[b][0],a[b][0]=0))}}if(j>0){for(d=0,b=1;b<=l[0].numatoms;b++)l[b].atomicnumber>12&&d++;if(d>0)for(g=j/d,b=1;b<=l[0].numatoms;b++)l[b].atomicnumber>12&&(a[b][b]+=g)}}for(e=0,b=1;m>=b;b++)for(e+=element(l[b].atomicnumber,"valence"),c=b;m>=c;c++)e-=a[b][c];f=e-l[0].charge,Math.abs(f)>k&&(InfoWin("ERROR: Unable to assign electrons to balance charge.\n",1),InfoWin("   Assigned charge = "+l[0].charge+"\n"),InfoWin("Charge based on e- = "+e+"\n\n"))}}function sigmaBonds(a){var b,c,d,e=Mol(),f=e[0].numatoms,g=BondMatrix();for(b=1;f>b;b++)for(c=b+1;f>=c;c++)g[b][c]>0&&(a[b][c]=2,a[c][b]=2);for(b=1;f>=b;b++)d=element(e[b].atomicnumber,"valence")-g[b][0],e[b].atomicnumber<11&&g[b][0]>3&&(d=0),d>0&&(a[b][b]=d);return a}function checkOctet(a){var b,c,d,e=Mol(),f=e[0].numatoms;for(b=1;f>=b;b++){if(d=0,a[b][0]=0,"p"==element(e[b].atomicnumber,"block"))for(d=8,c=1;f>=c;c++)d-=a[b][c];d>0&&(a[b][0]=d)}return a}function limitShare(a){var b,c,d,e=Mol(),f=e[0].numatoms,g=BondMatrix();for(b=1;f>=b;b++)if(a[b][0]>0){for(d=0,c=1;f>=c;c++)g[b][c]>0&&a[c][0]>0&&d++;a[b][0]=d>0?a[b][0]/d:0}return a}function formPi(a){var b,c,d,e=Mol(),f=e[0].numatoms,g=BondMatrix();for(b=1;f>b;b++)if(a[b][0]>0)for(c=b+1;f>=c;c++)g[b][c]>0&&(d=Math.min(a[b][0],a[c][0]),d>0&&(a[b][c]+=2*d,a[c][b]+=2*d,a[b][b]-=d,a[c][c]-=d));for(b=1;f>=b;b++)a[b][b]<0&&(InfoWin("ERROR in formPi: Atom "+b+" has "+a[b][b].toFixed(3)+" lone pairs.\n"),a[b][b]=0);return a}function formDative(a){var b,c,d,e,f=new Array,g=Mol(),h=g[0].numatoms,i=BondMatrix(),j=0;for(b=1;h>=b;b++)a[b][0]>0&&(j=1);if(0!=j){for(b=1;h>=b;b++)f[b]=0;for(b=1;h>=b;b++)if(a[b][0]>0){for(d=0,c=1;h>=c;c++)i[b][c]>0&&a[c][c]>0&&d++;if(d>0)for(a[b][0]=a[b][0]/d,c=1;h>=c;c++)i[b][c]>0&&a[c][c]>0&&(f[c]+=a[b][0])}for(e=1,b=1;h>=b;b++)f[b]>a[b][b]&&(e=0);if(e>0)for(b=1;h>=b;b++)if(a[b][0]>0)for(c=1;h>=c;c++)i[b][c]>0&&f[c]>0&&(a[b][c]+=a[b][0],a[c][b]+=a[b][0],a[c][c]-=a[b][0]);return a}}function atomicCharge(a){var b,c,d,e,f,g,h,i,j=.5,k=.5,l=15,m=.001,n=0,o=new Array,p=Mol(),q=p[0].numatoms,r=BondMatrix();for(b=1;q>=b;b++)for(n+=element(p[b].atomicnumber,"valence"),c=1;q>=c;c++)n-=b==c?a[b][b]:.5*a[b][c];for(h=Math.abs(n-p[0].charge),h>.001&&alert("Error: Electron assignment does NOT match molecular charge."),f=k,Math.abs(n)>.001&&(f=1),b=1;q>=b;b++)e=p[b].atomicnumber,("d"==element(e,"block")||"f"==element(e,"block"))&&(f=0),g=element(e,"EN")||0,0==g&&(g=1,InfoWin("WARNING: No electronegativity defined for "),InfoWin(element(p[b].atomicnumber,"symbol")+"\n")),o[b]=g;for(1==f&&InfoWin("Using 100% formal charge method to calculate charges.\n"),0==f&&InfoWin("Using 100% bond polarity method to calculate charges.\n"),f==k&&InfoWin("Using mixture of formal charge and bond polarity method to calculate charges.\n"),d=0,i=100;l>d&&i>m;){for(d++,b=1;q>=b;b++){for(e=p[b].atomicnumber,g=f*(element(e,"valence")-a[b][b]),c=1;q>=c;c++)r[b][c]>0&&(g+=.5*(1-f)*a[b][c],g-=a[b][c]*o[b]/(o[b]+o[c]));p[b].charge=g}for(i=0,b=1;q>=b;b++)g=o[b],o[b]=element(p[b].atomicnumber,"EN")||1,o[b]+=j*p[b].charge,h=Math.abs(g-o[b]),h>i&&(i=h)}return a}function dipoleMoment(){var a,b,c=4.8032,d=Mol(),e=d[0].numatoms,f=0,g=0,h=0;for(a=1;e>=a;a++)f+=d[a].x*d[a].charge,g+=d[a].y*d[a].charge,h+=d[a].z*d[a].charge;return b=c*Math.sqrt(f*f+g*g+h*h)}function showBondMatrix(a,b){var c,d,e,f,g,h,i;for(new Array,new Array,h=Mol(),i=h[0].numatoms,g=0,c=1;i>=c;c++)g+=h[c].charge;for(e=dipoleMoment(),b.innerHTML="<p><strong>Molecular charge = "+g.toFixed(1)+", Dipole &approx; "+e.toFixed(1)+" D</strong>",InfoWin("Bond Matrix:  Off-diagonal = e- in bonds, diagonal = unshared e-\n"),InfoWin("      "),c=1;i>=c;c++)f=element(h[c].atomicnumber,"symbol"),f.length<2&&(f+=" "),InfoWin(" "+f+" "),0==c%5&&InfoWin(" ");for(InfoWin("\n"),c=1;i>=c;c++){for(f=element(h[c].atomicnumber,"symbol"),f.length<2&&(f+=" "),10>c&&InfoWin(" "),InfoWin(c+" "+f+" "),d=1;i>=d;d++)InfoWin(a[c][d].toFixed(1)+" "),0==d%5&&InfoWin(" ");InfoWin(" q = "),h[c].charge>0&&InfoWin("+"),InfoWin(h[c].charge.toFixed(2)+"\n"),0==c%5&&InfoWin("\n")}}function MyFileReader(a){var b,c,d=a.target.files[0];d?(c=new FileReader,c.onload=function(a){var c,e,f;return b=0,c=extension(d.name),e=a.target.result,f=e.split("\n"),"xyz"==c&&(b=1,readXYZfile(f)),"mol"==c&&(b=1,readMOLfile(d,f)),"inp"==c&&(b=1,readINPfile(d,f)),0==b?(InfoWin("*** ERROR: Invalid file type for "+d.name+". ***",1),void 0):(centerMolecule(),drawMolecule(),void 0)},c.readAsText(d)):alert("Failed to load file")}function extension(a){var b=a.substring(a.lastIndexOf(".")+1);return b.toLowerCase()}function showgallery(a,b,c,d,e){var f,g,h,i,j,k,l,m,n;if("delete"==a)return"undefined"!=typeof showgallery.num&&(showgallery.num=0,delete showgallery.list),void 0;if(!$("gallery"))return alert('Warning: showgallery called, but no <div id="gallery"></div> exists on html page.'),void 0;for("undefined"==typeof showgallery.list&&(showgallery.num=0,showgallery.list=[]),g=showgallery.num,k="gallerycanvas",j="galleryframe",h=g,f=0;f<c.length;f++)showgallery.list[h]=b+c[f],showgallery.num++,h++;for(n='width="'+e+'" height="'+e+'"></canvas>',i="",a&&(i="<h3>"+a+"</h3>\n"),h=g,f=0;f<c.length;f++)m=k+h,l=j+h,i+='<div class="galleryframe" id="'+l+'">',i+='<canvas id="'+m+'" '+n+"\n",i+='<p style="text-align: center;">',i+=d[f],i+="</p></div>\n",h++;for(i+='<p class="clear">&nbsp;</p>\n\n',$("gallery").innerHTML+=i,$("debug")&&($("debug").innerHTML+=i),px=e+"px",h=g,f=0;f<c.length;f++)l=j+h,$(l)&&($(l).style.width=px),h++;for(f=0;f<showgallery.num;f++)m=k+f,activeWin(m),delMolecule(),readServerFile(showgallery.list[f]),$("debug")&&(i="\n\nProcessed molecule "+f,i+=" named "+showgallery.list[f],$("debug").innerHTML+=i)}function galleryUniform(){for(var a,b,c="gallerycanvas",d=[],e=0,f=c+e;$(f);)e++,f=c+e;for(b=1e3,a=0;e>a;a++)f=c+a,activeWin(f),d=Mol(),d[0].AtomScale<b&&(b=d[0].AtomScale);if(1e3>b)for(a=0;e>a;a++)f=c+a,activeWin(f),d=Mol(),d[0].AtomScale=b,drawMolecule()}function galleryReset(){for(var a,b="gallerycanvas",c=0,d=b+c;$(d);)c++,d=b+c;for(a=0;c>a;a++)d=b+a,activeWin(d),centerMolecule(),drawMolecule()}function readServerFile(a){var b,c,d,e;return new Array,d=extension(a),e=new XMLHttpRequest,e.open("GET",a,!1),e.send(),b=e.responseText.split("\n"),c=0,"xyz"==d&&(c=1,readXYZfile(b)),"mol"==d&&(c=1,readMOLfile(localfile,b)),"inp"==d&&(c=1,readINPfile(localfile,b)),0==c?(InfoWin("*** ERROR: Invalid file type. ***",1),void 0):(centerMolecule(),drawMolecule(),void 0)}function InfoWin(a,b){var c=a||"",d=b||0;d>0?$("information").innerHTML=c:$("information").innerHTML+=c}function loadMolecule(){addAtom(6,-2.3362,.8535,-.0608),addAtom(6,-.7962,.854,-.0605),addAtom(1,-2.6931,1.8622,-.0609),addAtom(1,-2.6926,.349,-.9345),addAtom(1,-2.6929,.3491,.8128),addAtom(1,-.4393,-.1548,-.0604),addAtom(1,-.4395,1.3584,-.9341),addAtom(1,-.4398,1.3585,.8132),addBond(1,2),addBond(1,3),addBond(1,4),addBond(1,5),addBond(2,6),addBond(2,7),addBond(2,8),setATP()}function resetView(){var a,b=Mol();for(a=1;a<=b[0].numatoms;a++)b[a].highlite=0,b[a].hide=0;InfoWin("",1),formula(),centerMolecule(),drawMolecule()}function buttonColor(a,b){b=b||0;var c="silver";b&&(c="lightskyblue"),$(a)&&($(a).style.backgroundColor=c)}function initialize(){var a,b=activeWin(),c=$("molfile");return b?(c&&(window.File&&window.FileReader&&window.FileList&&window.Blob?c.addEventListener("change",MyFileReader,!1):alert("The File APIs are not fully supported by your browser.")),drawPeriodic(),a=Mol(),viewmode(),"undefined"==typeof a&&delMolecule(),a[0].numatoms<1&&(delMolecule(),loadMolecule(),formula(),centerMolecule()),drawMolecule(),pickClouds(4),pickElem("C"),void 0):(userDefined(),b=activeWin(""),b||alert("No canvas present. Either create a canvas or remove onLoad=initialize() statement from <body>."),void 0)}function newAtom(a){var b,c,d,e,f,g,h,i,j,k,l,m=[],n=parameters(),o=Mol(),p=BondMatrix(),q=activeWin("");if(atomicNumber=lookupSymbol(n.element),d=p[a][0],0==d)return j=element(atomicNumber,"radius")+element(o[a].atomicnumber,"radius"),dx=o[a].x+j,dy=o[a].y,dz=o[a].z,addAtom(atomicNumber,dx,dy,dz),addBond(a,o[0].numatoms),addH(o[0].numatoms),centerMolecule(),drawMolecule(q),void 0;for(k=0,b=1;b<=o[0].numatoms;b++)p[a][b]>0&&b!=a&&(m[++k]=b);if(m[0]=k,m[0]!=p[a][0]&&alert("ERROR: Supposed to be "+d+" bonds on atom "+a+", but "+k+" bonds found."),1==atomicNumber){for(e=0,f=0,g=0,b=1;d>=b;b++)c=m[b],dx=o[c].x-o[a].x,dy=o[c].y-o[a].y,dz=o[c].z-o[a].z,dd=Math.sqrt(dx*dx+dy*dy+dz*dz),e+=dx/dd,f+=dy/dd,g+=dz/dd;for(h=Math.sqrt(e*e+f*f+g*g),j=element(1,"radius")+element(o[a].atomicnumber,"radius"),e=o[a].x-e*j/h,f=o[a].y-f*j/h,g=o[a].z-g*j/h,addAtom(1,e,f,g),k=1;d>=k;k++)l=0,i=distance(o,m[k],o[0].numatoms),.2>i&&(l=1);if(l&&d>1)for(b=m[1],c=m[2],e=(o[b].y-o[a].y)*(o[c].z-o[a].z),e-=(o[b].z-o[a].z)*(o[c].y-o[a].y),f=(o[b].z-o[a].z)*(o[c].x-o[a].x),f-=(o[b].x-o[a].x)*(o[c].z-o[a].z),g=(o[b].x-o[a].x)*(o[c].y-o[a].y),g-=(o[b].y-o[a].y)*(o[c].x-o[a].x),h=Math.sqrt(e*e+f*f+g*g),o[o[0].numatoms].x=o[a].x-e*j/h,o[o[0].numatoms].y=o[a].y-f*j/h,o[o[0].numatoms].z=o[a].z-g*j/h,l=0,k=1;d>=k;k++)i=distance(o,m[k],o[0].numatoms),.2>i&&(l=1);return l?(alert("Error adding H atom"),delAtom(o[0].numatoms),void 0):(addBond(a,o[0].numatoms),centerMolecule(),drawMolecule(q),d=0,void 0)}1==d&&(b=a,c=m[1],dx=o[b].x-o[c].x,dy=o[b].y-o[c].y,dz=o[b].z-o[c].z,i=Math.sqrt(dx*dx+dy*dy+dz*dz),j=element(atomicNumber,"radius")+element(o[c].atomicnumber,"radius"),dx*=j/i,dy*=j/i,dz*=j/i,o[b].atomicnumber=atomicNumber,o[b].x=10*dx+o[c].x,o[b].y=dy+o[c].y,o[b].z=dz+o[c].z,addH(a),centerMolecule(),drawMolecule(q)),d>1&&(o[a].atomicnumber=atomicNumber,drawMolecule(q))}function addH(a){var b,c,d,e,f,g,h=parameters(),i=Mol(),j=BondMatrix(),k=activeWin("");if("p"==element(i[a].atomicnumber,"block")&&(c=h.clouds,d=i[a].atomicnumber,valence=element(d,"valence"),e=3+c-valence,1>e&&(c=1),!(1>=c))){for(f=0,b=0;0==f&&b<i[0].numatoms;)b++,j[a][b]>0&&b!=a&&(f=b);if(g=0,f)for(b=0;0==g&&b<i[0].numatoms;)b++,j[f][b]>0&&b!=a&&b!=f&&(g=b);switch(c){case 2:add1H(a,f);break;case 3:add2H(a,f,g,e);break;case 4:add3H(a,f,g,e)}centerMolecule(),drawMolecule(k)}}function add1H(a,b){var c,d,e,f,g,h,i,j=Mol(),k=j[a].atomicnumber,l=element(k,"radius")+element(1,"radius");return 0==b?(c=j[a].x+l,d=j[a].y,e=j[a].z,addAtom(1,g,h,i),addBond(a,j[0].numatoms),void 0):(c=j[b].x-j[a].x,d=j[b].y-j[a].y,e=j[b].z-j[a].z,f=Math.sqrt(c*c+d*d+e*e),g=j[a].x-c*l/f,h=j[a].y-d*l/f,i=j[a].z-e*l/f,addAtom(1,g,h,i),addBond(a,j[0].numatoms),void 0)}function add2H(a,b,c,d){var e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y=new Array,z=Mol(),A=z[a].atomicnumber,B=element(A,"radius")+element(1,"radius");
if(0==b)return t=z[a].x+.5*B,u=z[a].y+B*Math.sqrt(3)/2,v=z[a].z,addAtom(1,t,u,v),addBond(a,z[0].numatoms),d>1&&(u=z[a].y-B*Math.sqrt(3)/2,addAtom(1,t,u,v),addBond(a,z[0].numatoms)),void 0;if(e=z[b].atomicnumber,g=z[b].x-z[a].x,h=z[b].y-z[a].y,i=z[b].z-z[a].z,j=Math.sqrt(g*g+h*h+i*i),0==c)for(w=1;w<z[0].numatoms;w++)w!=a&&w!=b&&(c=w,w=z[0].numatoms);return 0==c?(z[a].x=0,z[a].y=0,z[a].z=0,z[b].x=-j,z[b].y=0,z[b].z=0,t=z[a].x+.5*B,u=z[a].y+B*Math.sqrt(3)/2,v=z[a].z,addAtom(1,t,u,v),addBond(a,z[0].numatoms),d>1&&(u=z[a].y-B*Math.sqrt(3)/2,addAtom(1,t,u,v),addBond(a,z[0].numatoms)),void 0):(f=z[c].atomicnumber,k=z[c].x-z[b].x,l=z[c].y-z[b].y,m=z[c].z-z[b].z,n=Math.sqrt(k*k+l*l+m*m),y[0]=g,y[1]=h,y[2]=i,y[3]=-B*j/2,o=(-g*k-h*l-i*m)/(j*n),o=Math.acos(-.5)+Math.PI-Math.acos(o),y[4]=k,y[5]=l,y[6]=m,y[7]=B*n*Math.cos(o),p=m*h-l*i,q=k*i-m*g,r=l*g-k*h,s=Math.sqrt(p*p+q*q+r*r),y[8]=p,y[9]=q,y[10]=r,y[11]=0,x=gaussElim(y),t=z[a].x+x[0],u=z[a].y+x[1],v=z[a].z+x[2],addAtom(1,t,u,v),addBond(a,z[0].numatoms),1!=d&&(y[0]=g,y[1]=h,y[2]=i,y[3]=-B*j/2,o=(-g*k-h*l-i*m)/(j*n),o=Math.acos(o)-Math.acos(.5),y[4]=k,y[5]=l,y[6]=m,y[7]=B*n*Math.cos(o),y[8]=p,y[9]=q,y[10]=r,y[11]=0,debug="\nRow 1: "+y[0].toFixed(4)+" "+y[1].toFixed(4),debug+=" "+y[2].toFixed(4)+" "+y[3].toFixed(4),debug+="\nRow 2: "+y[4].toFixed(4)+" "+y[5].toFixed(4),debug+=" "+y[6].toFixed(4)+" "+y[7].toFixed(4),debug+="\nRow 3: "+y[8].toFixed(4)+" "+y[9].toFixed(4),debug+=" "+y[10].toFixed(4)+" "+y[11].toFixed(4),x=gaussElim(y),t=z[a].x+x[0],u=z[a].y+x[1],v=z[a].z+x[2],debug="H2 at: ("+t.toFixed(4)+", "+u.toFixed(4)+", "+v.toFixed(4)+")",addAtom(1,t,u,v),addBond(a,z[0].numatoms),debug="atom = "+a+"  i = "+b+"  numatoms = "+z[0].numatoms,debug+="\n"+element(z[z[0].numatoms].atomicnumber,"symbol"),debug+="\nRow 1: "+y[0].toFixed(4)+" "+y[1].toFixed(4),debug+=" "+y[2].toFixed(4)+" "+y[3].toFixed(4),debug+="\nRow 2: "+y[4].toFixed(4)+" "+y[5].toFixed(4),debug+=" "+y[6].toFixed(4)+" "+y[7].toFixed(4),debug+="\nRow 3: "+y[8].toFixed(4)+" "+y[9].toFixed(4),debug+=" "+y[10].toFixed(4)+" "+y[11].toFixed(4),debug+="\nCross: "+p.toFixed(4)+" "+q.toFixed(4)+" "+r.toFixed(4)),void 0)}function add3H(a,b,c,d){var e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z=new Array,A=Mol(),B=A[a].atomicnumber,C=(A[b].atomicnumber,A[c].atomicnumber,element(B,"radius")+element(1,"radius")),D=A[b].x-A[a].x,E=A[b].y-A[a].y,F=A[b].z-A[a].z,G=Math.sqrt(D*D+E*E+F*F);z[0]=D,z[1]=E,z[2]=F,z[3]=-C*G/3,e=A[c].x-A[b].x,f=A[c].y-A[b].y,g=A[c].z-A[b].z,h=Math.sqrt(e*e+f*f+g*g),i=(-D*e-E*f-F*g)/(G*h),i=Math.acos(-1/3)+Math.PI-Math.acos(i),z[4]=e,z[5]=f,z[6]=g,z[7]=C*h*Math.cos(i),j=g*E-f*F,k=e*F-g*D,l=f*D-e*E,m=Math.sqrt(j*j+k*k+l*l),0==m&&(j=A[a].y,k=-A[a].x,l=A[a].z,m=Math.sqrt(j*j+k*k+l*l)),z[8]=j,z[9]=k,z[10]=l,z[11]=0,y=gaussElim(z),n=A[a].x+y[0],o=A[a].y+y[1],p=A[a].z+y[2],addAtom(1,n,o,p),addBond(a,A[0].numatoms),1!=d&&(x=A[0].numatoms,w=C/(3*G),t=A[a].x-D*w,u=A[a].y-E*w,v=A[a].z-F*w,z[0]=A[x].x-t,z[1]=A[x].y-u,z[2]=A[x].z-v,z[3]=4*-C*C/9,q=y[0],r=y[1],s=y[2],z[4]=A[a].x-t,z[5]=A[a].y-u,z[6]=A[a].z-v,z[7]=0,z[8]=j,z[9]=k,z[10]=l,z[11]=C*m*Math.sqrt(2/3),y=gaussElim(z),n=t+y[0],o=u+y[1],p=v+y[2],addAtom(1,n,o,p),addBond(a,A[0].numatoms),2!=d&&(z[0]=A[x].x-t,z[1]=A[x].y-u,z[2]=A[x].z-v,z[3]=4*-C*C/9,q=y[0],r=y[1],s=y[2],z[4]=A[a].x-t,z[5]=A[a].y-u,z[6]=A[a].z-v,z[7]=0,m=Math.sqrt(j*j+k*k+l*l),z[8]=j,z[9]=k,z[10]=l,z[11]=-C*m*Math.sqrt(2/3),debug="atom = "+a+"  i = "+b+"  numatoms = "+A[0].numatoms,debug+="\n"+element(A[A[0].numatoms].atomicnumber,"symbol"),debug+="\nRow 1: "+z[0].toFixed(4)+" "+z[1].toFixed(4),debug+=" "+z[2].toFixed(4)+" "+z[3].toFixed(4),debug+="\nRow 2: "+z[4].toFixed(4)+" "+z[5].toFixed(4),debug+=" "+z[6].toFixed(4)+" "+z[7].toFixed(4),debug+="\nRow 3: "+z[8].toFixed(4)+" "+z[9].toFixed(4),debug+=" "+z[10].toFixed(4)+" "+z[11].toFixed(4),debug+="\nCross: "+j.toFixed(4)+" "+k.toFixed(4)+" "+l.toFixed(4),y=gaussElim(z),n=t+y[0],o=u+y[1],p=v+y[2],addAtom(1,n,o,p),addBond(a,A[0].numatoms)))}function gaussElim(a){var b,c,d,e,f=new Array,g=parseFloat(a[0]),h=parseFloat(a[1]),i=parseFloat(a[2]),j=parseFloat(a[3]),k=parseFloat(a[4]),l=parseFloat(a[5]),m=parseFloat(a[6]),n=parseFloat(a[7]),o=parseFloat(a[8]),p=parseFloat(a[9]),q=parseFloat(a[10]),r=parseFloat(a[11]);return Math.abs(k)>Math.abs(g)&&Math.abs(k)>Math.abs(o)&&(b=g,c=h,d=i,e=j,g=k,h=l,i=m,j=n,k=b,l=c,m=d,n=e),Math.abs(o)>Math.abs(g)&&Math.abs(o)>Math.abs(k)&&(b=g,c=h,d=i,e=j,g=o,h=p,i=q,j=r,o=b,p=c,q=d,r=e),Math.abs(o)>Math.abs(k)&&(b=k,c=l,d=m,e=n,k=o,l=p,m=q,n=r,o=b,p=c,q=d,r=e),0!=g&&0!=k&&(factor=-g/k,k=0,l=l*factor+h,m=m*factor+i,n=n*factor+j),0!=g&&0!=o&&(factor=-g/o,o=0,p=p*factor+h,q=q*factor+i,r=r*factor+j),Math.abs(p)>Math.abs(l)&&(c=l,d=m,e=n,l=p,m=q,n=r,p=c,q=d,r=e),0!=l&&0!=p&&(factor=-l/p,p=0,q=q*factor+m,r=r*factor+n),f[2]=0,0!=q&&(f[2]=r/q),f[1]=0,0!=l&&(f[1]=(n-m*f[2])/l),f[0]=0,0!=g&&(f[0]=(j-i*f[2]-h*f[1])/g),f}function mechanics(){var a,b,c,d,e,f,g=new Array,h=new Array,i=Mol(),j=activeWin(""),k=$(j),l=k.getContext("2d"),m=k.width,n=.2,o=500,p=2e-7;if(Undo("save"),InfoWin("Simple Geometry Optimization starting\n",1),geomLabel(l,"Simple Geometry Optimization started",m),g=hybridization(),f=0,f>0)for(InfoWin("Hybridization\n"),a=1;a<=i[0].numatoms;a++)b=i[a].atomicnumber,InfoWin(element(b,"symbol")+" has "+g[a].hybrid+" hybrid orbitals\n");for(d=mechEnergy(g),g[0].energy=d,g[0].step=n,h[0]=new energyObject,h[0].energy=g[0].energy,h[0].step=g[0].step,a=1;a<=i[0].numatoms;a++)h[a]=new mechanicsObject,h[a].hybrid=g[a].hybrid,h[a].x=g[a].x,h[a].y=g[a].y,h[a].z=g[a].z;for(c=0,e=2*p,InfoWin("0: Energy = "+d.toFixed(8)+"\n");o>c&&e>p;){for(h=optimize(g),e=Math.abs(g[0].energy-h[0].energy),h[0].step>n&&(h[0].step=n),g[0].energy=h[0].energy,g[0].step=h[0].step,a=1;a<=i[0].numatoms;a++)g[a].hybrid=h[a].hybrid,g[a].x=h[a].x,g[a].y=h[a].y,g[a].z=h[a].z;if(c++,3>c&&p>e&&(e=2*p),p>e&&h[0].step<n&&(g[0].step*=1.5,h=optimize(g),e=Math.abs(g[0].energy-h[0].energy),e>p))for(g[0].energy=h[0].energy,g[0].step=h[0].step,a=1;a<=i[0].numatoms;a++)g[a].hybrid=h[a].hybrid,g[a].x=h[a].x,g[a].y=h[a].y,g[a].z=h[a].z;if(InfoWin(c+": Energy = "+h[0].energy.toFixed(8)+"\n"),f=1,f>0&&0==c%5){for(a=1;a<=i[0].numatoms;a++)i[a].x=h[a].x,i[a].y=h[a].y,i[a].z=h[a].z;centerMolecule(),drawMolecule(),geomLabel(l,"Simple Geometry Optimization in progress.",m)}}for(InfoWin("Final Energy at loop "+c+" = "+h[0].energy.toFixed(8)+"\n"),InfoWin("Geometry Optimization complete.\n"),c>=o&&InfoWin("Too many steps. Optimization may not be complete.\n"),a=1;a<=i[0].numatoms;a++)i[a].x=h[a].x,i[a].y=h[a].y,i[a].z=h[a].z;centerMolecule(),drawMolecule()}function mechanicsObject(){this.hybrid=0,this.x=0,this.y=0,this.z=0}function energyObject(){this.energy=0,this.rstep=0,this.astep=0}function distance(a,b,c){var d=a[b].x-a[c].x,e=a[b].y-a[c].y,f=a[b].z-a[c].z,g=Math.sqrt(d*d+e*e+f*f);return g}function angle(a,b,c,d){var e=a[b].x-a[c].x,f=a[b].y-a[c].y,g=a[b].z-a[c].z,h=Math.sqrt(e*e+f*f+g*g),i=a[d].x-a[c].x,j=a[d].y-a[c].y,k=a[d].z-a[c].z,l=Math.sqrt(i*i+j*j+k*k),m=(e*i+f*j+g*k)/(h*l);return m>1&&(m=1),-1>m&&(m=-1),m=180*Math.acos(m)/Math.PI}function dihedral(a,b,c,d,e){var f,g,h,i,j=a[b].x-a[c].x,k=a[b].y-a[c].y,l=a[b].z-a[c].z,m=a[d].x-a[c].x,n=a[d].y-a[c].y,o=a[d].z-a[c].z,p=k*o-l*n,q=l*m-j*o,r=j*n-k*m,s=Math.sqrt(p*p+q*q+r*r);return j=a[e].x-a[d].x,k=a[e].y-a[d].y,l=a[e].z-a[d].z,g=l*n-k*o,h=j*o-l*m,i=k*m-j*n,f=Math.sqrt(g*g+h*h+i*i),ang=(-p*g-q*h-r*i)/(s*f),ang>1&&(ang=1),-1>ang&&(ang=-1),ang=180*Math.acos(ang)/Math.PI}function hybridization(){var a,b,c,d,e=new Array,f=Mol(),g=BondMatrix();for(e[0]=new energyObject,e[0].energy=0,e[0].step=0,a=1;a<=f[0].numatoms;a++)e[a]=new mechanicsObject,e[a].hybrid=0,e[a].x=f[a].x,e[a].y=f[a].y,e[a].z=f[a].z;for(a=1;a<=f[0].numatoms;a++){switch(d=element(f[a].atomicnumber,"valence")){case 1:case 2:case 3:e[a].hybrid=g[a][0];break;default:e[a].hybrid=d+g[a][0]-4}for(;e[a].hybrid>g[a][0]&&e[a].hybrid>=5;)e[a].hybrid=e[a].hybrid-1}for(a=1;a<=f[0].numatoms;a++)if(4==e[a].hybrid&&g[a][0]<4)for(b=1;b<=f[0].numatoms;b++)c=g[a][b],c>0&&3==e[c].hybrid&&(e[a].hybrid=3);return e}function mechEnergy(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C=180*Math.acos(-1/3)/Math.PI,D=0,E=Mol(),F=BondMatrix(),G=2e4,H=10,I=5,J=500;if(DEBUG=1,DEBUG>0){for(B=0,b=1;b<=E[0].numatoms;b++)B+=a[b].hybrid;B<E[0].numatoms&&InfoWin("*** Too few hybrid orbitals ("+B+") returned at end of optimize\n")}for(b=1;b<=E[0].numatoms;b++)for(k=element(E[b].atomicnumber,"radius"),3==a[b].hybrid&&(k-=.05),2==a[b].hybrid&&(k-=.1),c=1;c<=E[0].numatoms;c++)F[b][c]>0&&(d=c,l=element(E[d].atomicnumber,"radius"),3==a[d].hybrid&&(l-=.05),2==a[d].hybrid&&(l-=.1),j=k+l,m=a[b].x-a[d].x,n=a[b].y-a[d].y,o=a[b].z-a[d].z,p=Math.sqrt(m*m+n*n+o*o),D+=G*(p-j)*(p-j));for(b=1;b<=E[0].numatoms;b++)if(a[b].hybrid>1)for(c=1;c<E[0].numatoms;c++)if(F[b][c]>0)for(q=c,t=a[q].x-a[b].x,u=a[q].y-a[b].y,v=a[q].z-a[b].z,s=Math.sqrt(t*t+u*u+v*v),d=c+1;d<=E[0].numatoms;d++)if(F[b][d]>0)switch(r=d,x=a[r].x-a[b].x,y=a[r].y-a[b].y,z=a[r].z-a[b].z,w=Math.sqrt(x*x+y*y+z*z),A=(t*x+u*y+v*z)/(s*w),A>1&&(A=1),-1>A&&(A=-1),A=180*Math.acos(A)/Math.PI,a[b].hybrid){case 2:D+=H*(A-180)*(A-180);break;case 3:D+=H*(A-120)*(A-120);break;case 4:D+=H*(A-C)*(A-C);break;case 5:case 6:100>A&&(D+=H*(A-90)*(A-90))}for(b=1;b<E[0].numatoms;b++)if(4==a[b].hybrid)for(e=b+1;e<=E[0].numatoms;e++)if(F[b][e]>0&&4==a[e].hybrid)for(c=e,f=1;f<=E[0].numatoms;f++)if(F[b][f]>0&&f!=c&&f!=b)for(h=f,g=1;g<=E[c].numatoms;g++)if(F[c][g]>0&&g!=c&&g!=b&&g!=h){for(i=E[c].bonds[g],A=Math.abs(dihedral(a,h,b,c,i));A>120;)A-=120;D+=I*(A-60)*(A-60)}for(b=1;b<E[0].numatoms;b++)if(3==a[b].hybrid)for(e=b+1;e<=E[b].numatoms;e++)if(F[b][e]>0&&3==a[c].hybrid)for(c=e,f=1;f<=E[b].numatoms;f++)if(F[b][f]>0&&f!=c&&f!=b)for(h=f,g=1;g<=E[c].numatoms;g++)F[c][g]>0&&g!=b&&g!=c&&g!=h&&(i=g,A=Math.abs(dihedral(a,h,b,c,i)),A>180&&(A-=180),A>135&&(A=180-A),D+=I*A*A);for(b=1;b<E[0].numatoms;b++)for(k=element(E[b].atomicnumber,"radius"),c=b+1;c<=E[0].numatoms;c++)l=element(E[c].atomicnumber,"radius"),p=distance(a,b,c),.1>p&&(p=.1),p/=k+l,D+=J/(p*p*p*p*p*p);return D}function changexyz(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p=Mol(),q=[],r=a[0].step,s=0;if(s>0)for(InfoWin("Hybridization\n"),b=1;b<=p[0].numatoms;b++)Z=p[b].atomicnumber,InfoWin(element(Z,"symbol")+" has "+a[b].hybrid+" hybrid orbitals\n");for(b=0;b<=p[0].numatoms;b++)q[b]=[0,0,0];for(o=new Array,o[0]=new energyObject,o[0].energy=a[0].energy,o[0].step=a[0].step,b=1;b<=p[0].numatoms;b++)o[b]=new mechanicsObject,o[b].hybrid=a[b].hybrid,o[b].x=a[b].x,o[b].y=a[b].y,o[b].z=a[b].z;for(d=mechEnergy(o),b=1;b<=p[0].numatoms;b++)for(l=o[b].x,m=o[b].y,n=o[b].z,c=0;6>c;c++)switch(h=0,i=0,j=0,e=d,f=d,g=d,k=c%2?1:-1,c){case 0:case 1:for(o[b].x=l+k*r,Energy=mechEnergy(o);Energy>d&&k>.1;)k*=.75,o[b].x=l+k*r,Energy=mechEnergy(o);e>Energy&&(h=k),o[b].x=l,q[b][0]=h*r;break;case 2:case 3:for(o[b].y=m+k*r,Energy=mechEnergy(o);Energy>d&&k>.1;)k*=.75,o[b].y=m+k*r,Energy=mechEnergy(o);f>Energy&&(i=k),o[b].y=m,q[b][1]=i*r;break;case 4:case 5:for(o[b].z=n+k*r,Energy=mechEnergy(o);Energy>d&&k>.1;)k*=.75,o[b].z=n+k*r,Energy=mechEnergy(o);g>Energy&&(j=k),o[b].z=n,q[b][2]=j*r}return q}function optimize(a){var b,c,d,e,f,g,h,i,j,k,l,m=new Array,n=new Array,o=Mol(),p=.001;if(a[0].step,j=a[0].energy,DEBUG=1,DEBUG>0){for(k=mechEnergy(a),k!=j&&InfoWin("*** Call to mechEnergy changed energy from "+j+" to "+k+"\n"),l=0,b=1;b<=o[0].numatoms;b++)l+=a[b].hybrid;l<o[0].numatoms&&InfoWin("*** Too few hybrid orbitals ("+l+")\n")}for(b=0;b<=o[0].numatoms;b++)m[b]=[0,0,0];for(m=changexyz(a),i=0,b=0;b<=o[0].numatoms;b++)for(c=0;3>c;c++)Math.abs(m[b][c])>i&&(i=Math.abs(m[b][c]));for(f=a[0].energy,g=0,h=1,e=trialEnergy(a,m,h);e>f&&h>.002;)h*=.75,e=trialEnergy(a,m,h);for(f>e&&(g=h,f=e),d=(g+.5)*(a[0].step+i),p>d&&(d=p),n[0]=new energyObject,n[0].energy=f,n[0].step=d,b=1;b<=o[0].numatoms;b++)n[b]=new mechanicsObject,n[b].hybrid=a[b].hybrid,n[b].x=a[b].x+g*m[b][0],n[b].y=a[b].y+g*m[b][1],n[b].z=a[b].z+g*m[b][2];if(DEBUG=0,DEBUG>0){for(b=0;b<=o[0].numatoms;b++){for(InfoWin("Change in coordinates = ("),c=0;3>c;c++)InfoWin(m[b][c].toFixed(5)),2>c&&InfoWin(", ");InfoWin(")\n")}InfoWin("--- Max change = "+i.toFixed(5)+"\n")}return n}function trialEnergy(a,b,c){var d,e=new Array,f=Mol();for(e[0]=new energyObject,e[0].energy=a[0].energy,e[0].step=a[0].step,d=1;d<=f[0].numatoms;d++)e[d]=new mechanicsObject,e[d].hybrid=a[d].hybrid,e[d].x=a[d].x+c*b[d][0],e[d].y=a[d].y+c*b[d][1],e[d].z=a[d].z+c*b[d][2];return mechEnergy(e)}var atpTip=[],atpLab=[],atpNum=[],atpMas=[],atpChg=[],atpAtm=[],atpSgm=[],atpEps=[],bonPar=[],cstPar=[],angPar=[],dihPar=[],keyOPLS=[],$=function(a){return document.getElementById(a)};