---
 layout: post
 title: GROMACS力场拓扑文件的说明以及创建方法
 categories:
 - 科
 tags:
 - GMX
---

<script src="/jscss/ChemDoodleWeb.js"></script>

## 力场的概念及其分类

力场(Force Field, 常简写为FF)这个物理学名词听起来有点高深, 可如果理解了它的含义你就会觉得这是很自然的一个概念, 没有什么特别之处.

在中学物理或者初等力学中, 研究物体的运动都是从分析其受力出发的, 可以说是以力为基础, 这也是称为力学的原因. 牛顿第二定律直接将物体的受力与其加速度联系起来, 这样只要知道了物体的受力情况, 就能计算出其运动轨迹. 在力学中, 一般将力作为一个基本物理量, 不讨论物体之间的相互作用力来自哪里, 其本质是什么. 但对于重力和电场力, 却讲到了它们的来源. 实际上人们就是在研究这两种力的时候引入了场的概念. 重力, 就是物体在重力场中所受的力, 或更宽泛一点说, 是在引力场中由于物体存在静质量而受到的力; 而电场力, 则是在电场中的物体由于存在净电荷而受到的力. 以这种观点看来, 任何相互作用力都可以引入一个相应的力场来说明其来源, 或者说, 任何相互作用都可以使用相应的场来描述.

那如何描述场呢? 使用能量. 因为力实际上可以认为是能量的梯度(也就是导数), 就像重力是重力势能的梯度, 电场力是电势能的梯度一样. 与使用力进行描述比较起来, 使用能量描述还有一个优点, 简单. 因为能量是标量, 对空间的每点只需要使用一个值进行描述, 而力是矢量, 在空间的每点都要使用三个分量值进行描述. 量子化学中的密度泛函方式比波函数方式更简单, 也与此类似, 可对照思考.

从能量出发, 而不是从力出发, 这是现代物理学的通用做法. 无论研究什么体系, 尺度多大, 其基础都是得到体系的能量函数. 如果能够写出体系的能量函数, 再知道其演化方程, 理论上就相当于知道了体系的一切性质, 大到宇宙星系, 小到微观粒子, 都是如此. 体系的能量函数在物理学中也称为体系的哈密顿量(Hamiltonian). 如果学过一点分析力学或是量子力学, 就容易理解这种思路了. 在这些学科中, 分析问题时首先要写出体系的哈密顿量, 然后根据它遵循的方程求解体系的运动, 只不过经典力学中使用哈密顿方程(它是推广的牛顿运动方程), 而量子力学中则使用薛定谔方程(或狄拉克方程).

以能量为出发点的物理学, 或许可以称为能学, 以便与力学对应. 历史上的唯能论就持这种观点, 只不过太极端了一些, 认为所有一切都可认为是能量. 相对论的质能方程倒是有点支持这种观点的意味.

从宏观深入到微观, 相互作用(能)的概念更成为主流, 因为在这些领域中你很难像在宏观领域中那样, 直接给出分子的具体受力情况, 而只能根据基本的物理学原理推测分子之间的相互作用. 我们可以将描述微观分子相互作用的场称为分子力场. 它是力场的一种, 和重力场, 电场的概念没有本质区别, 只不过比这两个场更复杂, 因为分子之间的相互作用更复杂.

如果知道了分子力场以及分子运动遵循的方程, 便可以求解分子的运动轨迹, 这就是分子动力学的实质. 根据所用力场和运行方程的不同, 分子动力学可分为不同的层次:

- 量子分子动力学: 使用量子力学描述分子力场, 假定分子运动遵循薛定谔方程
- 从头算或第一性原理分子动力学: 使用量子力学描述分子力场, 假定分子运动遵循牛顿方程
- 经典分子动力学: 使用经典的势能函数, 库仑作用, 范德华作用描述分子力场, 假定分子运算遵循牛顿方程. 这是狭义的分子动力学, 通常说分子动力学时所指的一般就是这种.

要描述分子之间的相互作用, 经典的分子力场必须包含两个方面的内容:

1. 描述分子之间相互作用的势能函数

	如果要将分子中的原子抽象成经典粒子, 并给出合适的势能函数, 一般是将化学键近似为力学中的弹簧, 这样对键合作用就可以采用键, 键角, 二面角来描述. 由于原子并不一定是中性的, 所以也需要考虑原子之间的静电能. 根据量子力学的色散作用和泡利原理, 原子之间还存在一定的吸引作用和排斥作用, 所以还需要使用范德华势能函数来描述这些相互作用. 虽然基本的相互作用类型都差不多, 但用于描述相互作用的势能函数可采用各种不同形式, 不同类型的力场采用的函数形式可能很不相同.

2. 势能函数的参数

	即便采用相同的势能函数形式, 这些函数中的参数也可能不一样, 这样的力场也是不同的, 虽然它们之间的区别比要比上面的小些.

一般来说, 一个力场的势能函数形式是和参数一起的, 所以最好不要在同一个体系中使用不同力场的参数. 更具体的讲, 同一个原子在一个力场中的电荷与其在第二个力场中的电荷是不一样的, 其他键合参数也是一样. 一般来讲, 最好不要修改力场中某个特定原子的参数, 因为各个原子之间的参数可能是互相依赖的. 但是, 上面的做法并不是一定不行, 相反的, 为了模拟一些不常见的分子, 经常需要根据已有的参数(力场已有的, 来自论文的)来构建新的参数. 大体的原则是, 如果原力场中已经含有需要的参数, 就尽量使用.

根据对分子抽象程度的不同, 经典的分子力场一般可分为三种类型:

- 全原子力场: 考虑分子中的所有原子, 并定义其参数, 如OPLS-AA, AMBER, CHARMM这些力场
- 联合原子力场: 忽略分子中的一些原子(如非极性的氢原子), 将相互作用整合到与其成键的相邻原子上. 比如由于甲基在模拟中近似不变, 可使用一个基团来代表. GROMOS力场就属于这种类型.
- 粗粒化力场: 进一步抽象分子结构, 将更大的基团视为一个珠子(或称颗粒). 比如可将蛋白侧链看作一个珠子, 甚至将整个氨基酸残基当作一个珠子的力场. Martini力场是常用的一种粗粒化力场.

显然, 抽象程度越高, 计算越快, 能处理的体系也越大. 比粗粒化抽象程度更高一些的, 就接近经典的连续模型了. 利用不同抽象程度的力场来描述体系, 对关键区域使用量子力学, 关键区域周围的区域使用经典分子力场, 更远的范围使用连续模型, 这样就可以处理非常大的体系, 这种做法常被称为多尺度模拟.

## 如何发展力场

待补充, 暂且先将王喜军对问题[范德华相互作用参数获得](http://emuch.net/bbs/viewthread.php?tid=3285163&fpage=75)的回答放在这里

__想请教大家一下，如何运用势能面扫描获得范德华相互作用参数，还是用其他的什么办法可以获得？__


>扫描势能面，然后用范德华作用能表达式拟合这个势能面，即不断改变势阱参数和半径参数，直到两势能面差距的平方和最小，即可得到最佳范德华作用参数。不过前提是你需要先得到电荷参数，因为静电作用对势能面有很大贡献呢，要大于范德华作用。
>
>遗憾的是，这样得到的参数，并不能用于分子模拟。因为你的势能面一般是在气相中优化得到的，缺少多体效应。在凝聚态中，由于诱导，极化等效应，体现为介电常数不同，故而其势能面与在气相中有很大差别。电荷也不同，自然范德华参数也就难以精确获取。

>那么我们用的范德华参数从哪里来的呢？是Jorgensen他老人家用以下方法得到的：
>
>选定初始参数，做分子模拟，然后看模拟结果和实验值的差别，然后调整参数，继续模拟，直到达到收敛标准。说起来简单，其实很难。参数很多，实验值有限，这是一个约束数量少于未知数的线性方程组，是一个多解问题。所以要加上很多经验修正。特别是需要先固定一些参数，如C, H的电荷和范德华参数。并根据化学性质区分不同的原子类型，然后给不同的原子类型以不同的参数。
>
>所以，不存在单独的“范德华相互作用参数”，因为它是分子力学力场的一个部分。要做一个力场，你就必须先确定分子力学模型：要不要极化，要不要氢键；然后选定势函数模型：键参数咋搞，非键咋搞；然后确定原子类型划分标准，然后确定参数化流程和实验值拟合收敛标准（e.g. &#lt;5%），然后开始搞。。。

## GROMACS所带的力场

安装后, GROMACS自带的力场文件放于`GROMACS主目录/share/gromacs/top`(对安装文件放于`GROMACS主目录/share/top`). 以GROMACS 5.1.1安装文件为例, 打开这个目录, 可以看到文件夹下有许多以`.ff`结尾的目录, 那就是各个力场的目录.

![](/pic/GMX_ff.png)

GROMACS自带了四类力场: AMBER, CHARMM, GROMOS, OPLS-AA, 其中的AMBER和GROMOS还有不同的版本. 以`amber99sb-ildn.ff`为例, 进入这个目录, 可以看到这个力场包含的所有文件:

![](/pic/GMX_amber.png)

在上面的图中, 我对每个文件进行了简单的注释说明, 以帮助大家理解.

其他力场目录的结构与此类似, 只不过文件有些不同, 比如GROMOS力场

![](/pic/GMX_gromos.png)

以及OPLS-AA力场

![](/pic/GMX_oplsaa.png)

## 拓扑文件说明

下面我们以几个具体的分子为例讲解下GROMACS拓扑文件的结构. 待补充

有关不同力场中决定参数的具体说明, 请参考Sobereva的博文[gromacs决定力场参数的方式](http://sobereva.com/4).

### AMBER力场拓扑文件

`..\gromacs-5.1.1\share\top\amber99sb-ildn.ff\urea.itp`

### GROMOS力场拓扑文件

`..\gromacs-5.1.1\share\top\gromos54a7.ff\dppc.itp`

### OPLS-AA力场拓扑文件

`..\gromacs-5.1.1\share\top\oplsaa.ff\methanol.itp`

## 创建分子的拓扑文件: 理论考虑

在利用GROMACS模拟一些不常见的分子时, 首先要解决的一个问题就是如何得到分子的拓扑文件. 对于没有力场参数的分子, 这是一个难点. 只有理解了力场的概念, 明白了拓扑文件的结构, 清楚处理过程中每步的含义, 才不至于被网上众多的教程和工具弄糊涂.

理论上说, 对每种分子我们都要发展一种特定的, 适用于这种分子的力场. 但发展力场并不简单, 也不是每个人都可以做好的, 因此在目前这种想法还不现实. 但随着理论与工具的成熟, 在可见的将来, 我认为可以实现这一点. 这就像量子化学计算一样, 开始时只有一些专业人士才能使用, 但现在已经基本普及了, 任何人都可以拿来算算. 将来的力场也必然是这样, 你无论做什么体系, 都可以自己先做一个合适的力场出来, 然后再去跑分子动力学模拟.

本质上说, 无论哪个力场, 包含再多的原子类型, 都不可能描述所有可能的分子, 因为分子的数目, 连接方式几乎是无穷的. 在发展一种力场时, 最先要做的就是要确定力场所用的原子类型. 原子类型越多, 对分子的描述就越准确, 也越能用于更多种类的分子. 举个例子, OPLS-AA力场原子类型最多, 所以它能处理的分子类型远远多于AMBER等生物分子力场.

对蛋白质和核酸来说, 其基本构建单元的数目有限, 氨基酸残基20种, 核苷酸5种, 所以在生物分子力场中甚至可以把每种原子的力场参数都列出来, 放在力场文件中, 这样对任意一个给定的残基序列或DNA序列, 都可以快速地从文件中找到相应的力场参数, 完成拓扑文件的创建. 这就是GROMACS的`pdb2gmx`模块所做的工作. 因此, `pdb2gmx`这种工具只适用于生物分子, 蛋白质, DNA, RNA等, 而不能用于有机分子(如各种配体)和周期性体系(如无机材料, 聚合物).

对于有机分子来说, 不存在基本构建单元, 原子类型数目几乎是无限的, 所以不可能采用生物力场的的处理方式, 而是要采用一些近似, 把近似相同的原子基团当作基本的原子类型. 比如, 乙烷中的甲基原子, 乙醇中的甲基碳原子, 甲醇中的甲基碳原子, 这三种碳原子理论来说不可能完全相同, 但可以粗略地认为相同, 指定为同样的原子类型, 这就是OPLS-AA等力场采用的做法. 这些力场根据各种分子结构划分出很多基本原子类型, 希望能够利用这些原子类型来描述所有可能的有机分子. 这当然存在问题, 因为总有一些特殊的分子结构还没有被包含在力场的原子类型中.

明白了上面的道理, 我们就可以手动创建分子的拓扑文件了. 怎么做呢? 很简单, 画出分子结构, 对照所选力场的原子类型表, 确定分子中每个原子(或原子基团)的原子类型, 然后根据原子类型及其相互作用参数写出拓扑文件. 当然, 在这过程中分子中的某些原子可能无法在所选力场中找到对应的原子类型, 那么就只能退而求其次, 选择一个(你认为或源于参考文献上)最接近的, 就可以了. 手动操作, 对含10几个原子的小分子还可以, 对包含更多原子的分子, 手动做起来就很耗时了, 也很麻烦, 还容易出错. 所以就有人写了一些程序或脚本来自动处理这个的问题, 但采用的方法是一样的, 就是先根据分子结构找到匹配的原子类型, 然后将相应的相互作用参数写为拓扑文件. PRODRG, ATB等程序或网站的处理过程就是这样. 由于是使用程序自动处理, 所以不可能像自己手动处理那样准确, 所以在得到这些程序给出的拓扑文件后, 自己一定要核查一下, 看是否存在错误. 另外有些程序无法给出原子类型对应的电荷, 这也需要单独处理.

上面的方法也适用于周期性体系或是聚合物体系, 但由于这些体系是由一些基本单元重复而成的, 如果扩展到大的体系后, 还使用上面的方法就显得麻烦了, 况且还有周期性的问题, 很多程序无法处理. 为此, GROMACS提供了`x2top`模块, 它可以根据提供的构型文件, 设定的键长条件, 计算所有可能的键, 键角, 二面角, 并输出一个初步的拓扑文件, 将它加以修改, 加入自己需要的参数就能做成一个可以使用的拓扑文件了. 因此, `x2top`只用于创建初步的拓扑文件, 所用的力场和参数需要你自己处理, 不要直接使用它给出的拓扑文件去做模拟.

这些辅助工具可以根据输入构型自动判断原子类型以及成键方式, 虽然很不错, 但却不能保证一定能找到最匹配的原子类型, 况且还有许多原子类型之间的键合参数缺失, 这时就需要我们自己根据情况来补充了. 我个人觉得, 可以参考构建分子的方式, 采用图形化的方式, 手动选择原子类型来创建分子, 这样既方便, 同时也能避免无法找到合适原子类型的问题. 可惜的是, 至今我还没有看到这样的软件. 有可能的话, 或许可以自己开发一个.

实际上, 各种创建拓扑文件的网站或是程序都只是起着辅助作用, 得到拓扑文件后, 在做模拟之前一定要检查一下.

下面是创建分子拓扑文件时要考虑的几点:

1. 对同一模拟体系中的不同分子, 尽量使用同一力场, 这样自洽性好. 比如, 如果对蛋白质, 核酸等生物大分子使用AMBER力场, 那么相应的配体小分子, 建议使用与此对应的GAFF力场. 这也是AMBER程序鼓励的作法.
2. 对一般有机分子溶液体系的模拟, 建议使用全原子的OPLS-AA力场, 这是专门针对有机溶液体系优化的力场, 原子类型最多, 实用性很强. 如果你想使用联合原子力场, 那么你可以试试GROMOS力场.

## 创建分子的拓扑文件: 各种工具

参考Sobereva的博文[几种生成有机分子Gromacs拓扑文件的工具](http://sobereva.com/266).

使用时需要先清楚每种工具给出的是什么力场的拓扑文件, 这样才能选择合适的程序.

<table><caption>生成GROMACS拓扑文件的各种工具</caption>
<tr>
<th style="text-align:center;"> 力场     </th>
<th style="text-align:center;">工具</th>
<th style="text-align:center;">说明</th>
</tr>
<tr>
<td rowspan="3" style="text-align:center;">AMBER GAFF   </td>
<td style="text-align:center;">AmberTools+ACPYPE</td>
<td style="text-align:left;">推荐的标准做法</td>
</tr>
<tr>
<td style="text-align:center;">MKTOP</td>
<td style="text-align:left;">简单脚本, 需要提供电荷</td>
</tr>
<tr>
<td style="text-align:center;">amb2gmx</td>
<td style="text-align:left;">已废弃, 功能完全由acpype取代</td>
</tr>
<tr>
<td rowspan="2" style="text-align:center;">CHARMM       </td>
<td style="text-align:center;">SwissParam</td>
<td style="text-align:left;">待考</td>
</tr>
<tr>
<td style="text-align:center;">CGenFF</td>
<td style="text-align:left;">待考</td>
</tr>
<tr>
<td rowspan="2" style="text-align:center;">GROMOS       </td>
<td style="text-align:center;">PRODRG</td>
<td style="text-align:left;">经典工具, 输出文件需要检查</td>
</tr>
<tr>
<td style="text-align:center;">ATB</td>
<td style="text-align:left;">可能更好, 输出文件仍需检查</td>
</tr>
<tr>
<td rowspan="4" style="text-align:center;">OPLS-AA      </td>
<td style="text-align:center;">tppmktop</td>
<td style="text-align:left;">目前最好</td>
</tr>
<tr>
<td style="text-align:center;">MKTOP</td>
<td style="text-align:left;">简单脚本, 需要提供电荷</td>
</tr>
<tr>
<td style="text-align:center;">Topolbuild</td>
<td style="text-align:left;">功能简陋, 不建议使用</td>
</tr>
<tr>
<td style="text-align:center;">Topolgen</td>
<td style="text-align:left;">功能简陋, 不建议使用</td>
</tr>
<tr>
<td style="text-align:center;">UFF          </td>
<td style="text-align:center;">OBGMX</td>
<td style="text-align:left;">近似UFF力场, 可作参考</td>
</tr>
<tr>
<td style="text-align:center;">生物分子力场 </td>
<td style="text-align:center;">pdb2gmx</td>
<td style="text-align:left;">通用工具, 只用于蛋白质, DNA, RNA的生物分子</td>
</tr>
<tr>
<td style="text-align:center;">所有力场     </td>
<td style="text-align:center;">x2top</td>
<td style="text-align:left;">通用工具, 一般用于周期性体系, 聚合物等, 只给出初步拓扑文件</td>
</tr>
</table>

## 创建分子的拓扑文件: 实例教程

### 使用AmberTools+ACPYPE+Gaussian创建小分子GAFF力场的拓扑文件

使用AMBER的GAFF力场处理有机小分子有很大的优势, 可惜的是GROMACS没有自带GAFF力场, 所以需要组合使用各种软件组合来实现. 这里我们使用的是AmberTools和ACPYPE.

要想使用AmberTools和ACPYPE创建小分子的GAFF力场, 需要先安装这两个工具. 但Windows下AmberTools的安装并不容易. 在这里我提供一个已经编译好的AmberTools+ACPYPE, 它来自Chimera中所带的amber14, 并增加了我自己编译好的RESP程序与ACPYPE程序, 因为Chimera中并没有包含这两个程序.

点击[这里](/Prog/amber4.zip)下载AmberTools+ACPYPE, 下载后解压到某一目录(路径中不要包含中文字符), 然后新建环境变量`AMBERHOME`并将其设置为amber14的路径即可. 

![](/pic/GMX_amberhome.png)

具体操作如下:

右键`我的电脑`->`属性`->`高级`->`环境变量`

在用户变量中新建`AMBERHOME`, 并其值设为amber14的路径, 如`C:/amber14`. __注意, 要使用`/`作为路径分格符__.

如果你想在任意目录下都可以使用这些工具, 可以在用户变量中新建`Path`变量(如果存在就选中编辑它), 将其值设为`%Path%; C:\amber14\bin`(如果已存在`Path`变量, 只要增加`C:\amber14\bin`即可).

如果你要使用Python版本的ACPYPE, 而不是(或不能)使用我编译好的二进制版本, 到[Python官方网站](https://www.python.org/downloads/)下载Python 2.x安装即可.

对电荷的处理, 目前有两种比较合理的方法, AM1-bcc电荷与RESP电荷. AM1-bcc电荷可以使用AmberTools中的antechamber程序直接得到(或使用Chimera软件, 它集成了antechamber). RESP电荷则需借助第三方量子化学程序来得到, 如Gaussian, GAMESS等. 因此, 如果你想使用RESP电荷, 那你还需要安装一种量子化学程序. 由于Gaussian使用方便, 所以使用更广泛些. Windows版本的Gaussian及其自带的GaussView界面安装很容易, 网上资料也很多, 这里不做介绍.

使用AmberTools+ACPYPE+Gaussian创建小分子GAFF力场拓扑文件的整个流程如下:


![](/pic/GMX_proc.png)

创建过程的大致步骤是先利用Gaussian得到RESP电荷, 然后利用AmberTools得到AMBER的参数文件. 由于GROMACS和AMBER参数文件的格式很不一样，所以最后需要使用ACPYPE将AMBER参数文件转换为GROMACS可识别的.gro和.top文件. 具体步骤说明如下:

#### 1. 使用`GaussView`创建分子构型并做初步优化

使用熟悉的分子编辑软件创建分子构型. 可用的软件非常多, 一般只要支持输出为.pdb或.mol2格式即可. GaussView, Chimera, Chem3D, VMD等等都可以. 由于我们需要使用Gaussian计算静电势以用于拟合RESP电荷, 所以使用与Gaussian配套的GaussView来构建分子并准备输入文件更方便些. 因此, 如果你对分子编辑软件还没有形成什么偏好的话, 那我推荐你试一试GaussView.

我这里使用的Gaussian 09 C.01版本, 建议你至少使用这个版本, 或使用更新的D.01版, 不要使用更低的版本, 因为下面的有些操作更低的版本不支持. 详细信息见参考资料中的博文.

构建好分子之后, 一般要做下粗略的优化, 使搭建出来的分子构型看起来更合理一些. 这在GaussView中很容易完成, 只要点击`Edit` -> `Clean`就可以了.

__注意, Gaussian以及GaussView的安装路径中不能含有中文, 输入输出文件的保存路径中也不能使用中文__

下面就是我们构建出来的分子结构

<figure><script>var Mol=new ChemDoodle.MovieCanvas3D('Mol-1', 650,400);Mol.specs.set3DRepresentation('Ball and Stick');Mol.specs.projectionPerspective_3D = false;Mol.specs.backgroundColor='black';Mol.specs.crystals_unitCellLineWidth = 1.5;Mol.specs.proteins_ribbonCartoonize = true;
Mol.addFrame([ChemDoodle.readXYZ(' 30\nLig\nC 0.09543850 4.17975179 -3.80964600\nC 0.80175777 5.38903340 -3.80884681\nC 0.51304983 6.37432406 -2.85249130\nC -0.45856117 6.13391634 -1.87580461\nC -1.18031438 4.93159413 -1.88905531\nC -0.90248285 3.95453152 -2.85472308\nH 1.56233451 5.56314689 -4.54229097\nC 1.19956438 7.59276989 -2.90325955\nH -1.94182292 4.75784609 -1.15991385\nH -1.45081509 3.03717093 -2.86078559\nC -0.30345881 8.46335809 -1.24485519\nH -1.73198058 7.12735889 -0.66279753\nCl 0.46333814 2.94533594 -5.00948909\nN -0.74589355 7.12382213 -0.83061474\nO 0.90932293 8.65634024 -1.98723376\nO -0.99787825 9.46470538 -0.92486787\nC 2.46836230 7.66604935 -3.77522994\nC 2.06538526 7.12862117 -1.71684839\nC 2.73839284 6.76831182 -0.79496623\nC 3.60919766 6.31065294 0.39227777\nC 2.95652452 5.50506598 1.52982428\nC 3.98331757 4.83175242 0.58972154\nH 4.30131921 7.08604394 0.65490131\nH 1.93420679 5.20229877 1.46988859\nH 3.23306015 5.67204191 2.55152136\nH 4.96924771 4.59499298 0.93250673\nH 3.67048802 4.12555972 -0.14844314\nF 2.17575489 7.26575804 -5.03005425\nF 3.42083779 6.86041395 -3.25669940\nF 2.92230775 8.93762961 -3.80142482\n')],[]);
Mol.loadMolecule(Mol.frames[0].mols[0]);Mol.startAnimation();</script><br><figurecaption>Fig.1</figurecaption></figure>

#### 2. 使用Gaussian进一步优化分子构型并计算静电势

粗略优化之后, 我们要使用Gaussian进行进一步的优化, 同时计算其静电势, 用于后面拟合RESP电荷. 如果你熟悉Gaussian的计算流程, 可以先保存文件, 然后修改输入文件后在命令行中运行. 如果不熟悉的话, 你可以在GaussView的菜单中操作.

点击`Calculate`->`Gaussian Calculation Setup`, 打开输入文件编译界面

![](/pic/GMX_g09.png)

先将计算类型修改为优化,

![](/pic/GMX_opt.png)

设定优化使用的方法, 基组, 以及体系的电荷, 自旋多重度

![](/pic/GMX_bs.png)

标题段可改可不改

![](/pic/GMX_tit.png)

`Link 0`部分可设定计算时所用的内存和核数. Windows下Gaussian最多可使用1 GB内存, 我的电脑是四核的, 这里我设置使用2个核

![](/pic/GMX_mem.png)

`General`部分设置使用二次收敛的SCF方法以确保收敛, 选择忽略对称性, 不将连接信息写到输入文件中. 其实这些设置影响不大, 不改一般也没事.

![](/pic/GMX_scf.png)

最后, `Add. Inp.`部分添加静电势输出文件的名称, 并在``中添加计算静电势的关键词

![](/pic/GMX_add.png)

点击`Submit..`保存为.gjf文件, 并输出直角坐标和附加输入

![](/pic/GMX_gjf.png)

打开产生的输入文件, 内容如下:

![](/pic/GMX_file.png)

有关输入文件中关键词的解释, 见参考资料中的博文.

__注意, Gaussian输入文件中的空行非常重要, 要严格按图上的格式来. 比如, `Lig_ini.gesp`前面只能有一个空行, 而`Lig.gesp`后面至少要有两个空行.__

得到了输入文件后, 我们就可以使用Gaussian来运行它了. 你可以使用Gaussian自带的用户界面来运行, 也可以使用命令行.

由于这个分子较大, 在我的机器上, 运行了3个多小时才正常结束.

运行正常结束后, 会产生`Lig.chk`, `Lig.out`, `Lig_ini.geps`和`Lig.gesp`等文件, 我们只需要其中的`Lig.gesp`文件, 它是优化后构型的静电势文件, 我们就使用它来拟合RESP电荷.

另外, 我们也可以利用`antechamber`命令来产生运行Gaussian需要的输入文件, 像下面这样

	antechamber -i Lig.mol2 -fi mol2 -o Lig.gjf -fo gcrt -pf y -gm "%mem=1GB" -gn "%nproc=2" -nc 1 -gk "#HF/6-31G* SCF=tight Pop=MK iop(6/33=2,6/42=6,6/50=1)"

#### 3. 使用antechamebr拟合RESP电荷

使用上一步得到的`Lig.gesp`文件, 运行`antechamebr`拟合RESP电荷

	antechamber -i Lig.gesp -fi gesp -o Lig.mol2 -fo mol2 -pf y -c resp

我们只需要`Lig.mol2`输出文件, 它包含了构型以及RESP电荷, 其他文件`ANTECHAMBER*`, `ATOMTYPE.INF` `BCCTYPE.INF` `NEWPDB.PDB` `PREP.INF`等都可删除.

#### 4. 使用parmchk2检查GAFF参数并生成缺失参数文件

使用上一步得到的`Lig.mol2`文件, 运行`parmchk2`命令

	parmchk2 -i Lig.mol2 -f mol2 -o Lig.frcmod

`parmchk2`是原先`parmchk`的增强版, 可以检查输入分子构型中GAFF的缺失参数, 并生成相应的补充参数文件`Lig.frcmod`.

#### 5. 使用sleap生成AMBER参数文件及坐标文件

编写一个`leap.in`文本文件, 内容如下:

	source leaprc.ff14SB
	source leaprc.gaff
	loadamberparams Lig.frcmod
	lig=loadmol2 Lig.mol2
	check lig
	saveamberparm Lig.prmtop Lig.inpcrd
	quit

然后运行`sleap`命令

	sleap -f leap.in

这样就拿到了分子的AMBER参数文件`Lig.prmtop`, 结构文件`Lig.inpcrd`.

也可直接打开`sleap`依次执行`leap.in`文件中的每一行, 只不过麻烦一些.

#### 6. 使用ACPYPE将AMBER文件转换为GROMACS文件

运行`ACPYPE`命令

	acpype -p Lig.prmtop -x Lig.inpcrd -d

这样就得到了GROMACS支持的`Lig_GMX.gro`, `Lig_GMX.top`, `em.mdp`, `md.mdp`等文件. 一般我们只需要前面两个文件.

如果想将.top文件进行处理生成.itp文件，以便在蛋白质的拓扑文件中包含, 可以除去表头, 改动原子类型, 再除去后面的附加信息.

实际上, 上面的3, 4, 5, 6这几个步骤可以使用`ACPYPE`一步完成, 但在Windows下由于路径的原因很容易出问题. 像上面这样分开做的话, 一步一步完成的话, 出错了容易定位具体的出错步骤. 如果你对这个过程很熟悉了, 可以将这些流程写在一个脚本中自动执行, 或是研究一下如何使用acpype一步执行成功.

__参考资料__

- [GMX中如何实现小分子的GAFF立场](http://bioms.org/forum.php?mod=viewthread&tid=52&highlight=GAFF)
- [自动计算ESP和RESP电荷(AMBER and G09)](http://platinhom.github.io/2015/09/17/AutoCalcRESP/)
- [AMBER:小分子处理](http://platinhom.github.io/2015/11/12/AMBER-Ligand/)

### 使用tppmktop创建小分子的OPLS-AA力场拓扑文件

### 使用PRODRG或ATB创建小分子的GROMOS力场拓扑文件

对小分子不建议使用GROMOS力场, 因为其计算电荷的过程不清楚. 但由于PRODRG网站很方便, 这里还是提供一个说明, 并结合Justin的论文说明如何修改.

### 使用x2top并结合已知参数创建具有周期性体系的力场拓扑文件

[]()

### GROMACS使用CHARMM力场参数

